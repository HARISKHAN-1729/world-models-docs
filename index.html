<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HOME - WORLD_MODELS-JOINT-EMBEDDING PREDICTIVE ARCHITECTURES (JEPA)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    
    
    <link href="assets/css/style.css" rel="stylesheet">
    

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        glass: 'rgba(255, 255, 255, 0.03)',
                        neon: '#00f3ff',
                        neonPurple: '#bc13fe',
                    },
                    fontFamily: {
                        // Body font: Rajdhani (Technical/Sci-fi look)
                        sans: ['Rajdhani', 'sans-serif'],
                        // Header font: Orbitron (Futuristic/Bold)
                        mono: ['Orbitron', 'sans-serif'],
                    },
                    typography: (theme) => ({
                        DEFAULT: {
                            css: {
                                color: '#e0e0e0',
                                // Force all headings to use Orbitron, be Bold, and Uppercase
                                'h1, h2, h3, h4': {
                                    fontFamily: 'Orbitron, sans-serif',
                                    fontWeight: '900', // Extra Bold
                                    textTransform: 'uppercase',
                                    letterSpacing: '0.05em',
                                    color: '#ffffff',
                                },
                                h1: { fontSize: '2.5rem' },
                                h2: { color: '#00f3ff' }, // Neon Blue for H2
                                strong: { color: '#00f3ff' }, // Neon Blue for Bold text
                                a: { color: '#bc13fe', textDecoration: 'none' }, // Purple links
                                'a:hover': { color: '#00f3ff' },
                                code: { color: '#00f3ff' },
                                blockquote: { borderLeftColor: '#00f3ff' },
                            }
                        }
                    })
                }
            }
        }
    </script>
</head>
<body class="bg-[#050505] text-[#e0e0e0] font-sans antialiased selection:bg-cyan-500 selection:text-black">

    <div id="canvas-container" class="fixed top-0 left-0 w-full h-full -z-10 opacity-50"></div>

    <nav class="fixed w-full z-50 top-0 left-0 p-6 flex justify-between items-center glass-panel border-b border-white/10 backdrop-blur-md">
        <a href="." class="text-2xl font-black tracking-widest text-white glitch font-mono" data-text="WORLD_MODELS-JOINT-EMBEDDING PREDICTIVE ARCHITECTURES (JEPA)">
            WORLD_MODELS-JOINT-EMBEDDING PREDICTIVE ARCHITECTURES (JEPA)
        </a>
        
        <div class="hidden md:flex gap-8 text-sm font-bold font-mono text-gray-400 tracking-wider">
            
                
                    <a href="." class="hover:text-cyan-400 transition-colors">
                        / HOME
                    </a>
                
            
        </div>
    </nav>

    <main class="relative z-10 container mx-auto px-6 pt-32 pb-20 min-h-screen">
        
        
            <section class="min-h-[50vh] flex flex-col justify-center mb-12">
                <span class="font-mono text-cyan-500 mb-2 block animate-pulse font-bold tracking-widest">> SYSTEM_ONLINE</span>
                <h1 class="text-6xl md:text-8xl font-black text-white mb-6 leading-none font-mono uppercase">
                    World <br>
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-600">Models</span>
                </h1>
                <p class="text-2xl text-gray-300 max-w-2xl font-medium">
                    Exploring Latent Spaces and Generative Agents
                </p>
            </section>
        

        <article class="max-w-5xl mx-auto">
            

            <div class="prose prose-invert prose-lg max-w-none glass-panel p-8 md:p-12 rounded-2xl border border-white/10">
                <h2 id="the-epistemological-crisis-of-generative-ai">The Epistemological Crisis of Generative AI</h2>
<p>The field of artificial intelligence currently finds itself at a critical turning point. The dominant approach,
driven by the enormous success of Large Language Models (LLMs) and systems that generate content
automatically, has produced results that are impressively fluent. These systems can use language with a skill
that appears similar to human reasoning, yet they remain fundamentally disconnected from the physical
reality they claim to describe. This report argues that the current path‚Äîmaking auto-regressive models
larger and larger with more parameters and more data‚Äîis approaching a limit that falls short of true
Autonomous Machine Intelligence (AMI) <a href="#LeC22">[LeC22]</a>.
The main problem with the generative approach lies in how it learns: by predicting the next token (word
piece) or reconstructing the next pixel. This is a mechanism of approximation, not genuine understanding.
When an LLM predicts how a physical object will move, it does not actually simulate the physics of mass and
momentum. Instead, it retrieves a statistical pattern of how humans typically describe such movements in
text. It works in the separate, symbolic world of language, or the complex, noisy world of pixels, rather than
in the continuous, abstract space of underlying reality <a href="#Sha22">[Sha22]</a>. To close the gap between statistical imitation
and real understanding, we must move away from the goal of generation and toward prediction in latent
space. We must build systems that construct an internal World Model‚Äîa simulation of the environment
that captures meaningful cause and effect while filtering out the irrelevant details of sensory noise.
This document serves as both a foundational text and a practical guide for constructing such a system.
It explains the theoretical shift from probabilistic models to Energy-Based Models (EBMs), details the
Joint-Embedding Predictive Architecture (JEPA), and provides a complete, step-by-step methodology for
implementing a Video-JEPA (V-JEPA) using the Moving MNIST dataset as a simplified example of physical
reality.</p>
<h3 id="the-auto-regressive-trap-system-1-without-system-2">The Auto-Regressive Trap: System 1 without System 2</h3>
<p>To understand why we need World Models, we must first identify the problems with current AI systems.
Auto-regressive models, such as the Transformer architectures that power GPT-4 or Llama, work in a way
similar to ‚ÄùSystem 1‚Äù thinking in human psychology‚Äîfast, automatic, and reactive <a href="#Kƒ±25">[Kƒ±25]</a>. They generate
responses one token (word piece) at a time, with each step based only on what came before. This process
is fundamentally unable to plan ahead. Planning requires the ability to imagine multiple possible futures,
evaluate how good each outcome would be, and choose the best path before taking the first action. An
auto-regressive model, by its very nature, commits to an output immediately. It speaks without thinking
first <a href="#Let24">[Let24]</a>.
Additionally, applying this generative approach to visual information‚Äîpredicting the next video frame
pixel by pixel‚Äîis both computationally expensive and conceptually flawed. The world is complex and filled
with random, unpredictable details. The texture of a carpet, the random movement of leaves in the wind,
or the exact reflection of light on water are high-entropy details that are largely unpredictable and often
irrelevant to the actual task. A generative model trained to reconstruct these pixels must use enormous
capacity to model this noise. If it fails to predict the exact texture of a leaf, it receives a high error penalty, even if it correctly predicts where the leaf is generally located. This misalignment of goals forces the model
to focus on small, detailed features at the expense of understanding high-level, meaningful dynamics.Claude
is AI and can make mistakes. Please double-check responses <a href="#Sha22">[Sha22]</a>.</p>
<h3 id="the-biological-counter-proof">The Biological Counter-Proof</h3>
<p>Biological intelligence provides clear evidence that pixel-level prediction is unnecessary for understanding. A
human infant does not learn the physics of the world by predicting the brightness value of every light receptor
in their retina. Instead, the infant observes the world and builds an internal abstraction‚Äîa model‚Äîof object
permanence, gravity, occlusion, and inertia. By the age of a few months, long before learning language, an
infant possesses ‚Äùcommon sense‚Äù physics. They show surprise when an object passes through a solid wall
or when it disappears without explanation. This surprise is the result of a prediction error in their internal
World Model.
This World Model allows biological agents to perform ‚ÄùSystem 2‚Äù thinking: slow, careful reasoning and
planning. It enables an agent to imagine the consequences of its actions without risking physical harm. It
allows for the simulation of ‚Äùwhat if‚Äù scenarios (‚ÄùWhat would happen if I dropped this glass?‚Äù). The goal of
AMI research is to create this capability in artificial systems. We must move from machines that reproduce
the surface appearance of the world to machines that understand the underlying structure of the world.</p>
<h1 id="the-architecture-of-autonomous-machine-intelligence">The Architecture of Autonomous Machine Intelligence</h1>
<p>To replicate the capabilities of biological intelligence, a modular cognitive architecture for AMI was proposed
in <a href="#LeC22">[LeC22]</a>. This architecture is not a single neural network but a system of interacting components, centered
around the World Model. Each module plays a distinct role in the perception-action loop, enabling the agent
to reason, plan, and learn from observation (Figure 1).</p>
<p align="center">
  <img src="img/figures/11.png" width="700">
  <pcaption><em>Figure 1: System architecture for autonomous intelligence with differentiable modules: configurator, perception, world model, cost (intrinsic + critic), short-term memory, and actor.</em></pcaption>
</p>

<h3 id="the-six-core-modules">The Six Core Modules</h3>
<p>The architecture comprises six distinct modules, each differentiable and trainable, allowing gradients to
propagate through the entire system (Table 1).</p>
<table>
<thead>
<tr>
<th style="text-align: left;">üß© <strong>Module</strong></th>
<th style="text-align: left;">‚öôÔ∏è <strong>Function</strong></th>
<th style="text-align: left;">üß¨ <strong>Biological Analogy</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Configurator</strong></td>
<td style="text-align: left;">Acts as the executive controller. Sets goals and dynamically modulates the parameters of other modules based on the current task. Determines <em>what the agent should do</em>.</td>
<td style="text-align: left;"><strong>Prefrontal Cortex</strong> (Executive Function)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Perception</strong></td>
<td style="text-align: left;">Estimates the current world state <code>s‚Çú</code> from sensory input <code>x‚Çú</code>. Filters noise and extracts relevant semantic features.</td>
<td style="text-align: left;"><strong>Sensory Cortex</strong> (Visual / Auditory)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>World Model</strong></td>
<td style="text-align: left;">Internal simulator. Predicts future states <code>s‚Çú‚Çä‚ÇÅ</code> from current states <code>s‚Çú</code> and hypothetical actions <code>a‚Çú</code>. Can infer missing state information.</td>
<td style="text-align: left;"><strong>Hippocampus / Frontal Cortex</strong></td>
</tr>
<tr>
<td style="text-align: left;"><strong>Cost</strong></td>
<td style="text-align: left;">Computes the ‚Äúenergy‚Äù or ‚Äúdiscomfort‚Äù of a state. Combines intrinsic drives (e.g., energy minimization) with extrinsic, task-specific objectives.</td>
<td style="text-align: left;"><strong>Amygdala / Basal Ganglia</strong> (Reward‚ÄìPain System)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Actor</strong></td>
<td style="text-align: left;">Proposes candidate action sequences to minimize predicted future cost. Does not act directly‚Äîfeeds proposals to the World Model for evaluation.</td>
<td style="text-align: left;"><strong>Premotor Cortex</strong></td>
</tr>
<tr>
<td style="text-align: left;"><strong>Short-Term Memory</strong></td>
<td style="text-align: left;">Maintains recent sequences of states, actions, and costs, enabling temporal context for prediction and planning.</td>
<td style="text-align: left;"><strong>Working Memory</strong></td>
</tr>
</tbody>
</table>
<h3 id="the-centrality-of-the-world-model">The Centrality of the World Model</h3>
<p>Among these, the World Model is the most critical and the most challenging to construct. It is the engine
of prediction. The World Model must satisfy two competing requirements:</p>
<ul>
<li><strong>Informativeness:</strong> The state representation must contain enough information to distinguish between functionally different situations (e.g., the difference between a car moving towards you vs. away from you).</li>
<li><strong>Predictability:</strong> The state representation must discard information that is unpredictable or irrelevant (e.g., the exact pattern of clouds in the sky, unless the task is weather forecasting).</li>
</ul>
<p>Standard generative models fail the second requirement by trying to predict everything. Purely invariance-
based models (like contrastive learning) risk failing the first by collapsing distinct states into identical rep-
resentations if the data augmentation views are too aggressive <a href="#Und25">[Und25]</a>. The Joint-Embedding Predictive
Architecture (JEPA) is designed specifically to navigate this trade-off.</p>
<h2 id="theoretical-foundations-from-probability-to-energy">Theoretical Foundations: From Probability to Energy</h2>
<p>The mathematical framework underpinning most current AI is probabilistic modeling. We attempt to estimate <span class="arithmatex">\(P(Y|X)\)</span>, the probability distribution of the output given the input.</p>
<div class="admonition warning">
<p class="admonition-title">The Normalization Constraint</p>
<p>While rigorous, this framework imposes a severe constraint: <strong>the distribution must normalize</strong> (sum to one).</p>
<p>In high-dimensional spaces like video, calculating the normalization constant (the <em>partition function</em>) is intractable. This forces researchers to:</p>
<ol>
<li>Rely on approximations.</li>
<li>Restrict the model to simplified distributions (like Gaussians in VAEs) that do not match the complexity of the real world [LeC].</li>
</ol>
</div>
<h3 id="energy-based-models-ebms">Energy-Based Models (EBMs)</h3>
<p>We advocate for abandoning the probabilistic straitjacket in favor of <strong>Energy-Based Models (EBMs)</strong>.</p>
<p>An EBM does not attempt to model probabilities. Instead, it defines a scalar energy function <span class="arithmatex">\(E(X, Y)\)</span> that measures the "compatibility" between an input <span class="arithmatex">\(X\)</span> and a potential output <span class="arithmatex">\(Y\)</span>.</p>
<div class="admonition success">
<p class="admonition-title">Low Energy (Compatible)</p>
<p>The pair <span class="arithmatex">\((X, Y)\)</span> is compatible. <span class="arithmatex">\(Y\)</span> is a plausible continuation of <span class="arithmatex">\(X\)</span>.</p>
</div>
<div class="admonition failure">
<p class="admonition-title">High Energy (Incompatible)</p>
<p>The pair <span class="arithmatex">\((X, Y)\)</span> is incompatible. <span class="arithmatex">\(Y\)</span> is physically impossible or semantically unrelated to <span class="arithmatex">\(X\)</span>.</p>
</div>
<p>Inference in an EBM becomes an optimization problem: finding the <span class="arithmatex">\(Y\)</span> that minimizes the energy for a given <span class="arithmatex">\(X\)</span>:</p>
<div class="arithmatex">\[
Y^* = \underset{Y}{\mathrm{argmin}} \, E(X, Y)
\]</div>
<p>This framework removes the need for normalization, granting us immense flexibility in designing the architecture of the energy function.</p>
<h3 id="the-collapse-problem-in-self-supervised-learning">The Collapse Problem in Self-Supervised Learning</h3>
<p>The primary challenge in training EBMs, particularly in self-supervised learning (SSL) where we do not have labels, is <strong>Collapse</strong>.</p>
<p>In SSL, we typically have pairs of compatible data points <span class="arithmatex">\((x, y)\)</span>‚Äîfor example, two frames from the same video. We want to train the model such that <span class="arithmatex">\(E(x, y)\)</span> is low.</p>
<h3 id="the-naive-approach">The Naive Approach</h3>
<p>A naive approach would simply minimize the distance between their representations:</p>
<div class="arithmatex">\[
L = \| \text{Enc}(x) - \text{Enc}(y) \|^2 \tag{2}
\]</div>
<div class="admonition danger">
<p class="admonition-title">The Catastrophic Failure Mode</p>
<p>The fatal flaw of this objective is that the encoder learns to map <strong>every input to a constant vector</strong> (e.g., zero).</p>
<div class="arithmatex">\[
\text{Enc}(x) = 0, \quad \text{Enc}(y) = 0 \implies L = 0 \tag{3}
\]</div>
<p>The loss is minimized perfectly, but the representations contain <strong>zero information</strong>. The energy surface becomes completely flat (zero everywhere), making the model useless for discrimination or planning.</p>
</div>
<h3 id="strategies-for-preventing-collapse">Strategies for Preventing Collapse</h3>
<p>To train a useful EBM, we must ensure that the energy is low for compatible pairs (positive samples) and high for incompatible pairs (negative samples). We term this <strong>"shaping the energy landscape."</strong></p>
<p>There are three primary families of techniques to achieve this <a href="#Red25b">[Red25b]</a>:</p>
<h3 id="1-contrastive-methods">1. Contrastive Methods</h3>
<p>Explicitly push up the energy of negative samples. This requires mining "negative" pairs‚Äîinputs that are definitely unrelated.</p>
<ul>
<li><strong>Pros:</strong> Highly effective (e.g., SimCLR).</li>
<li><strong>Cons:</strong> Inefficient because the space of "incorrect" answers is infinite. The model must see a vast number of negatives to define the energy boundary <a href="#Mina">[Mina]</a>.</li>
</ul>
<h3 id="2-regularization-methods">2. Regularization Methods</h3>
<p>Impose constraints on the information content of the embeddings. Methods like <strong>VICReg</strong> (Variance-Invariance-Covariance Regularization) explicitly penalize collapse by adding loss terms:</p>
<ul>
<li><strong>Variance Term:</strong> Forces neurons to vary across the batch (prevents constant output).</li>
<li><strong>Covariance Term:</strong> Forces neurons to capture different features (prevents redundancy).</li>
</ul>
<h3 id="3-architectural-methods-the-jepa-approach">3. Architectural Methods (The JEPA Approach)</h3>
<p>Design the architecture such that the target representation is not fixed but evolves in a way that the predictor cannot easily cheat.</p>
<p>This often involves <strong>asymmetry</strong>, such as using a "Teacher" network that is an Exponential Moving Average (EMA) of the "Student" network. This creates a moving target that prevents the student from converging to a trivial constant solution <a href="#Red25a">[Red25a]</a>.</p>
<h2 id="joint-embedding-predictive-architectures-jepa">Joint-Embedding Predictive Architectures (JEPA)</h2>
<p>The <strong>JEPA</strong> represents the convergence of World Modeling theory and Energy-Based collapse prevention.</p>
<div class="admonition note">
<p class="admonition-title">Non-Generative by Design</p>
<p>JEPA is a <strong>non-generative architecture</strong>: it does not reconstruct <span class="arithmatex">\(x\)</span>. Instead, it predicts the <strong>latent representation</strong> of <span class="arithmatex">\(y\)</span> from the <strong>latent representation</strong> of <span class="arithmatex">\(x\)</span>.</p>
</div>
<h3 id="the-core-mechanism">The Core Mechanism</h3>
<p>The JEPA consists of three primary sub-networks:</p>
<ol>
<li><strong>Context Encoder (Student):</strong> Processes the observed part of the input (the context, <span class="arithmatex">\(x\)</span>) to produce a representation <span class="arithmatex">\(s_x\)</span>.</li>
<li><strong>Target Encoder (Teacher):</strong> Processes the part of the input to be predicted (the target, <span class="arithmatex">\(y\)</span>) to produce a representation <span class="arithmatex">\(s_y\)</span>.</li>
<li><strong>Predictor:</strong> A network that takes <span class="arithmatex">\(s_x\)</span> (and potentially a latent variable <span class="arithmatex">\(z\)</span> or action <span class="arithmatex">\(a\)</span>) and outputs a prediction <span class="arithmatex">\(\hat{s}_y\)</span>.</li>
</ol>
<p>The objective is to minimize the distance between the prediction and the target in embedding space:</p>
<div class="arithmatex">\[
L = D(\hat{s}_y, s_y) \tag{4}
\]</div>
<div class="admonition important">
<p class="admonition-title">Preventing Collapse via EMA</p>
<p>Critically, the Target Encoder is <strong>not</strong> updated via gradient descent from this loss. Doing so would allow the two encoders to conspire to output a constant.</p>
<p>Instead, the Target Encoder's weights <span class="arithmatex">\(\phi\)</span> are updated as an <strong>Exponential Moving Average (EMA)</strong> of the Context Encoder's weights <span class="arithmatex">\(\theta\)</span>:</p>
<div class="arithmatex">\[
\phi_t \leftarrow \tau \phi_{t-1} + (1 - \tau)\theta_t \tag{5}
\]</div>
<p>Where <span class="arithmatex">\(\tau\)</span> is a decay parameter typically close to 1 (e.g., 0.996). This asymmetry ensures that the target representation is stable and semantically rich, forcing the predictor to learn the underlying dynamics to match it.</p>
</div>
<h3 id="i-jepa-image-based-world-modeling">I-JEPA: Image-Based World Modeling</h3>
<p><strong>I-JEPA</strong> applies this principle to static images. It treats the image as a "world" where spatial relationships define the physics.</p>
<ul>
<li><strong>Context:</strong> A subset of image patches.</li>
<li><strong>Target:</strong> A different, masked subset of patches.</li>
</ul>
<p>By predicting the embeddings of the missing patches, the model learns high-level semantic features (object parts, shapes) without ever generating pixels.</p>
<div class="admonition info">
<p class="admonition-title">Overcoming Texture Bias</p>
<p>This approach avoids the <strong>"texture bias"</strong> of generative models like <strong>Masked Autoencoders (MAE)</strong>.</p>
<p>While MAE wastes capacity reconstructing high-frequency noise (pixels), I-JEPA focuses solely on semantic content by operating in the latent space.</p>
</div>
<h3 id="v-jepa-the-engine-of-physical-understanding">V-JEPA: The Engine of Physical Understanding</h3>
<p><strong>V-JEPA</strong> extends this to the temporal domain, which is the natural domain of World Models. In V-JEPA, the input is a video sequence.</p>
<ul>
<li><strong>Context:</strong> A set of spatio-temporal blocks (tubelets) from the video.</li>
<li><strong>Target:</strong> A different set of tubelets, often representing the future frames or occluded regions.</li>
<li><strong>Physics as Prediction:</strong> By predicting the representation of future frames, the model implicitly learns the laws of physics.<ul>
<li>To predict where a ball will be in <span class="arithmatex">\(t + 1\)</span>, it must understand velocity and inertia.</li>
<li>To predict the representation of a person walking behind a tree, it must understand occlusion and object permanence <a href="#App25">[App25]</a>.</li>
</ul>
</li>
</ul>
<div class="admonition important">
<p class="admonition-title">Crucial: The Masking Strategy</p>
<p>The <strong>masking strategy</strong> in V-JEPA is critical to success.</p>
<ul>
<li><strong>Random Masking (Bad):</strong> If we mask random scattered tubelets, the model can simply interpolate from neighbors (spatial smoothing).</li>
<li><strong>Block Masking (Good):</strong> To force the learning of dynamics, we must mask <strong>entire blocks of time or space</strong>. This forces the model to bridge the gap using its understanding of motion rather than local texture statistics [ABB+23].</li>
</ul>
</div>
<h2 id="the-challenge-of-stochasticity-and-latent-variables">The Challenge of Stochasticity and Latent Variables</h2>
<p>The real world is <strong>not deterministic</strong>.</p>
<ul>
<li><strong>Deterministic:</strong> If an agent drops a pen, it will fall.</li>
<li><strong>Stochastic:</strong> If an agent observes a car approaching an intersection, the car might turn left, right, or go straight.</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">The Flaw of Averaging</p>
<p>A World Model that outputs a single deterministic prediction <span class="arithmatex">\(\hat{s}_{t+1}\)</span> will inevitably predict the <strong>average</strong> of all possible futures.</p>
<p>In embedding space, the average of a "left-turn representation" and a "right-turn representation" might be a <strong>"crash-into-the-divider representation"</strong> or a blurry, non-descript state.</p>
</div>
<h3 id="latent-variable-z">Latent Variable <span class="arithmatex">\(z\)</span></h3>
<h3 id="handling-multimodal-futures">Handling Multimodal Futures</h3>
<p>To handle multimodal futures, the JEPA architecture supports a <strong>latent variable</strong> <span class="arithmatex">\(z\)</span>. The predictor becomes a function of both the context and this latent variable:</p>
<div class="arithmatex">\[
\hat{s}_y = \text{Predictor}(s_x, z) \tag{6}
\]</div>
<p>The variable <span class="arithmatex">\(z\)</span> encodes the information present in the future (<span class="arithmatex">\(y\)</span>) that is <strong>not</strong> present in the past (<span class="arithmatex">\(x\)</span>).</p>
<div class="admonition info">
<p class="admonition-title">Generative vs. EBM Frameworks</p>
<p>The treatment of <span class="arithmatex">\(z\)</span> differs fundamentally between paradigms:</p>
<ul>
<li><strong>Generative Framework:</strong> We would sample <span class="arithmatex">\(z\)</span> from a fixed prior distribution.</li>
<li><strong>EBM Framework:</strong> <span class="arithmatex">\(z\)</span> is an input that <strong>minimizes the energy</strong>.</li>
</ul>
</div>
<div class="arithmatex">\[
E(x, y) = \min_z D(\hat{s}_y(z), s_y) \tag{7}
\]</div>
<p>This allows the model to "explain away" the uncertainty. For a specific future <span class="arithmatex">\(y\)</span> (e.g., the car turned left), there exists a <span class="arithmatex">\(z\)</span> (representing the "decision to turn left") that makes the prediction match the target.</p>
<h3 id="determinism-in-simplified-environments">Determinism in Simplified Environments</h3>
<h3 id="practical-implementation-moving-mnist">Practical Implementation: Moving MNIST</h3>
<p>For the practical implementation guide in this report, we will focus on the <strong>Moving MNIST</strong> dataset. This environment is largely deterministic:</p>
<ul>
<li><strong>Dynamics:</strong> Digits move with constant velocity.</li>
<li><strong>Physics:</strong> Digits reflect off walls deterministically.</li>
<li><strong>Ambiguity:</strong> There is only minor ambiguity during occlusion (e.g., determining which digit is on top).</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Simplification Strategy</p>
<p>Because the physics are rigid, we can initially simplify our architecture by <strong>omitting the explicit latent <span class="arithmatex">\(z\)</span></strong>.</p>
<p>We rely on the inherent capacity of the predictor to approximate the dominant mode of the distribution. This reduces architectural complexity for the learner while still capturing the core principles of the JEPA.</p>
</div>
<h1 id="practical-implementation-strategy-the-micro-world">Practical Implementation Strategy: The Micro-World</h1>
<p>We now transition from theory to practice. The request requires a step-by-step guide to building a World Model using a small, open-source dataset.</p>
<div class="admonition check">
<p class="admonition-title">The Selection</p>
<p>We select <strong>Moving MNIST</strong> as the ideal <strong>"Micro-World."</strong></p>
</div>
<h3 id="why-moving-mnist">Why Moving MNIST?</h3>
<p>Moving MNIST consists of sequences (typically 20 frames) of <span class="arithmatex">\(64 \times 64\)</span> pixel images containing two handwritten digits bouncing inside a frame.</p>
<ol>
<li><strong>Physics:</strong> It exhibits strict physical laws: conservation of momentum (velocity), reflection (bouncing), and depth (occlusion).</li>
<li><strong>Manifold Hypothesis:</strong> The high-dimensional pixel space (<span class="arithmatex">\(20 \times 64 \times 64 = 81,920\)</span> dimensions) is generated by a very low-dimensional set of latent variables: the position <span class="arithmatex">\((x, y)\)</span>, velocity <span class="arithmatex">\((v_x, v_y)\)</span>, and digit identity (<span class="arithmatex">\(ID\)</span>) for two objects. A successful World Model should theoretically compress the video down to this low-dimensional manifold.</li>
<li><strong>Compute Efficiency:</strong> Unlike Kinetics-400 or real-world robotics data, Moving MNIST can be trained on a <strong>single consumer GPU</strong> (or even a high-end CPU in a reasonable time for debugging), making it accessible for a "from scratch" guide.</li>
</ol>
<h3 id="the-data-structure">The Data Structure</h3>
<p>The dataset is typically generated on-the-fly to prevent overfitting (infinite data regime) or downloaded as a fixed set.</p>
<ul>
<li><strong>Input Tensor:</strong> <code>(Batch, Time, Height, Width)</code></li>
<li><strong>Dimensions:</strong> <code>(B, 16, 64, 64)</code> (We use 16 frames for standard V-JEPA input).</li>
<li><strong>Normalization:</strong> Pixels should be normalized to the range <code>[0, 1]</code> or <code>[-1, 1]</code>.</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Self-Supervised Learning</p>
<p>We <strong>do not</strong> use the class labels (which digit is which) for training. This is <strong>Self-Supervised Learning</strong>. </p>
<p>The signal comes from predicting the masked portions of the video, not from ground-truth labels.</p>
</div>
<h2 id="phase-1">Phase 1</h2>
<p>Phase 1 is the foundation. If the data doesn't obey physics, the World Model has nothing to learn.</p>
<div class="admonition quote">
<p class="admonition-title">The Architect</p>
<p>We are acting as the <strong>"Creator"</strong> of this Micro-World. We define the space, time, matter, and the laws of physics.</p>
</div>
<h3 id="overview-the-5-step-recipe">Overview: The 5-Step Recipe</h3>
<p>We will break the data generation into five logical steps:</p>
<ol>
<li><strong>The Universe:</strong> Defining the empty void (Space and Time).</li>
<li><strong>The Atoms:</strong> Getting the raw matter (MNIST digits).</li>
<li><strong>The Big Bang:</strong> Setting initial positions and velocities.</li>
<li><strong>The Laws of Physics:</strong> Updating positions and handling bounces.</li>
<li><strong>Rendering:</strong> Drawing the "atoms" onto the "universe" (handling overlap).</li>
</ol>
<h4 id="step-1-the-universe-the-5d-tensor">Step 1: The Universe (The 5D Tensor)</h4>
<p>In Deep Learning, a video is just a 5-dimensional block of numbers.</p>
<p><strong>The Dimensions:</strong> <code>(Batch, Time, Channels, Height, Width)</code></p>
<ul>
<li><strong>Batch (B):</strong> How many parallel universes we simulate at once (e.g., 16 videos).</li>
<li><strong>Time (T):</strong> The length of history (e.g., 16 frames).</li>
<li><strong>Channels (C):</strong> 1 (Black &amp; White).</li>
<li><strong>Height/Width (H, W):</strong> <span class="arithmatex">\(64 \times 64\)</span> pixels.</li>
</ul>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">void.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span>
<span class="normal"><a href="#__codelineno-0-7">7</a></span>
<span class="normal"><a href="#__codelineno-0-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="c1"># ---------------------------------------------------------</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="c1"># INITIALIZE THE VOID</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="c1"># ---------------------------------------------------------</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="c1"># Create an empty universe filled with zeros (black)</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="c1"># Target Shape: [Batch, Time, Channels, Height, Width]</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="c1"># Dimensions:   [16,    16,   1,        64,     64]</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="n">videos</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="step-2-the-atoms-the-digits">Step 2: The Atoms (The Digits)</h3>
<p>We need objects. We use standard MNIST handwritten digits.</p>
<ul>
<li><strong>The Problem:</strong> Standard MNIST is <span class="arithmatex">\(28 \times 28\)</span> pixels. Our world is <span class="arithmatex">\(64 \times 64\)</span>.</li>
<li><strong>The Preparation:</strong> We load the MNIST dataset and keep it in memory. We treat these <span class="arithmatex">\(28 \times 28\)</span> grids as our "solid objects."</li>
</ul>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">atoms.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span>
<span class="normal"><a href="#__codelineno-1-12">12</a></span>
<span class="normal"><a href="#__codelineno-1-13">13</a></span>
<span class="normal"><a href="#__codelineno-1-14">14</a></span>
<span class="normal"><a href="#__codelineno-1-15">15</a></span>
<span class="normal"><a href="#__codelineno-1-16">16</a></span>
<span class="normal"><a href="#__codelineno-1-17">17</a></span>
<span class="normal"><a href="#__codelineno-1-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1"># ---------------------------------------------------------</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="c1"># HARVESTING MATTER</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="c1"># ---------------------------------------------------------</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="c1"># We need raw materials to populate the universe.</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="c1"># Source: Standard MNIST handwritten digits.</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">MNIST</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="c1"># 1. Download and Load MNIST</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="c1"># Root: Where the raw data is stored locally</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="n">mnist</span> <span class="o">=</span> <span class="n">MNIST</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">&#39;./data&#39;</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12"></a>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="c1"># 2. Normalize and Float</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="c1"># Convert integer pixels [0, 255] to float [0.0, 1.0]</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="n">data</span> <span class="o">=</span> <span class="n">mnist</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">/</span> <span class="mf">255.0</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16"></a>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Matter Harvested: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> 
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="c1"># Output: torch.Size([60000, 28, 28])</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="step-3-the-big-bang-initialization">Step 3: The Big Bang (Initialization)</h3>
<p>For every video in the batch, we need to decide where the digits start and where they are going.</p>
<ol>
<li><strong>Position (<span class="arithmatex">\(P\)</span>):</strong> A random coordinate <span class="arithmatex">\((x, y)\)</span> inside the <span class="arithmatex">\(64 \times 64\)</span> box.<ul>
<li><strong>Constraint:</strong> We don't want the digit to spawn strictly on the edge, so we limit the spawn area to <span class="arithmatex">\(64 - 28 = 36\)</span>.</li>
</ul>
</li>
<li><strong>Velocity (<span class="arithmatex">\(V\)</span>):</strong> How fast and in what direction?<ul>
<li>We pick a random angle <span class="arithmatex">\(\theta\)</span> between <span class="arithmatex">\(0\)</span> and <span class="arithmatex">\(2\pi\)</span> (<span class="arithmatex">\(360^\circ\)</span>).</li>
<li>We convert this angle into a velocity vector <span class="arithmatex">\((v_x, v_y)\)</span> using trigonometry:</li>
</ul>
</li>
</ol>
<div class="arithmatex">\[
v_x = \cos(\theta) \tag{8}
\]</div>
<div class="arithmatex">\[
v_y = \sin(\theta) \tag{9}
\]</div>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">big_bang.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span>
<span class="normal"><a href="#__codelineno-2-14">14</a></span>
<span class="normal"><a href="#__codelineno-2-15">15</a></span>
<span class="normal"><a href="#__codelineno-2-16">16</a></span>
<span class="normal"><a href="#__codelineno-2-17">17</a></span>
<span class="normal"><a href="#__codelineno-2-18">18</a></span>
<span class="normal"><a href="#__codelineno-2-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="c1"># ---------------------------------------------------------</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="c1"># INITIALIZE TRAJECTORIES</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="c1"># ---------------------------------------------------------</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="c1"># Determine initial state vectors for all particles (digits).</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7"></a>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="c1"># 1. Random Position (x, y)</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="c1"># Limit spawn range to [0, 36] to prevent clipping at t=0</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="c1"># (Universe Width 64) - (Atom Size 28) = 36</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="n">pos</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">64</span> <span class="o">-</span> <span class="mi">28</span><span class="p">)</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12"></a>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="c1"># 2. Random Angle (Theta)</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="c1"># range: [0, 2*PI]</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="n">angle</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="mf">3.14159</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16"></a>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="c1"># 3. Calculate Velocity Vector</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="c1"># Decompose angle into x and y components</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="n">vel</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)])</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="step-4-the-laws-of-physics-the-simulation-loop">Step 4: The Laws of Physics (The Simulation Loop)</h3>
<p>This is the most critical part. We loop through time (<span class="arithmatex">\(t = 0\)</span> to <span class="arithmatex">\(t = 15\)</span>) and update the state of the world.</p>
<div class="admonition abstract">
<p class="admonition-title">Universal Law 1: Momentum</p>
<p><strong>Objects move in a straight line unless acted upon.</strong></p>
<div class="arithmatex">\[
P_{new} = P_{old} + V \times \text{speed} \tag{10}
\]</div>
</div>
<div class="admonition abstract">
<p class="admonition-title">Universal Law 2: Reflection</p>
<p><strong>If an object hits a wall, its velocity in that direction flips sign.</strong></p>
<ul>
<li>If <span class="arithmatex">\(x &lt; 0\)</span> or <span class="arithmatex">\(x &gt; \text{limit}\)</span>: <span class="arithmatex">\(\quad v_x = -v_x\)</span></li>
<li>If <span class="arithmatex">\(y &lt; 0\)</span> or <span class="arithmatex">\(y &gt; \text{limit}\)</span>: <span class="arithmatex">\(\quad v_y = -v_y\)</span></li>
</ul>
</div>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">physics_engine.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span>
<span class="normal"><a href="#__codelineno-3-14">14</a></span>
<span class="normal"><a href="#__codelineno-3-15">15</a></span>
<span class="normal"><a href="#__codelineno-3-16">16</a></span>
<span class="normal"><a href="#__codelineno-3-17">17</a></span>
<span class="normal"><a href="#__codelineno-3-18">18</a></span>
<span class="normal"><a href="#__codelineno-3-19">19</a></span>
<span class="normal"><a href="#__codelineno-3-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="c1"># ---------------------------------------------------------</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="c1"># SIMULATION LOOP (t=0 to t=15)</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="c1"># ---------------------------------------------------------</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">seq_len</span><span class="p">):</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6"></a>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7"></a>    <span class="c1"># 1. Update Position (Law of Momentum)</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8"></a>    <span class="c1"># Move object along vector by speed factor</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9"></a>    <span class="n">pos</span> <span class="o">+=</span> <span class="n">vel</span> <span class="o">*</span> <span class="mf">3.0</span>  <span class="c1"># Speed: 3 pixels per frame</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10"></a>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11"></a>    <span class="c1"># 2. Check Walls (Law of Reflection)</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12"></a>    <span class="c1"># Boundary Limit: 64 (Universe) - 28 (Atom) = 36</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13"></a>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14"></a>    <span class="c1"># Check Horizontal Walls (Left/Right)</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15"></a>    <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">36</span><span class="p">:</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16"></a>        <span class="n">vel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># Flip X velocity</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17"></a>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18"></a>    <span class="c1"># Check Vertical Walls (Top/Bottom)</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19"></a>    <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">36</span><span class="p">:</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20"></a>        <span class="n">vel</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># Flip Y velocity</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="step-5-rendering-occlusion">Step 5: Rendering (Occlusion)</h3>
<p>We know where the digit is (e.g., <span class="arithmatex">\(x = 10.5, y = 5.2\)</span>). But computers usually work with integers for array slicing.</p>
<ol>
<li><strong>Discretization:</strong> Round the float coordinates to the nearest integer <span class="arithmatex">\((r, c)\)</span>.</li>
<li><strong>Slicing:</strong> We copy the <span class="arithmatex">\(28 \times 28\)</span> digit image into the <span class="arithmatex">\(64 \times 64\)</span> canvas at those coordinates.</li>
<li><strong>Occlusion (The "Over" Operator):</strong> What if two digits overlap?<ul>
<li>In the real world, the front object blocks the back object.</li>
<li>In Moving MNIST, we usually use the <strong>MAX</strong> operator. If pixel A is white and pixel B is black, the result is white. This simulates "bright light objects."</li>
</ul>
</li>
</ol>
<div class="arithmatex">\[
\text{Canvas}[r : r + 28, c : c + 28] = \max(\text{Canvas}[...], \text{Digit}) \tag{11}
\]</div>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">renderer.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span>
<span class="normal"><a href="#__codelineno-4-14">14</a></span>
<span class="normal"><a href="#__codelineno-4-15">15</a></span>
<span class="normal"><a href="#__codelineno-4-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="c1"># ---------------------------------------------------------</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="c1"># RENDER FRAME</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="c1"># ---------------------------------------------------------</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="c1"># Determine integer coordinates for array slicing</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="n">r</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>  <span class="c1"># Row (y)</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="n">c</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>  <span class="c1"># Column (x)</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7"></a>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="c1"># Define the slice window on the canvas</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="c1"># canvas_slice = canvas[r : r+28, c : c+28]</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10"></a>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="c1"># Apply the MAX operator for occlusion</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="c1"># This effectively superimposes the digit onto the canvas</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="n">canvas</span><span class="p">[</span><span class="n">r</span> <span class="p">:</span> <span class="n">r</span><span class="o">+</span><span class="mi">28</span><span class="p">,</span> <span class="n">c</span> <span class="p">:</span> <span class="n">c</span><span class="o">+</span><span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14"></a>    <span class="n">canvas</span><span class="p">[</span><span class="n">r</span> <span class="p">:</span> <span class="n">r</span><span class="o">+</span><span class="mi">28</span><span class="p">,</span> <span class="n">c</span> <span class="p">:</span> <span class="n">c</span><span class="o">+</span><span class="mi">28</span><span class="p">],</span> 
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15"></a>    <span class="n">digit_image</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="complete-implementation">Complete Implementation</h3>
<h3 id="the-assemblage-microworldfactory">The Assemblage: MicroWorldFactory</h3>
<p>We now combine the atoms, the void, and the laws of physics into a single, reusable class.</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">micro_world.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1">  1</a></span>
<span class="normal"><a href="#__codelineno-5-2">  2</a></span>
<span class="normal"><a href="#__codelineno-5-3">  3</a></span>
<span class="normal"><a href="#__codelineno-5-4">  4</a></span>
<span class="normal"><a href="#__codelineno-5-5">  5</a></span>
<span class="normal"><a href="#__codelineno-5-6">  6</a></span>
<span class="normal"><a href="#__codelineno-5-7">  7</a></span>
<span class="normal"><a href="#__codelineno-5-8">  8</a></span>
<span class="normal"><a href="#__codelineno-5-9">  9</a></span>
<span class="normal"><a href="#__codelineno-5-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-5-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-5-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-5-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-5-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-5-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-5-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-5-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-5-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-5-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-5-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-5-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-5-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-5-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-5-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-5-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-5-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-5-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-5-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-5-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-5-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-5-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-5-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-5-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-5-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-5-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-5-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-5-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-5-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-5-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-5-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-5-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-5-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-5-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-5-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-5-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-5-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-5-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-5-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-5-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-5-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-5-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-5-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-5-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-5-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-5-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-5-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-5-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-5-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-5-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-5-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-5-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-5-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-5-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-5-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-5-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-5-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-5-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-5-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-5-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-5-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-5-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-5-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-5-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-5-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-5-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-5-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-5-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-5-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-5-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-5-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-5-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-5-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-5-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-5-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-5-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-5-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-5-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-5-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-5-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-5-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-5-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-5-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-5-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-5-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-5-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-5-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-5-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-5-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-5-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-5-100">100</a></span>
<span class="normal"><a href="#__codelineno-5-101">101</a></span>
<span class="normal"><a href="#__codelineno-5-102">102</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">MNIST</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5"></a>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">MicroWorldFactory</span><span class="p">:</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">seq_len</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">seq_len</span> <span class="o">=</span> <span class="n">seq_len</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">img_size</span> <span class="o">=</span> <span class="mi">64</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">digit_size</span> <span class="o">=</span> <span class="mi">28</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12"></a>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13"></a>        <span class="c1"># -----------------------------------------------------</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14"></a>        <span class="c1"># HARVEST ATOMS (Load MNIST)</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15"></a>        <span class="c1"># -----------------------------------------------------</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading MNIST atoms...&quot;</span><span class="p">)</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17"></a>        <span class="n">mnist</span> <span class="o">=</span> <span class="n">MNIST</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">&#39;./data&#39;</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="n">mnist</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">/</span> <span class="mf">255.0</span>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_atoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20"></a>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_universe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23"></a><span class="sd">        Creates a batch of videos with proper physics.</span>
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24"></a><span class="sd">        Returns: [Batch, Channels, Time, Height, Width]</span>
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25"></a><span class="sd">        Range:   [-1, 1]</span>
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27"></a>        <span class="c1"># Initialize Void: [B, T, C, H, W]</span>
</span><span id="__span-5-28"><a id="__codelineno-5-28" name="__codelineno-5-28"></a>        <span class="c1"># Note: We keep Channels at dim 2 temporarily for easier slicing</span>
</span><span id="__span-5-29"><a id="__codelineno-5-29" name="__codelineno-5-29"></a>        <span class="n">videos</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
</span><span id="__span-5-30"><a id="__codelineno-5-30" name="__codelineno-5-30"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq_len</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_size</span>
</span><span id="__span-5-31"><a id="__codelineno-5-31" name="__codelineno-5-31"></a>        <span class="p">)</span>
</span><span id="__span-5-32"><a id="__codelineno-5-32" name="__codelineno-5-32"></a>
</span><span id="__span-5-33"><a id="__codelineno-5-33" name="__codelineno-5-33"></a>        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span>
</span><span id="__span-5-34"><a id="__codelineno-5-34" name="__codelineno-5-34"></a>            <span class="c1"># 1. Select 2 random digits</span>
</span><span id="__span-5-35"><a id="__codelineno-5-35" name="__codelineno-5-35"></a>            <span class="n">idx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_atoms</span><span class="p">)</span>
</span><span id="__span-5-36"><a id="__codelineno-5-36" name="__codelineno-5-36"></a>            <span class="n">idx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_atoms</span><span class="p">)</span>
</span><span id="__span-5-37"><a id="__codelineno-5-37" name="__codelineno-5-37"></a>            <span class="n">digit1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">idx1</span><span class="p">]</span>
</span><span id="__span-5-38"><a id="__codelineno-5-38" name="__codelineno-5-38"></a>            <span class="n">digit2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">idx2</span><span class="p">]</span>
</span><span id="__span-5-39"><a id="__codelineno-5-39" name="__codelineno-5-39"></a>
</span><span id="__span-5-40"><a id="__codelineno-5-40" name="__codelineno-5-40"></a>            <span class="c1"># 2. Initialize Physics (Digit 1)</span>
</span><span id="__span-5-41"><a id="__codelineno-5-41" name="__codelineno-5-41"></a>            <span class="n">pos1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_size</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">digit_size</span><span class="p">)</span>
</span><span id="__span-5-42"><a id="__codelineno-5-42" name="__codelineno-5-42"></a>            <span class="n">angle1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
</span><span id="__span-5-43"><a id="__codelineno-5-43" name="__codelineno-5-43"></a>            <span class="n">vel1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle1</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle1</span><span class="p">)])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="__span-5-44"><a id="__codelineno-5-44" name="__codelineno-5-44"></a>
</span><span id="__span-5-45"><a id="__codelineno-5-45" name="__codelineno-5-45"></a>            <span class="c1"># 3. Initialize Physics (Digit 2)</span>
</span><span id="__span-5-46"><a id="__codelineno-5-46" name="__codelineno-5-46"></a>            <span class="n">pos2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_size</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">digit_size</span><span class="p">)</span>
</span><span id="__span-5-47"><a id="__codelineno-5-47" name="__codelineno-5-47"></a>            <span class="n">angle2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
</span><span id="__span-5-48"><a id="__codelineno-5-48" name="__codelineno-5-48"></a>            <span class="n">vel2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle2</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle2</span><span class="p">)])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="__span-5-49"><a id="__codelineno-5-49" name="__codelineno-5-49"></a>
</span><span id="__span-5-50"><a id="__codelineno-5-50" name="__codelineno-5-50"></a>            <span class="c1"># -------------------------------------------------</span>
</span><span id="__span-5-51"><a id="__codelineno-5-51" name="__codelineno-5-51"></a>            <span class="c1"># SIMULATION LOOP</span>
</span><span id="__span-5-52"><a id="__codelineno-5-52" name="__codelineno-5-52"></a>            <span class="c1"># -------------------------------------------------</span>
</span><span id="__span-5-53"><a id="__codelineno-5-53" name="__codelineno-5-53"></a>            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seq_len</span><span class="p">):</span>
</span><span id="__span-5-54"><a id="__codelineno-5-54" name="__codelineno-5-54"></a>
</span><span id="__span-5-55"><a id="__codelineno-5-55" name="__codelineno-5-55"></a>                <span class="c1"># --- RENDER DIGIT 1 ---</span>
</span><span id="__span-5-56"><a id="__codelineno-5-56" name="__codelineno-5-56"></a>                <span class="n">r1</span><span class="p">,</span> <span class="n">c1</span> <span class="o">=</span> <span class="n">pos1</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">int</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="__span-5-57"><a id="__codelineno-5-57" name="__codelineno-5-57"></a>                <span class="c1"># Clamp to ensure we stay within array bounds</span>
</span><span id="__span-5-58"><a id="__codelineno-5-58" name="__codelineno-5-58"></a>                <span class="n">r1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_size</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">digit_size</span><span class="p">))</span>
</span><span id="__span-5-59"><a id="__codelineno-5-59" name="__codelineno-5-59"></a>                <span class="n">c1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_size</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">digit_size</span><span class="p">))</span>
</span><span id="__span-5-60"><a id="__codelineno-5-60" name="__codelineno-5-60"></a>
</span><span id="__span-5-61"><a id="__codelineno-5-61" name="__codelineno-5-61"></a>                <span class="c1"># Apply MAX operator (Occlusion)</span>
</span><span id="__span-5-62"><a id="__codelineno-5-62" name="__codelineno-5-62"></a>                <span class="n">videos</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r1</span><span class="p">:</span><span class="n">r1</span><span class="o">+</span><span class="mi">28</span><span class="p">,</span> <span class="n">c1</span><span class="p">:</span><span class="n">c1</span><span class="o">+</span><span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
</span><span id="__span-5-63"><a id="__codelineno-5-63" name="__codelineno-5-63"></a>                    <span class="n">videos</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r1</span><span class="p">:</span><span class="n">r1</span><span class="o">+</span><span class="mi">28</span><span class="p">,</span> <span class="n">c1</span><span class="p">:</span><span class="n">c1</span><span class="o">+</span><span class="mi">28</span><span class="p">],</span> <span class="n">digit1</span>
</span><span id="__span-5-64"><a id="__codelineno-5-64" name="__codelineno-5-64"></a>                <span class="p">)</span>
</span><span id="__span-5-65"><a id="__codelineno-5-65" name="__codelineno-5-65"></a>
</span><span id="__span-5-66"><a id="__codelineno-5-66" name="__codelineno-5-66"></a>                <span class="c1"># --- RENDER DIGIT 2 ---</span>
</span><span id="__span-5-67"><a id="__codelineno-5-67" name="__codelineno-5-67"></a>                <span class="n">r2</span><span class="p">,</span> <span class="n">c2</span> <span class="o">=</span> <span class="n">pos2</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">int</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="__span-5-68"><a id="__codelineno-5-68" name="__codelineno-5-68"></a>                <span class="n">r2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_size</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">digit_size</span><span class="p">))</span>
</span><span id="__span-5-69"><a id="__codelineno-5-69" name="__codelineno-5-69"></a>                <span class="n">c2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_size</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">digit_size</span><span class="p">))</span>
</span><span id="__span-5-70"><a id="__codelineno-5-70" name="__codelineno-5-70"></a>
</span><span id="__span-5-71"><a id="__codelineno-5-71" name="__codelineno-5-71"></a>                <span class="n">videos</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r2</span><span class="p">:</span><span class="n">r2</span><span class="o">+</span><span class="mi">28</span><span class="p">,</span> <span class="n">c2</span><span class="p">:</span><span class="n">c2</span><span class="o">+</span><span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
</span><span id="__span-5-72"><a id="__codelineno-5-72" name="__codelineno-5-72"></a>                    <span class="n">videos</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r2</span><span class="p">:</span><span class="n">r2</span><span class="o">+</span><span class="mi">28</span><span class="p">,</span> <span class="n">c2</span><span class="p">:</span><span class="n">c2</span><span class="o">+</span><span class="mi">28</span><span class="p">],</span> <span class="n">digit2</span>
</span><span id="__span-5-73"><a id="__codelineno-5-73" name="__codelineno-5-73"></a>                <span class="p">)</span>
</span><span id="__span-5-74"><a id="__codelineno-5-74" name="__codelineno-5-74"></a>
</span><span id="__span-5-75"><a id="__codelineno-5-75" name="__codelineno-5-75"></a>                <span class="c1"># --- UPDATE PHYSICS (Digit 1) ---</span>
</span><span id="__span-5-76"><a id="__codelineno-5-76" name="__codelineno-5-76"></a>                <span class="n">pos1</span> <span class="o">+=</span> <span class="n">vel1</span> <span class="o">*</span> <span class="mf">3.0</span>
</span><span id="__span-5-77"><a id="__codelineno-5-77" name="__codelineno-5-77"></a>                <span class="c1"># Bounce X</span>
</span><span id="__span-5-78"><a id="__codelineno-5-78" name="__codelineno-5-78"></a>                <span class="k">if</span> <span class="n">pos1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">pos1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_size</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">digit_size</span><span class="p">):</span>
</span><span id="__span-5-79"><a id="__codelineno-5-79" name="__codelineno-5-79"></a>                    <span class="n">vel1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="__span-5-80"><a id="__codelineno-5-80" name="__codelineno-5-80"></a>                    <span class="n">pos1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">pos1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_size</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">digit_size</span><span class="p">)</span>
</span><span id="__span-5-81"><a id="__codelineno-5-81" name="__codelineno-5-81"></a>                <span class="c1"># Bounce Y</span>
</span><span id="__span-5-82"><a id="__codelineno-5-82" name="__codelineno-5-82"></a>                <span class="k">if</span> <span class="n">pos1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">pos1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_size</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">digit_size</span><span class="p">):</span>
</span><span id="__span-5-83"><a id="__codelineno-5-83" name="__codelineno-5-83"></a>                    <span class="n">vel1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="__span-5-84"><a id="__codelineno-5-84" name="__codelineno-5-84"></a>                    <span class="n">pos1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">pos1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_size</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">digit_size</span><span class="p">)</span>
</span><span id="__span-5-85"><a id="__codelineno-5-85" name="__codelineno-5-85"></a>
</span><span id="__span-5-86"><a id="__codelineno-5-86" name="__codelineno-5-86"></a>                <span class="c1"># --- UPDATE PHYSICS (Digit 2) ---</span>
</span><span id="__span-5-87"><a id="__codelineno-5-87" name="__codelineno-5-87"></a>                <span class="n">pos2</span> <span class="o">+=</span> <span class="n">vel2</span> <span class="o">*</span> <span class="mf">3.0</span>
</span><span id="__span-5-88"><a id="__codelineno-5-88" name="__codelineno-5-88"></a>                <span class="c1"># Bounce X</span>
</span><span id="__span-5-89"><a id="__codelineno-5-89" name="__codelineno-5-89"></a>                <span class="k">if</span> <span class="n">pos2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">pos2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_size</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">digit_size</span><span class="p">):</span>
</span><span id="__span-5-90"><a id="__codelineno-5-90" name="__codelineno-5-90"></a>                    <span class="n">vel2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="__span-5-91"><a id="__codelineno-5-91" name="__codelineno-5-91"></a>                    <span class="n">pos2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">pos2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_size</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">digit_size</span><span class="p">)</span>
</span><span id="__span-5-92"><a id="__codelineno-5-92" name="__codelineno-5-92"></a>                <span class="c1"># Bounce Y</span>
</span><span id="__span-5-93"><a id="__codelineno-5-93" name="__codelineno-5-93"></a>                <span class="k">if</span> <span class="n">pos2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">pos2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_size</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">digit_size</span><span class="p">):</span>
</span><span id="__span-5-94"><a id="__codelineno-5-94" name="__codelineno-5-94"></a>                    <span class="n">vel2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="__span-5-95"><a id="__codelineno-5-95" name="__codelineno-5-95"></a>                    <span class="n">pos2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">pos2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_size</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">digit_size</span><span class="p">)</span>
</span><span id="__span-5-96"><a id="__codelineno-5-96" name="__codelineno-5-96"></a>
</span><span id="__span-5-97"><a id="__codelineno-5-97" name="__codelineno-5-97"></a>        <span class="c1"># -----------------------------------------------------</span>
</span><span id="__span-5-98"><a id="__codelineno-5-98" name="__codelineno-5-98"></a>        <span class="c1"># FORMAT OUTPUT</span>
</span><span id="__span-5-99"><a id="__codelineno-5-99" name="__codelineno-5-99"></a>        <span class="c1"># -----------------------------------------------------</span>
</span><span id="__span-5-100"><a id="__codelineno-5-100" name="__codelineno-5-100"></a>        <span class="c1"># Permute to Standard Video Tensor: [B, C, T, H, W]</span>
</span><span id="__span-5-101"><a id="__codelineno-5-101" name="__codelineno-5-101"></a>        <span class="c1"># Normalize 0..1 to -1..1</span>
</span><span id="__span-5-102"><a id="__codelineno-5-102" name="__codelineno-5-102"></a>        <span class="k">return</span> <span class="p">(</span><span class="n">videos</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.0</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="exercise-1-the-teleportation-catastrophe-speed">Exercise 1: The "Teleportation" Catastrophe (Speed)</h3>
<p>Let's break the universe we just created.</p>
<p><strong>The Goal:</strong> Observe the limitations of discrete time steps.</p>
<p><strong>The Change:</strong> Go to the physics loop in <code>create_universe</code>. Find where we update <code>pos1</code>. Change the speed modifier from <code>3.0</code> to <code>20.0</code>.</p>
<div class="language-python highlight"><span class="filename">Modification</span><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1"># OLD CODE</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="hll"><span class="c1"># pos1 += vel1 * 3.0</span>
</span></span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="c1"># NEW CODE (The Catastrophe)</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="n">pos1</span> <span class="o">+=</span> <span class="n">vel1</span> <span class="o">*</span> <span class="mf">20.0</span>
</span></code></pre></div>
<p align="center">
  <img src="img/figures/download (3).png" width="700">
  <figcaption><em>In frame 1, the digit is on the left. In frame 3, it is suddenly on the right. In frame 3, it‚Äôs gone (or
bounced back instantly). The AI is trying to predict the future. If an object teleports, there is no pattern
to learn. The AI will just give up and predict ‚Äùblur‚Äù everywhere because it has no idea where the object
went.</em></figcaption>
</p>

<h3 id="exercise-2-the-ghost-catastrophe-occlusion">Exercise 2: The "Ghost" Catastrophe (Occlusion)</h3>
<p>Now, let's break the visual physics.</p>
<p><strong>The Goal:</strong> Understand the difference between <em>emission</em> (light) and <em>occlusion</em> (matter).</p>
<p><strong>The Change:</strong> First, restore the speed to <code>3.0</code>. Now, find the rendering line with <code>torch.max</code>. Change it to <code>+</code> (addition).</p>
<div class="language-python highlight"><span class="filename">Modification</span><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1"># OLD CODE (Correct Occlusion)</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="c1"># videos[...] = torch.max(videos[...], digit1)</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="c1"># NEW CODE (The Ghost Bug)</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="c1"># We simply add the pixel values together</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="hll"><span class="n">videos</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">videos</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">+</span> <span class="n">digit1</span>
</span></span></code></pre></div>
<p align="center">
  <img src="img/figures/download (4) (1).png" width="700">
  <pcaption><em>The ‚ÄùGhost‚Äù Catastrophe (Occlusion)</em></pcaption>
</p>

<h3 id="exercise-3-the-frozen-time-catastrophe-static">Exercise 3: The "Frozen Time" Catastrophe (Static)</h3>
<p>Finally, let's break time itself.</p>
<p><strong>The Goal:</strong> Understand the danger of trivial solutions.</p>
<p><strong>The Change:</strong> Restore <code>torch.max</code>. Now, change the speed to <code>0.0</code>.</p>
<div class="language-python highlight"><span class="filename">Modification</span><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1"># OLD CODE</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="hll"><span class="c1"># pos1 += vel1 * 3.0</span>
</span></span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="c1"># NEW CODE (The Time Freeze)</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="n">pos1</span> <span class="o">+=</span> <span class="n">vel1</span> <span class="o">*</span> <span class="mf">0.0</span>
</span></code></pre></div>
<p align="center">
  <img src="img/figures/download (5).png" width="700">
  <pcaption><em>The ‚ÄùFrozen Time‚Äù</em></pcaption>
</p>

<h2 id="phase-2-building-the-brain-neural-network-architecture">Phase 2:  Building the Brain (Neural Network Architecture)</h2>
<p>Phase 2 is where we build the "brain" (the Neural Network) that will observe the "universe" you built in Phase 1.</p>
<div class="admonition abstract">
<p class="admonition-title">The Blueprint</p>
<p>We are building a <strong>V-JEPA (Video Joint Embedding Predictive Architecture)</strong>. </p>
<p>This sounds complex, but it is effectively just three simple <strong>LEGO blocks</strong> snapped together:</p>
<ol>
<li><strong>The Encoder (The Eye):</strong> Looks at video and converts pixels into numbers (embeddings).</li>
<li><strong>The Masking (The Game):</strong> We hide parts of the video to make the task difficult.</li>
<li><strong>The Predictor (The Brain):</strong> Tries to guess the missing parts based on what it can see.</li>
</ol>
</div>
<h3 id="the-encoder-the-eye-tubelet-embedding">The Encoder: The Eye (Tubelet Embedding)</h3>
<p>Standard images are 2D. Videos are 3D (Time + Height + Width). We cannot feed raw pixels directly to a Transformer. We must chop the video into little cubes. These cubes are called <strong>Tubelets</strong>.</p>
<p><strong>The Logic:</strong></p>
<ul>
<li><strong>Video Size:</strong> <span class="arithmatex">\(16 \text{ frames} \times 64 \text{ height} \times 64 \text{ width}\)</span></li>
<li><strong>Tubelet Size:</strong> <span class="arithmatex">\(1 \text{ frames} \times 4 \text{ height} \times 4 \text{ width}\)</span></li>
</ul>
<div class="admonition note">
<p class="admonition-title">The Tubelet Math</p>
<p>How many tokens does this generate?</p>
<ul>
<li><strong>Time:</strong> <span class="arithmatex">\(16 \div 1 = 16 \text{ slices}\)</span></li>
<li><strong>Height:</strong> <span class="arithmatex">\(64 \div 4 = 16 \text{ slices}\)</span></li>
<li><strong>Width:</strong> <span class="arithmatex">\(64 \div 4 = 16 \text{ slices}\)</span></li>
<li><strong>Total Tokens:</strong> <span class="arithmatex">\(16 \times 16 \times 16 = \mathbf{4096 \text{ little cubes}}\)</span></li>
</ul>
</div>
<h4 id="the-code-pytorch">The Code (PyTorch)</h4>
<p>We use <code>Conv3d</code>. This is a 3D scanner that slides over the video.</p>
<ul>
<li><strong>Kernel:</strong> The size of the scanner (the tubelet).</li>
<li><strong>Stride:</strong> How much the scanner moves. We set <code>stride = kernel</code> so the cubes don't overlap.</li>
</ul>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">encoder.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-9-10">10</a></span>
<span class="normal"><a href="#__codelineno-9-11">11</a></span>
<span class="normal"><a href="#__codelineno-9-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">TubeletEmbedding</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">embed_dim</span><span class="o">=</span><span class="mi">384</span><span class="p">):</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv3d</span><span class="p">(</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5"></a>            <span class="n">in_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6"></a>            <span class="n">out_channels</span><span class="o">=</span><span class="n">embed_dim</span><span class="p">,</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7"></a>            <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> 
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8"></a>            <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9"></a>        <span class="p">)</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10"></a>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="positional-embeddings-the-gps">Positional Embeddings: The GPS</h3>
<p>Transformers are "blind" to order. If you shuffle the video cubes, the Transformer doesn't know the difference. We must give each cube a GPS coordinate.</p>
<div class="admonition info">
<p class="admonition-title">Innovation: Factorized 3D Embeddings</p>
<p>Instead of giving one ID number (e.g., "Cube #45"), we give <strong>three coordinates</strong>:</p>
<ul>
<li><strong>Time:</strong> "Time = 3"</li>
<li><strong>Row:</strong> "Row = 2"</li>
<li><strong>Column:</strong> "Column = 5"</li>
</ul>
<p>This teaches the model physics: "Time 3" is logically close to "Time 4," whereas "Cube #45" has no numerical relation to "Cube #46" in a flattened list.</p>
</div>
<h4 id="the-code">The Code</h4>
<p>We create three separate lookup tables (learnable parameters) and add them together to form the final coordinate.</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">gps_module.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span>
<span class="normal"><a href="#__codelineno-10-11">11</a></span>
<span class="normal"><a href="#__codelineno-10-12">12</a></span>
<span class="normal"><a href="#__codelineno-10-13">13</a></span>
<span class="normal"><a href="#__codelineno-10-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">PositionalEmbedding</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">embed_dim</span><span class="o">=</span><span class="mi">384</span><span class="p">,</span> <span class="n">max_time_steps</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">spatial_size</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span> 
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">embed_dim</span><span class="p">,</span> <span class="n">max_time_steps</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">h_embed</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">embed_dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">spatial_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">w_embed</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">embed_dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">spatial_size</span><span class="p">))</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7"></a>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8"></a>        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9"></a>        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_embed</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10"></a>        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_embed</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11"></a>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13"></a>        <span class="n">B</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14"></a>        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">T</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_embed</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_embed</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="the-full-encoder-eye-gps-brain-cells">The Full Encoder (Eye + GPS + Brain Cells)</h3>
<p>Now we stack standard Transformer layers on top. This is the <strong>"Context Encoder."</strong></p>
<p>It combines the "Eye" (Tubelet Embeddings), the "GPS" (Positional Embeddings), and the "Brain Cells" (Attention Blocks) into a single processing unit.</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">context_encoder.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span>
<span class="normal"><a href="#__codelineno-11-11">11</a></span>
<span class="normal"><a href="#__codelineno-11-12">12</a></span>
<span class="normal"><a href="#__codelineno-11-13">13</a></span>
<span class="normal"><a href="#__codelineno-11-14">14</a></span>
<span class="normal"><a href="#__codelineno-11-15">15</a></span>
<span class="normal"><a href="#__codelineno-11-16">16</a></span>
<span class="normal"><a href="#__codelineno-11-17">17</a></span>
<span class="normal"><a href="#__codelineno-11-18">18</a></span>
<span class="normal"><a href="#__codelineno-11-19">19</a></span>
<span class="normal"><a href="#__codelineno-11-20">20</a></span>
<span class="normal"><a href="#__codelineno-11-21">21</a></span>
<span class="normal"><a href="#__codelineno-11-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">VideoEncoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">embed_dim</span><span class="o">=</span><span class="mi">384</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span> <span class="o">=</span> <span class="n">embed_dim</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tubelet_embed</span> <span class="o">=</span> <span class="n">TubeletEmbedding</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">)</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pos_embed</span> <span class="o">=</span> <span class="n">PositionalEmbedding</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">)</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7"></a>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8"></a>        <span class="n">layer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">TransformerEncoderLayer</span><span class="p">(</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9"></a>            <span class="n">d_model</span><span class="o">=</span><span class="n">embed_dim</span><span class="p">,</span> <span class="n">nhead</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">dim_feedforward</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10"></a>            <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">norm_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.1</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11"></a>        <span class="p">)</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">TransformerEncoder</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="n">num_layers</span><span class="p">)</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">)</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14"></a>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tubelet_embed</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> 
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_embed</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18"></a>        <span class="n">B</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22"></a>        <span class="k">return</span> <span class="n">x</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="the-masking-the-game">The Masking: The Game</h3>
<p>This is critical. We randomly hide parts of the video to create a self-supervised learning task.</p>
<div class="admonition info">
<p class="admonition-title">The Rules</p>
<ul>
<li><strong>Context:</strong> The parts we <em>show</em> the model (The Clues).</li>
<li><strong>Target:</strong> The parts we <em>hide</em> and ask the model to guess (The Objective).</li>
</ul>
</div>
<p><strong>The Strategy:</strong></p>
<p>We use <strong>random masking</strong> for simplicity in this guide. This means we flip a coin for every tubelet to decide if it is visible or hidden.</p>
<div class="admonition tip">
<p class="admonition-title">Production: Hard Mode</p>
<p>In a full-scale production environment (like the real V-JEPA paper), they use <strong>"Block Masking"</strong>. </p>
<p>This involves hiding large, contiguous chunks of space-time (e.g., covering the entire right half of the video for 5 frames). This prevents the model from "cheating" by just interpolating from neighboring pixels and forces it to understand object permanence.</p>
</div>
<h3 id="the-predictor-the-dreamer">The Predictor: The "Dreamer"</h3>
<p>This is the hardest part to understand conceptually. The Predictor receives the <strong>Context</strong> (what it saw) and must output the <strong>Target</strong> (what was hidden).</p>
<div class="admonition question">
<p class="admonition-title">The Challenge</p>
<p>How does the Predictor know <em>which</em> part was hidden?</p>
<p>We cannot just give it a blank void. We must give it a <strong>Mask Token</strong> (a learnable placeholder) combined with the <strong>Target GPS</strong> (positional embedding).</p>
</div>
<h4 id="the-analogy">The Analogy</h4>
<p>To understand the flow, imagine a conversation between the components:</p>
<div class="admonition quote">
<p class="admonition-title">internal_monologue.log</p>
<p><strong>Encoder (The Eye):</strong></p>
<blockquote>
<p>"I see a ball at <strong>Time 1, Position A</strong>."</p>
</blockquote>
<p><strong>Predictor (The Dreamer) receives:</strong></p>
<blockquote>
<p>"Here is the embedding for the ball at Time 1.
Plus a <strong>[BLANK TILE]</strong> at <strong>Time 2, Position B</strong>.
Fill in the blank."</p>
</blockquote>
<p><strong>Predictor thinks:</strong></p>
<blockquote>
<p>"If the ball was at A at Time 1... physics says it must be at B at Time 2.
I will fill the blank with <strong>'Ball'</strong>."</p>
</blockquote>
</div>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">VideoPredictor.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-12-10">10</a></span>
<span class="normal"><a href="#__codelineno-12-11">11</a></span>
<span class="normal"><a href="#__codelineno-12-12">12</a></span>
<span class="normal"><a href="#__codelineno-12-13">13</a></span>
<span class="normal"><a href="#__codelineno-12-14">14</a></span>
<span class="normal"><a href="#__codelineno-12-15">15</a></span>
<span class="normal"><a href="#__codelineno-12-16">16</a></span>
<span class="normal"><a href="#__codelineno-12-17">17</a></span>
<span class="normal"><a href="#__codelineno-12-18">18</a></span>
<span class="normal"><a href="#__codelineno-12-19">19</a></span>
<span class="normal"><a href="#__codelineno-12-20">20</a></span>
<span class="normal"><a href="#__codelineno-12-21">21</a></span>
<span class="normal"><a href="#__codelineno-12-22">22</a></span>
<span class="normal"><a href="#__codelineno-12-23">23</a></span>
<span class="normal"><a href="#__codelineno-12-24">24</a></span>
<span class="normal"><a href="#__codelineno-12-25">25</a></span>
<span class="normal"><a href="#__codelineno-12-26">26</a></span>
<span class="normal"><a href="#__codelineno-12-27">27</a></span>
<span class="normal"><a href="#__codelineno-12-28">28</a></span>
<span class="normal"><a href="#__codelineno-12-29">29</a></span>
<span class="normal"><a href="#__codelineno-12-30">30</a></span>
<span class="normal"><a href="#__codelineno-12-31">31</a></span>
<span class="normal"><a href="#__codelineno-12-32">32</a></span>
<span class="normal"><a href="#__codelineno-12-33">33</a></span>
<span class="normal"><a href="#__codelineno-12-34">34</a></span>
<span class="normal"><a href="#__codelineno-12-35">35</a></span>
<span class="normal"><a href="#__codelineno-12-36">36</a></span>
<span class="normal"><a href="#__codelineno-12-37">37</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">VideoPredictor</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">embed_dim</span><span class="o">=</span><span class="mi">384</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span> <span class="o">=</span> <span class="n">embed_dim</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mask_token</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">embed_dim</span><span class="p">))</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6"></a>        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_token</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pos_embed</span> <span class="o">=</span> <span class="n">PositionalEmbedding</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">)</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8"></a>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9"></a>        <span class="n">layer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">TransformerEncoderLayer</span><span class="p">(</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10"></a>            <span class="n">d_model</span><span class="o">=</span><span class="n">embed_dim</span><span class="p">,</span> <span class="n">nhead</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">dim_feedforward</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11"></a>            <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">norm_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.1</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12"></a>        <span class="p">)</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">TransformerEncoder</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="n">num_layers</span><span class="p">)</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">)</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pred_head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">,</span> <span class="n">embed_dim</span><span class="p">)</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16"></a>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context_tokens</span><span class="p">,</span> <span class="n">context_idx</span><span class="p">,</span> <span class="n">target_idx</span><span class="p">,</span> <span class="n">num_tokens</span><span class="p">):</span>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18"></a>        <span class="n">B</span> <span class="o">=</span> <span class="n">context_tokens</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19"></a>        <span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span>
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20"></a>        <span class="n">T</span> <span class="o">=</span> <span class="n">num_tokens</span> <span class="o">//</span> <span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span>
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21"></a>
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22"></a>        <span class="n">time_embed_sliced</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_embed</span><span class="o">.</span><span class="n">time_embed</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">T</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23"></a>        <span class="n">full_pos</span> <span class="o">=</span> <span class="n">time_embed_sliced</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_embed</span><span class="o">.</span><span class="n">h_embed</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_embed</span><span class="o">.</span><span class="n">w_embed</span>
</span><span id="__span-12-24"><a id="__codelineno-12-24" name="__codelineno-12-24"></a>        <span class="n">full_pos</span> <span class="o">=</span> <span class="n">full_pos</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-12-25"><a id="__codelineno-12-25" name="__codelineno-12-25"></a>
</span><span id="__span-12-26"><a id="__codelineno-12-26" name="__codelineno-12-26"></a>        <span class="n">context_pos</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">full_pos</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">context_idx</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">D</span><span class="p">))</span>
</span><span id="__span-12-27"><a id="__codelineno-12-27" name="__codelineno-12-27"></a>        <span class="n">context_input</span> <span class="o">=</span> <span class="n">context_tokens</span> <span class="o">+</span> <span class="n">context_pos</span>
</span><span id="__span-12-28"><a id="__codelineno-12-28" name="__codelineno-12-28"></a>
</span><span id="__span-12-29"><a id="__codelineno-12-29" name="__codelineno-12-29"></a>        <span class="n">mask_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_token</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">target_idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-12-30"><a id="__codelineno-12-30" name="__codelineno-12-30"></a>        <span class="n">target_pos</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">full_pos</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">target_idx</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">D</span><span class="p">))</span>
</span><span id="__span-12-31"><a id="__codelineno-12-31" name="__codelineno-12-31"></a>        <span class="n">mask_input</span> <span class="o">=</span> <span class="n">mask_tokens</span> <span class="o">+</span> <span class="n">target_pos</span>
</span><span id="__span-12-32"><a id="__codelineno-12-32" name="__codelineno-12-32"></a>
</span><span id="__span-12-33"><a id="__codelineno-12-33" name="__codelineno-12-33"></a>        <span class="n">combined</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">context_input</span><span class="p">,</span> <span class="n">mask_input</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-12-34"><a id="__codelineno-12-34" name="__codelineno-12-34"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span>
</span><span id="__span-12-35"><a id="__codelineno-12-35" name="__codelineno-12-35"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-12-36"><a id="__codelineno-12-36" name="__codelineno-12-36"></a>
</span><span id="__span-12-37"><a id="__codelineno-12-37" name="__codelineno-12-37"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_head</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="o">-</span><span class="n">target_idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:])</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="checkpoint-understanding-the-flow">Checkpoint: Understanding the Flow</h2>
<p>Before we proceed, let's lock in the conceptual pipeline.</p>
<div class="admonition success">
<p class="admonition-title">The Logic Loop</p>
<p><strong>Do you see the big picture?</strong></p>
<ol>
<li><strong>Phase 1</strong> gave us the <strong>raw video</strong> (The Ground Truth).</li>
<li><strong>Phase 2 Encoder</strong> turns raw video into <strong>"meaningful vectors"</strong> (Embeddings).</li>
<li><strong>Phase 2 Masking</strong> hides some of these vectors (The Challenge).</li>
<li><strong>Phase 2 Predictor</strong> takes the visible vectors + <strong>"Mask Placeholders"</strong> and tries to <em>hallucinate</em> the hidden vectors.</li>
<li><strong>The Goal:</strong> If the predictor succeeds, it means it <strong>"understands"</strong> the physics of the video. </li>
</ol>
<p><em>(e.g., If it can accurately guess where the ball went without seeing it, it must understand velocity).</em></p>
</div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>[Phase 1: Raw Video]
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>       |
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>       | (Input)
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>       v
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>[Phase 2: Encoder]
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>       |
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>       | (All Embeddings)
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>       v
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>    {Masking} ------------------------.
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>       |                              |
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>       | (Visible Context)            | (Hidden Target)
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>       v                              v
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>[Phase 2: Predictor] &lt;========= [Target Vectors]
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>       ^                              ^
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>       |                              |
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>(Mask Placeholders)             (Loss Function)
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>       |                              |
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>[Predicted Vectors] ==================&#39;
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>       |
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a>       &#39;--&gt; (If match is good, Physics is learned)
</span></code></pre></div>
<h2 id="trainer">Trainer</h2>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">trainer.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-14-10">10</a></span>
<span class="normal"><a href="#__codelineno-14-11">11</a></span>
<span class="normal"><a href="#__codelineno-14-12">12</a></span>
<span class="normal"><a href="#__codelineno-14-13">13</a></span>
<span class="normal"><a href="#__codelineno-14-14">14</a></span>
<span class="normal"><a href="#__codelineno-14-15">15</a></span>
<span class="normal"><a href="#__codelineno-14-16">16</a></span>
<span class="normal"><a href="#__codelineno-14-17">17</a></span>
<span class="normal"><a href="#__codelineno-14-18">18</a></span>
<span class="normal"><a href="#__codelineno-14-19">19</a></span>
<span class="normal"><a href="#__codelineno-14-20">20</a></span>
<span class="normal"><a href="#__codelineno-14-21">21</a></span>
<span class="normal"><a href="#__codelineno-14-22">22</a></span>
<span class="normal"><a href="#__codelineno-14-23">23</a></span>
<span class="normal"><a href="#__codelineno-14-24">24</a></span>
<span class="normal"><a href="#__codelineno-14-25">25</a></span>
<span class="normal"><a href="#__codelineno-14-26">26</a></span>
<span class="normal"><a href="#__codelineno-14-27">27</a></span>
<span class="normal"><a href="#__codelineno-14-28">28</a></span>
<span class="normal"><a href="#__codelineno-14-29">29</a></span>
<span class="normal"><a href="#__codelineno-14-30">30</a></span>
<span class="normal"><a href="#__codelineno-14-31">31</a></span>
<span class="normal"><a href="#__codelineno-14-32">32</a></span>
<span class="normal"><a href="#__codelineno-14-33">33</a></span>
<span class="normal"><a href="#__codelineno-14-34">34</a></span>
<span class="normal"><a href="#__codelineno-14-35">35</a></span>
<span class="normal"><a href="#__codelineno-14-36">36</a></span>
<span class="normal"><a href="#__codelineno-14-37">37</a></span>
<span class="normal"><a href="#__codelineno-14-38">38</a></span>
<span class="normal"><a href="#__codelineno-14-39">39</a></span>
<span class="normal"><a href="#__codelineno-14-40">40</a></span>
<span class="normal"><a href="#__codelineno-14-41">41</a></span>
<span class="normal"><a href="#__codelineno-14-42">42</a></span>
<span class="normal"><a href="#__codelineno-14-43">43</a></span>
<span class="normal"><a href="#__codelineno-14-44">44</a></span>
<span class="normal"><a href="#__codelineno-14-45">45</a></span>
<span class="normal"><a href="#__codelineno-14-46">46</a></span>
<span class="normal"><a href="#__codelineno-14-47">47</a></span>
<span class="normal"><a href="#__codelineno-14-48">48</a></span>
<span class="normal"><a href="#__codelineno-14-49">49</a></span>
<span class="normal"><a href="#__codelineno-14-50">50</a></span>
<span class="normal"><a href="#__codelineno-14-51">51</a></span>
<span class="normal"><a href="#__codelineno-14-52">52</a></span>
<span class="normal"><a href="#__codelineno-14-53">53</a></span>
<span class="normal"><a href="#__codelineno-14-54">54</a></span>
<span class="normal"><a href="#__codelineno-14-55">55</a></span>
<span class="normal"><a href="#__codelineno-14-56">56</a></span>
<span class="normal"><a href="#__codelineno-14-57">57</a></span>
<span class="normal"><a href="#__codelineno-14-58">58</a></span>
<span class="normal"><a href="#__codelineno-14-59">59</a></span>
<span class="normal"><a href="#__codelineno-14-60">60</a></span>
<span class="normal"><a href="#__codelineno-14-61">61</a></span>
<span class="normal"><a href="#__codelineno-14-62">62</a></span>
<span class="normal"><a href="#__codelineno-14-63">63</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_lr_schedule</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">total_steps</span><span class="p">,</span> <span class="n">base_lr</span><span class="p">,</span> <span class="n">final_lr</span><span class="p">,</span> <span class="n">warmup_steps</span><span class="p">):</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2"></a>    <span class="k">if</span> <span class="n">step</span> <span class="o">&lt;</span> <span class="n">warmup_steps</span><span class="p">:</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3"></a>        <span class="k">return</span> <span class="n">base_lr</span> <span class="o">*</span> <span class="p">(</span><span class="n">step</span> <span class="o">/</span> <span class="n">warmup_steps</span><span class="p">)</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4"></a>    <span class="n">progress</span> <span class="o">=</span> <span class="p">(</span><span class="n">step</span> <span class="o">-</span> <span class="n">warmup_steps</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">total_steps</span> <span class="o">-</span> <span class="n">warmup_steps</span><span class="p">)</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5"></a>    <span class="n">cosine_decay</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">progress</span><span class="p">))</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6"></a>    <span class="k">return</span> <span class="n">final_lr</span> <span class="o">+</span> <span class="p">(</span><span class="n">base_lr</span> <span class="o">-</span> <span class="n">final_lr</span><span class="p">)</span> <span class="o">*</span> <span class="n">cosine_decay</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7"></a>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="k">def</span><span class="w"> </span><span class="nf">train_world_model</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">base_lr</span><span class="o">=</span><span class="mf">2e-4</span><span class="p">,</span> <span class="n">final_lr</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cuda&#39;</span><span class="p">):</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;STAGE 1: TRAINING V-JEPA&quot;</span><span class="p">)</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12"></a>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13"></a>    <span class="n">factory</span> <span class="o">=</span> <span class="n">MicroWorldFactory</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14"></a>    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">device</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15"></a>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16"></a>    <span class="n">student_enc</span> <span class="o">=</span> <span class="n">VideoEncoder</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17"></a>    <span class="n">student_pred</span> <span class="o">=</span> <span class="n">VideoPredictor</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18"></a>    <span class="n">teacher_enc</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">student_enc</span><span class="p">)</span>
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19"></a>    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">teacher_enc</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20"></a>
</span><span id="__span-14-21"><a id="__codelineno-14-21" name="__codelineno-14-21"></a>    <span class="n">params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">student_enc</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">student_pred</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
</span><span id="__span-14-22"><a id="__codelineno-14-22" name="__codelineno-14-22"></a>    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">base_lr</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
</span><span id="__span-14-23"><a id="__codelineno-14-23" name="__codelineno-14-23"></a>    <span class="n">loss_fn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
</span><span id="__span-14-24"><a id="__codelineno-14-24" name="__codelineno-14-24"></a>
</span><span id="__span-14-25"><a id="__codelineno-14-25" name="__codelineno-14-25"></a>    <span class="n">loss_history</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-14-26"><a id="__codelineno-14-26" name="__codelineno-14-26"></a>    <span class="n">num_tokens</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">16</span> 
</span><span id="__span-14-27"><a id="__codelineno-14-27" name="__codelineno-14-27"></a>
</span><span id="__span-14-28"><a id="__codelineno-14-28" name="__codelineno-14-28"></a>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
</span><span id="__span-14-29"><a id="__codelineno-14-29" name="__codelineno-14-29"></a>        <span class="n">videos</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">create_universe</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-14-30"><a id="__codelineno-14-30" name="__codelineno-14-30"></a>        <span class="n">n_context</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_tokens</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span> 
</span><span id="__span-14-31"><a id="__codelineno-14-31" name="__codelineno-14-31"></a>        <span class="n">perm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randperm</span><span class="p">(</span><span class="n">num_tokens</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-14-32"><a id="__codelineno-14-32" name="__codelineno-14-32"></a>        <span class="n">context_idx</span> <span class="o">=</span> <span class="n">perm</span><span class="p">[:</span><span class="n">n_context</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-14-33"><a id="__codelineno-14-33" name="__codelineno-14-33"></a>        <span class="n">target_idx</span> <span class="o">=</span> <span class="n">perm</span><span class="p">[</span><span class="n">n_context</span><span class="p">:]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-14-34"><a id="__codelineno-14-34" name="__codelineno-14-34"></a>
</span><span id="__span-14-35"><a id="__codelineno-14-35" name="__codelineno-14-35"></a>        <span class="n">lr</span> <span class="o">=</span> <span class="n">get_lr_schedule</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">epochs</span><span class="p">,</span> <span class="n">base_lr</span><span class="p">,</span> <span class="n">final_lr</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</span><span id="__span-14-36"><a id="__codelineno-14-36" name="__codelineno-14-36"></a>        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">:</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lr</span>
</span><span id="__span-14-37"><a id="__codelineno-14-37" name="__codelineno-14-37"></a>
</span><span id="__span-14-38"><a id="__codelineno-14-38" name="__codelineno-14-38"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="__span-14-39"><a id="__codelineno-14-39" name="__codelineno-14-39"></a>            <span class="n">teacher_out</span> <span class="o">=</span> <span class="n">teacher_enc</span><span class="p">(</span><span class="n">videos</span><span class="p">)</span>
</span><span id="__span-14-40"><a id="__codelineno-14-40" name="__codelineno-14-40"></a>            <span class="n">targets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">teacher_out</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">target_idx</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">384</span><span class="p">))</span>
</span><span id="__span-14-41"><a id="__codelineno-14-41" name="__codelineno-14-41"></a>            <span class="n">targets</span> <span class="o">=</span> <span class="p">(</span><span class="n">targets</span> <span class="o">-</span> <span class="n">targets</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">targets</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>
</span><span id="__span-14-42"><a id="__codelineno-14-42" name="__codelineno-14-42"></a>
</span><span id="__span-14-43"><a id="__codelineno-14-43" name="__codelineno-14-43"></a>        <span class="n">student_full</span> <span class="o">=</span> <span class="n">student_enc</span><span class="p">(</span><span class="n">videos</span><span class="p">)</span>
</span><span id="__span-14-44"><a id="__codelineno-14-44" name="__codelineno-14-44"></a>        <span class="n">context_tokens</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">student_full</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">context_idx</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">384</span><span class="p">))</span>
</span><span id="__span-14-45"><a id="__codelineno-14-45" name="__codelineno-14-45"></a>        <span class="n">predictions</span> <span class="o">=</span> <span class="n">student_pred</span><span class="p">(</span><span class="n">context_tokens</span><span class="p">,</span> <span class="n">context_idx</span><span class="p">,</span> <span class="n">target_idx</span><span class="p">,</span> <span class="n">num_tokens</span><span class="p">)</span>
</span><span id="__span-14-46"><a id="__codelineno-14-46" name="__codelineno-14-46"></a>
</span><span id="__span-14-47"><a id="__codelineno-14-47" name="__codelineno-14-47"></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
</span><span id="__span-14-48"><a id="__codelineno-14-48" name="__codelineno-14-48"></a>
</span><span id="__span-14-49"><a id="__codelineno-14-49" name="__codelineno-14-49"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="__span-14-50"><a id="__codelineno-14-50" name="__codelineno-14-50"></a>        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="__span-14-51"><a id="__codelineno-14-51" name="__codelineno-14-51"></a>        <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
</span><span id="__span-14-52"><a id="__codelineno-14-52" name="__codelineno-14-52"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="__span-14-53"><a id="__codelineno-14-53" name="__codelineno-14-53"></a>
</span><span id="__span-14-54"><a id="__codelineno-14-54" name="__codelineno-14-54"></a>        <span class="n">ema_decay</span> <span class="o">=</span> <span class="mf">0.996</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.9995</span> <span class="o">-</span> <span class="mf">0.996</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">/</span> <span class="n">epochs</span><span class="p">)</span>
</span><span id="__span-14-55"><a id="__codelineno-14-55" name="__codelineno-14-55"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="__span-14-56"><a id="__codelineno-14-56" name="__codelineno-14-56"></a>            <span class="k">for</span> <span class="n">t_p</span><span class="p">,</span> <span class="n">s_p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">teacher_enc</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">student_enc</span><span class="o">.</span><span class="n">parameters</span><span class="p">()):</span>
</span><span id="__span-14-57"><a id="__codelineno-14-57" name="__codelineno-14-57"></a>                <span class="n">t_p</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">ema_decay</span><span class="p">)</span><span class="o">.</span><span class="n">add_</span><span class="p">(</span><span class="n">s_p</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ema_decay</span><span class="p">)</span>
</span><span id="__span-14-58"><a id="__codelineno-14-58" name="__codelineno-14-58"></a>
</span><span id="__span-14-59"><a id="__codelineno-14-59" name="__codelineno-14-59"></a>        <span class="n">loss_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="__span-14-60"><a id="__codelineno-14-60" name="__codelineno-14-60"></a>        <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-14-61"><a id="__codelineno-14-61" name="__codelineno-14-61"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">epochs</span><span class="si">}</span><span class="s2"> | Loss: </span><span class="si">{</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> | LR: </span><span class="si">{</span><span class="n">lr</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-14-62"><a id="__codelineno-14-62" name="__codelineno-14-62"></a>
</span><span id="__span-14-63"><a id="__codelineno-14-63" name="__codelineno-14-63"></a>    <span class="k">return</span> <span class="n">student_enc</span><span class="p">,</span> <span class="n">teacher_enc</span>
</span></code></pre></div></td></tr></table></div>
<h1 id="congratulations">Congratulations!</h1>
<p>You now have a trained V-JEPA. But we have a problem: We cannot ‚Äúsee‚Äù what the model is thinking.
The model outputs a list of abstract vectors (embeddings). It doesn‚Äôt output an image. How do we prove it
actually understands physics?
We give it a Final Exam.
We will use a technique called Linear Probing.
Freeze the Brain: We lock the weights of your trained model. It is not allowed to learn anymore.
The Question: We ask it: ‚ÄúBased on these numbers you are thinking, where is the digit?‚Äù
The Test: We train a tiny, single-layer neural network (a Linear Layer) to answer this.
If this tiny layer can extract the correct (x, y) coordinates from your embeddings, it proves your model
has successfully learned the concept of ‚ÄúPosition‚Äù and ‚ÄúVelocity‚Äù purely from watching videos.</p>
<p>Before running the full exam, let‚Äôs look at the ‚ÄúEye‚Äù of the model (the first Convolutional layer).
Good Result: The filters look like gradients, edges, or moving blobs.
Bad Result: The filters look like random TV static (noise).
Run this code to inspect your trained model:</p>
<h3 id="visualizing-the-learned-eye">Visualizing the Learned Eye</h3>
<p>How do we know the model is actually learning? One of the best sanity checks in Deep Learning is to inspect the <strong>first-layer filters</strong>.</p>
<p>If the filters look like random static (noise), the model hasn't learned anything. If they look like <strong>edges, curves, or textures</strong> (Gabor filters), the model is beginning to "see."</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">neuroscope.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-15-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-15-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-15-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-15-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-15-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-15-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-15-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-15-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-15-10">10</a></span>
<span class="normal"><a href="#__codelineno-15-11">11</a></span>
<span class="normal"><a href="#__codelineno-15-12">12</a></span>
<span class="normal"><a href="#__codelineno-15-13">13</a></span>
<span class="normal"><a href="#__codelineno-15-14">14</a></span>
<span class="normal"><a href="#__codelineno-15-15">15</a></span>
<span class="normal"><a href="#__codelineno-15-16">16</a></span>
<span class="normal"><a href="#__codelineno-15-17">17</a></span>
<span class="normal"><a href="#__codelineno-15-18">18</a></span>
<span class="normal"><a href="#__codelineno-15-19">19</a></span>
<span class="normal"><a href="#__codelineno-15-20">20</a></span>
<span class="normal"><a href="#__codelineno-15-21">21</a></span>
<span class="normal"><a href="#__codelineno-15-22">22</a></span>
<span class="normal"><a href="#__codelineno-15-23">23</a></span>
<span class="normal"><a href="#__codelineno-15-24">24</a></span>
<span class="normal"><a href="#__codelineno-15-25">25</a></span>
<span class="normal"><a href="#__codelineno-15-26">26</a></span>
<span class="normal"><a href="#__codelineno-15-27">27</a></span>
<span class="normal"><a href="#__codelineno-15-28">28</a></span>
<span class="normal"><a href="#__codelineno-15-29">29</a></span>
<span class="normal"><a href="#__codelineno-15-30">30</a></span>
<span class="normal"><a href="#__codelineno-15-31">31</a></span>
<span class="normal"><a href="#__codelineno-15-32">32</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2"></a>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">visualize_filters</span><span class="p">(</span><span class="n">encoder</span><span class="p">):</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4"></a>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5"></a>    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="s1">&#39;patch_embed&#39;</span><span class="p">):</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6"></a>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7"></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">patch_embed</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8"></a>    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="s1">&#39;embed&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">encoder</span><span class="o">.</span><span class="n">embed</span><span class="p">,</span> <span class="s1">&#39;proj&#39;</span><span class="p">):</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9"></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">embed</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not find the Conv3d layer. Printing structure:&quot;</span><span class="p">)</span>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">encoder</span><span class="p">)</span>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13"></a>        <span class="k">return</span>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14"></a>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Visualizing filters from layer shape: </span><span class="si">{</span><span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16"></a>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17"></a>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18"></a>    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19"></a>
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">):</span>
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21"></a>        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> 
</span><span id="__span-15-22"><a id="__codelineno-15-22" name="__codelineno-15-22"></a>            <span class="k">break</span>
</span><span id="__span-15-23"><a id="__codelineno-15-23" name="__codelineno-15-23"></a>        <span class="n">f</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="__span-15-24"><a id="__codelineno-15-24" name="__codelineno-15-24"></a>
</span><span id="__span-15-25"><a id="__codelineno-15-25" name="__codelineno-15-25"></a>        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
</span><span id="__span-15-26"><a id="__codelineno-15-26" name="__codelineno-15-26"></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="__span-15-27"><a id="__codelineno-15-27" name="__codelineno-15-27"></a>
</span><span id="__span-15-28"><a id="__codelineno-15-28" name="__codelineno-15-28"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;First 16 Filters (The &#39;Eye&#39; of the Model)&quot;</span><span class="p">)</span>
</span><span id="__span-15-29"><a id="__codelineno-15-29" name="__codelineno-15-29"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="__span-15-30"><a id="__codelineno-15-30" name="__codelineno-15-30"></a>
</span><span id="__span-15-31"><a id="__codelineno-15-31" name="__codelineno-15-31"></a><span class="c1"># Usage Check:</span>
</span><span id="__span-15-32"><a id="__codelineno-15-32" name="__codelineno-15-32"></a><span class="c1"># visualize_filters(student_enc)</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="the-final-exam-linear-probe-code">The Final Exam (Linear Probe Code)</h2>
<p>We need to modify our Factory to give us the <strong>Answers</strong> (the actual coordinates) so we can grade the exam.</p>
<h3 id="what-is-linear-probing">What is Linear Probing?</h3>
<p>Linear Probing is the standard way to evaluate Self-Supervised Learning (SSL) models. Think of it as a <strong>Standardized Test</strong> for your AI.</p>
<ol>
<li><strong>The Student (Your Encoder):</strong> We take your trained World Model and <strong>freeze</strong> its weights. It is not allowed to learn anymore. It can only "see" and describe what it sees.</li>
<li><strong>The Exam (The Probe):</strong> We attach a tiny, simple neural network (a few linear layers) on top of the frozen Encoder.</li>
<li><strong>The Subject:</strong> We ask the Probe to solve a specific task using <em>only</em> the descriptions provided by the Student.</li>
</ol>
<div class="admonition success">
<p class="admonition-title">The Logic</p>
<p>If the tiny Probe can predict the exact pixel coordinates of the digit, it proves that the <strong>frozen Encoder</strong> must have learned the concept of "Position" inside its embeddings. </p>
<p>If the Encoder output was just random noise, the Probe would fail.</p>
</div>
<hr />
<h3 id="the-code-implementation">The Code Implementation</h3>
<p>Copy and run this entire block. It will generate a new test set, extract features using your frozen model, and train the probe.</p>
<div class="admonition warning">
<p class="admonition-title">Implementation Note</p>
<p>This code is a <strong>template</strong>. Depending on your specific <code>embed_dim</code>, <code>seq_len</code>, or <code>patch_size</code> settings from Phase 2, you may need to tweak the dimension reshaping in <code>extract_features</code> (specifically the <code>.view()</code> shapes).</p>
<p>Ensure the <code>input_dim</code> of the probe matches the output dimension of your specific Encoder.</p>
</div>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">linear_probe.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1">  1</a></span>
<span class="normal"><a href="#__codelineno-16-2">  2</a></span>
<span class="normal"><a href="#__codelineno-16-3">  3</a></span>
<span class="normal"><a href="#__codelineno-16-4">  4</a></span>
<span class="normal"><a href="#__codelineno-16-5">  5</a></span>
<span class="normal"><a href="#__codelineno-16-6">  6</a></span>
<span class="normal"><a href="#__codelineno-16-7">  7</a></span>
<span class="normal"><a href="#__codelineno-16-8">  8</a></span>
<span class="normal"><a href="#__codelineno-16-9">  9</a></span>
<span class="normal"><a href="#__codelineno-16-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-16-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-16-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-16-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-16-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-16-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-16-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-16-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-16-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-16-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-16-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-16-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-16-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-16-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-16-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-16-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-16-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-16-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-16-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-16-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-16-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-16-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-16-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-16-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-16-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-16-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-16-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-16-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-16-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-16-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-16-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-16-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-16-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-16-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-16-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-16-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-16-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-16-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-16-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-16-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-16-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-16-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-16-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-16-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-16-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-16-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-16-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-16-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-16-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-16-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-16-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-16-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-16-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-16-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-16-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-16-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-16-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-16-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-16-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-16-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-16-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-16-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-16-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-16-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-16-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-16-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-16-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-16-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-16-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-16-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-16-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-16-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-16-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-16-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-16-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-16-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-16-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-16-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-16-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-16-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-16-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-16-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-16-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-16-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-16-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-16-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-16-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-16-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-16-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-16-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-16-100">100</a></span>
<span class="normal"><a href="#__codelineno-16-101">101</a></span>
<span class="normal"><a href="#__codelineno-16-102">102</a></span>
<span class="normal"><a href="#__codelineno-16-103">103</a></span>
<span class="normal"><a href="#__codelineno-16-104">104</a></span>
<span class="normal"><a href="#__codelineno-16-105">105</a></span>
<span class="normal"><a href="#__codelineno-16-106">106</a></span>
<span class="normal"><a href="#__codelineno-16-107">107</a></span>
<span class="normal"><a href="#__codelineno-16-108">108</a></span>
<span class="normal"><a href="#__codelineno-16-109">109</a></span>
<span class="normal"><a href="#__codelineno-16-110">110</a></span>
<span class="normal"><a href="#__codelineno-16-111">111</a></span>
<span class="normal"><a href="#__codelineno-16-112">112</a></span>
<span class="normal"><a href="#__codelineno-16-113">113</a></span>
<span class="normal"><a href="#__codelineno-16-114">114</a></span>
<span class="normal"><a href="#__codelineno-16-115">115</a></span>
<span class="normal"><a href="#__codelineno-16-116">116</a></span>
<span class="normal"><a href="#__codelineno-16-117">117</a></span>
<span class="normal"><a href="#__codelineno-16-118">118</a></span>
<span class="normal"><a href="#__codelineno-16-119">119</a></span>
<span class="normal"><a href="#__codelineno-16-120">120</a></span>
<span class="normal"><a href="#__codelineno-16-121">121</a></span>
<span class="normal"><a href="#__codelineno-16-122">122</a></span>
<span class="normal"><a href="#__codelineno-16-123">123</a></span>
<span class="normal"><a href="#__codelineno-16-124">124</a></span>
<span class="normal"><a href="#__codelineno-16-125">125</a></span>
<span class="normal"><a href="#__codelineno-16-126">126</a></span>
<span class="normal"><a href="#__codelineno-16-127">127</a></span>
<span class="normal"><a href="#__codelineno-16-128">128</a></span>
<span class="normal"><a href="#__codelineno-16-129">129</a></span>
<span class="normal"><a href="#__codelineno-16-130">130</a></span>
<span class="normal"><a href="#__codelineno-16-131">131</a></span>
<span class="normal"><a href="#__codelineno-16-132">132</a></span>
<span class="normal"><a href="#__codelineno-16-133">133</a></span>
<span class="normal"><a href="#__codelineno-16-134">134</a></span>
<span class="normal"><a href="#__codelineno-16-135">135</a></span>
<span class="normal"><a href="#__codelineno-16-136">136</a></span>
<span class="normal"><a href="#__codelineno-16-137">137</a></span>
<span class="normal"><a href="#__codelineno-16-138">138</a></span>
<span class="normal"><a href="#__codelineno-16-139">139</a></span>
<span class="normal"><a href="#__codelineno-16-140">140</a></span>
<span class="normal"><a href="#__codelineno-16-141">141</a></span>
<span class="normal"><a href="#__codelineno-16-142">142</a></span>
<span class="normal"><a href="#__codelineno-16-143">143</a></span>
<span class="normal"><a href="#__codelineno-16-144">144</a></span>
<span class="normal"><a href="#__codelineno-16-145">145</a></span>
<span class="normal"><a href="#__codelineno-16-146">146</a></span>
<span class="normal"><a href="#__codelineno-16-147">147</a></span>
<span class="normal"><a href="#__codelineno-16-148">148</a></span>
<span class="normal"><a href="#__codelineno-16-149">149</a></span>
<span class="normal"><a href="#__codelineno-16-150">150</a></span>
<span class="normal"><a href="#__codelineno-16-151">151</a></span>
<span class="normal"><a href="#__codelineno-16-152">152</a></span>
<span class="normal"><a href="#__codelineno-16-153">153</a></span>
<span class="normal"><a href="#__codelineno-16-154">154</a></span>
<span class="normal"><a href="#__codelineno-16-155">155</a></span>
<span class="normal"><a href="#__codelineno-16-156">156</a></span>
<span class="normal"><a href="#__codelineno-16-157">157</a></span>
<span class="normal"><a href="#__codelineno-16-158">158</a></span>
<span class="normal"><a href="#__codelineno-16-159">159</a></span>
<span class="normal"><a href="#__codelineno-16-160">160</a></span>
<span class="normal"><a href="#__codelineno-16-161">161</a></span>
<span class="normal"><a href="#__codelineno-16-162">162</a></span>
<span class="normal"><a href="#__codelineno-16-163">163</a></span>
<span class="normal"><a href="#__codelineno-16-164">164</a></span>
<span class="normal"><a href="#__codelineno-16-165">165</a></span>
<span class="normal"><a href="#__codelineno-16-166">166</a></span>
<span class="normal"><a href="#__codelineno-16-167">167</a></span>
<span class="normal"><a href="#__codelineno-16-168">168</a></span>
<span class="normal"><a href="#__codelineno-16-169">169</a></span>
<span class="normal"><a href="#__codelineno-16-170">170</a></span>
<span class="normal"><a href="#__codelineno-16-171">171</a></span>
<span class="normal"><a href="#__codelineno-16-172">172</a></span>
<span class="normal"><a href="#__codelineno-16-173">173</a></span>
<span class="normal"><a href="#__codelineno-16-174">174</a></span>
<span class="normal"><a href="#__codelineno-16-175">175</a></span>
<span class="normal"><a href="#__codelineno-16-176">176</a></span>
<span class="normal"><a href="#__codelineno-16-177">177</a></span>
<span class="normal"><a href="#__codelineno-16-178">178</a></span>
<span class="normal"><a href="#__codelineno-16-179">179</a></span>
<span class="normal"><a href="#__codelineno-16-180">180</a></span>
<span class="normal"><a href="#__codelineno-16-181">181</a></span>
<span class="normal"><a href="#__codelineno-16-182">182</a></span>
<span class="normal"><a href="#__codelineno-16-183">183</a></span>
<span class="normal"><a href="#__codelineno-16-184">184</a></span>
<span class="normal"><a href="#__codelineno-16-185">185</a></span>
<span class="normal"><a href="#__codelineno-16-186">186</a></span>
<span class="normal"><a href="#__codelineno-16-187">187</a></span>
<span class="normal"><a href="#__codelineno-16-188">188</a></span>
<span class="normal"><a href="#__codelineno-16-189">189</a></span>
<span class="normal"><a href="#__codelineno-16-190">190</a></span>
<span class="normal"><a href="#__codelineno-16-191">191</a></span>
<span class="normal"><a href="#__codelineno-16-192">192</a></span>
<span class="normal"><a href="#__codelineno-16-193">193</a></span>
<span class="normal"><a href="#__codelineno-16-194">194</a></span>
<span class="normal"><a href="#__codelineno-16-195">195</a></span>
<span class="normal"><a href="#__codelineno-16-196">196</a></span>
<span class="normal"><a href="#__codelineno-16-197">197</a></span>
<span class="normal"><a href="#__codelineno-16-198">198</a></span>
<span class="normal"><a href="#__codelineno-16-199">199</a></span>
<span class="normal"><a href="#__codelineno-16-200">200</a></span>
<span class="normal"><a href="#__codelineno-16-201">201</a></span>
<span class="normal"><a href="#__codelineno-16-202">202</a></span>
<span class="normal"><a href="#__codelineno-16-203">203</a></span>
<span class="normal"><a href="#__codelineno-16-204">204</a></span>
<span class="normal"><a href="#__codelineno-16-205">205</a></span>
<span class="normal"><a href="#__codelineno-16-206">206</a></span>
<span class="normal"><a href="#__codelineno-16-207">207</a></span>
<span class="normal"><a href="#__codelineno-16-208">208</a></span>
<span class="normal"><a href="#__codelineno-16-209">209</a></span>
<span class="normal"><a href="#__codelineno-16-210">210</a></span>
<span class="normal"><a href="#__codelineno-16-211">211</a></span>
<span class="normal"><a href="#__codelineno-16-212">212</a></span>
<span class="normal"><a href="#__codelineno-16-213">213</a></span>
<span class="normal"><a href="#__codelineno-16-214">214</a></span>
<span class="normal"><a href="#__codelineno-16-215">215</a></span>
<span class="normal"><a href="#__codelineno-16-216">216</a></span>
<span class="normal"><a href="#__codelineno-16-217">217</a></span>
<span class="normal"><a href="#__codelineno-16-218">218</a></span>
<span class="normal"><a href="#__codelineno-16-219">219</a></span>
<span class="normal"><a href="#__codelineno-16-220">220</a></span>
<span class="normal"><a href="#__codelineno-16-221">221</a></span>
<span class="normal"><a href="#__codelineno-16-222">222</a></span>
<span class="normal"><a href="#__codelineno-16-223">223</a></span>
<span class="normal"><a href="#__codelineno-16-224">224</a></span>
<span class="normal"><a href="#__codelineno-16-225">225</a></span>
<span class="normal"><a href="#__codelineno-16-226">226</a></span>
<span class="normal"><a href="#__codelineno-16-227">227</a></span>
<span class="normal"><a href="#__codelineno-16-228">228</a></span>
<span class="normal"><a href="#__codelineno-16-229">229</a></span>
<span class="normal"><a href="#__codelineno-16-230">230</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.optim</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">optim</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">TensorDataset</span><span class="p">,</span> <span class="n">DataLoader</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7"></a>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8"></a><span class="c1"># ---------------------------------------------------------</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9"></a><span class="c1"># 1. GENERATE EXAM QUESTIONS (Labeled Data)</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10"></a><span class="c1"># ---------------------------------------------------------</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_labeled_dataset</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">img_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">digit_size</span><span class="o">=</span><span class="mi">28</span><span class="p">):</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; Generate dataset with NORMALIZED position labels &quot;&quot;&quot;</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13"></a>    <span class="c1"># Initialize factory with batch_size=1 for individual generation</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14"></a>    <span class="n">factory</span> <span class="o">=</span> <span class="n">MicroWorldFactory</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15"></a>    <span class="n">videos</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16"></a>    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-16-17"><a id="__codelineno-16-17" name="__codelineno-16-17"></a>
</span><span id="__span-16-18"><a id="__codelineno-16-18" name="__codelineno-16-18"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating </span><span class="si">{</span><span class="n">n_samples</span><span class="si">}</span><span class="s2"> labeled videos...&quot;</span><span class="p">)</span>
</span><span id="__span-16-19"><a id="__codelineno-16-19" name="__codelineno-16-19"></a>
</span><span id="__span-16-20"><a id="__codelineno-16-20" name="__codelineno-16-20"></a>    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">):</span>
</span><span id="__span-16-21"><a id="__codelineno-16-21" name="__codelineno-16-21"></a>        <span class="n">video</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">img_size</span><span class="p">,</span> <span class="n">img_size</span><span class="p">)</span>
</span><span id="__span-16-22"><a id="__codelineno-16-22" name="__codelineno-16-22"></a>
</span><span id="__span-16-23"><a id="__codelineno-16-23" name="__codelineno-16-23"></a>        <span class="c1"># Random Physics Initialization</span>
</span><span id="__span-16-24"><a id="__codelineno-16-24" name="__codelineno-16-24"></a>        <span class="n">pos</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">img_size</span> <span class="o">-</span> <span class="n">digit_size</span><span class="p">)</span>
</span><span id="__span-16-25"><a id="__codelineno-16-25" name="__codelineno-16-25"></a>        <span class="n">angle</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
</span><span id="__span-16-26"><a id="__codelineno-16-26" name="__codelineno-16-26"></a>        <span class="n">vel</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="__span-16-27"><a id="__codelineno-16-27" name="__codelineno-16-27"></a>        <span class="n">digit</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">factory</span><span class="o">.</span><span class="n">atoms</span><span class="p">))]</span>
</span><span id="__span-16-28"><a id="__codelineno-16-28" name="__codelineno-16-28"></a>
</span><span id="__span-16-29"><a id="__codelineno-16-29" name="__codelineno-16-29"></a>        <span class="c1"># Simulation Loop (Identical to Factory)</span>
</span><span id="__span-16-30"><a id="__codelineno-16-30" name="__codelineno-16-30"></a>        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
</span><span id="__span-16-31"><a id="__codelineno-16-31" name="__codelineno-16-31"></a>            <span class="n">r</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">int</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="__span-16-32"><a id="__codelineno-16-32" name="__codelineno-16-32"></a>            <span class="n">r</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">img_size</span> <span class="o">-</span> <span class="n">digit_size</span><span class="p">))</span>
</span><span id="__span-16-33"><a id="__codelineno-16-33" name="__codelineno-16-33"></a>            <span class="n">c</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">img_size</span> <span class="o">-</span> <span class="n">digit_size</span><span class="p">))</span>
</span><span id="__span-16-34"><a id="__codelineno-16-34" name="__codelineno-16-34"></a>            <span class="n">video</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r</span> <span class="p">:</span> <span class="n">r</span> <span class="o">+</span> <span class="n">digit_size</span><span class="p">,</span> <span class="n">c</span> <span class="p">:</span> <span class="n">c</span> <span class="o">+</span> <span class="n">digit_size</span><span class="p">]</span> <span class="o">=</span> <span class="n">digit</span>
</span><span id="__span-16-35"><a id="__codelineno-16-35" name="__codelineno-16-35"></a>
</span><span id="__span-16-36"><a id="__codelineno-16-36" name="__codelineno-16-36"></a>            <span class="c1"># Update Physics</span>
</span><span id="__span-16-37"><a id="__codelineno-16-37" name="__codelineno-16-37"></a>            <span class="n">pos</span> <span class="o">+=</span> <span class="n">vel</span> <span class="o">*</span> <span class="mf">3.0</span>
</span><span id="__span-16-38"><a id="__codelineno-16-38" name="__codelineno-16-38"></a>            <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">img_size</span> <span class="o">-</span> <span class="n">digit_size</span><span class="p">):</span>
</span><span id="__span-16-39"><a id="__codelineno-16-39" name="__codelineno-16-39"></a>                <span class="n">vel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="__span-16-40"><a id="__codelineno-16-40" name="__codelineno-16-40"></a>                <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">img_size</span> <span class="o">-</span> <span class="n">digit_size</span><span class="p">)</span>
</span><span id="__span-16-41"><a id="__codelineno-16-41" name="__codelineno-16-41"></a>            <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">img_size</span> <span class="o">-</span> <span class="n">digit_size</span><span class="p">):</span>
</span><span id="__span-16-42"><a id="__codelineno-16-42" name="__codelineno-16-42"></a>                <span class="n">vel</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="__span-16-43"><a id="__codelineno-16-43" name="__codelineno-16-43"></a>                <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">img_size</span> <span class="o">-</span> <span class="n">digit_size</span><span class="p">)</span>
</span><span id="__span-16-44"><a id="__codelineno-16-44" name="__codelineno-16-44"></a>
</span><span id="__span-16-45"><a id="__codelineno-16-45" name="__codelineno-16-45"></a>        <span class="n">videos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">video</span><span class="p">)</span>
</span><span id="__span-16-46"><a id="__codelineno-16-46" name="__codelineno-16-46"></a>
</span><span id="__span-16-47"><a id="__codelineno-16-47" name="__codelineno-16-47"></a>        <span class="c1"># Label: Center position of the digit at the last frame?</span>
</span><span id="__span-16-48"><a id="__codelineno-16-48" name="__codelineno-16-48"></a>        <span class="c1"># Or trajectory? Here we label the *current* position (t=0 start or t=end?)</span>
</span><span id="__span-16-49"><a id="__codelineno-16-49" name="__codelineno-16-49"></a>        <span class="c1"># NOTE: The loop updates pos *after* drawing. </span>
</span><span id="__span-16-50"><a id="__codelineno-16-50" name="__codelineno-16-50"></a>        <span class="c1"># So &#39;pos&#39; is the state at t+1. We usually want the final visible state.</span>
</span><span id="__span-16-51"><a id="__codelineno-16-51" name="__codelineno-16-51"></a>
</span><span id="__span-16-52"><a id="__codelineno-16-52" name="__codelineno-16-52"></a>        <span class="n">center_pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">digit_size</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="__span-16-53"><a id="__codelineno-16-53" name="__codelineno-16-53"></a>        <span class="n">normalized_pos</span> <span class="o">=</span> <span class="n">center_pos</span> <span class="o">/</span> <span class="n">img_size</span>
</span><span id="__span-16-54"><a id="__codelineno-16-54" name="__codelineno-16-54"></a>        <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalized_pos</span><span class="p">)</span>
</span><span id="__span-16-55"><a id="__codelineno-16-55" name="__codelineno-16-55"></a>
</span><span id="__span-16-56"><a id="__codelineno-16-56" name="__codelineno-16-56"></a>    <span class="c1"># Stack and Normalization</span>
</span><span id="__span-16-57"><a id="__codelineno-16-57" name="__codelineno-16-57"></a>    <span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">videos</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="c1"># [B, C, T, H, W]</span>
</span><span id="__span-16-58"><a id="__codelineno-16-58" name="__codelineno-16-58"></a>    <span class="n">X</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.0</span>
</span><span id="__span-16-59"><a id="__codelineno-16-59" name="__codelineno-16-59"></a>    <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
</span><span id="__span-16-60"><a id="__codelineno-16-60" name="__codelineno-16-60"></a>
</span><span id="__span-16-61"><a id="__codelineno-16-61" name="__codelineno-16-61"></a>    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span>
</span><span id="__span-16-62"><a id="__codelineno-16-62" name="__codelineno-16-62"></a>
</span><span id="__span-16-63"><a id="__codelineno-16-63" name="__codelineno-16-63"></a><span class="c1"># ---------------------------------------------------------</span>
</span><span id="__span-16-64"><a id="__codelineno-16-64" name="__codelineno-16-64"></a><span class="c1"># 2. THE PROBE (Tiny Neural Network)</span>
</span><span id="__span-16-65"><a id="__codelineno-16-65" name="__codelineno-16-65"></a><span class="c1"># ---------------------------------------------------------</span>
</span><span id="__span-16-66"><a id="__codelineno-16-66" name="__codelineno-16-66"></a><span class="k">class</span><span class="w"> </span><span class="nc">MLPProbe</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-16-67"><a id="__codelineno-16-67" name="__codelineno-16-67"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; Probe to predict normalized positions from embeddings &quot;&quot;&quot;</span>
</span><span id="__span-16-68"><a id="__codelineno-16-68" name="__codelineno-16-68"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dim</span><span class="o">=</span><span class="mi">384</span><span class="p">,</span> <span class="n">output_dim</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
</span><span id="__span-16-69"><a id="__codelineno-16-69" name="__codelineno-16-69"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-16-70"><a id="__codelineno-16-70" name="__codelineno-16-70"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span><span id="__span-16-71"><a id="__codelineno-16-71" name="__codelineno-16-71"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span>
</span><span id="__span-16-72"><a id="__codelineno-16-72" name="__codelineno-16-72"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
</span><span id="__span-16-73"><a id="__codelineno-16-73" name="__codelineno-16-73"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
</span><span id="__span-16-74"><a id="__codelineno-16-74" name="__codelineno-16-74"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span>
</span><span id="__span-16-75"><a id="__codelineno-16-75" name="__codelineno-16-75"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
</span><span id="__span-16-76"><a id="__codelineno-16-76" name="__codelineno-16-76"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
</span><span id="__span-16-77"><a id="__codelineno-16-77" name="__codelineno-16-77"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
</span><span id="__span-16-78"><a id="__codelineno-16-78" name="__codelineno-16-78"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">),</span>
</span><span id="__span-16-79"><a id="__codelineno-16-79" name="__codelineno-16-79"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span> <span class="c1"># Bound output to [0, 1] for normalized coords</span>
</span><span id="__span-16-80"><a id="__codelineno-16-80" name="__codelineno-16-80"></a>        <span class="p">)</span>
</span><span id="__span-16-81"><a id="__codelineno-16-81" name="__codelineno-16-81"></a>
</span><span id="__span-16-82"><a id="__codelineno-16-82" name="__codelineno-16-82"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-16-83"><a id="__codelineno-16-83" name="__codelineno-16-83"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-16-84"><a id="__codelineno-16-84" name="__codelineno-16-84"></a>
</span><span id="__span-16-85"><a id="__codelineno-16-85" name="__codelineno-16-85"></a><span class="c1"># ---------------------------------------------------------</span>
</span><span id="__span-16-86"><a id="__codelineno-16-86" name="__codelineno-16-86"></a><span class="c1"># 3. FEATURE EXTRACTION (The Frozen Encoder)</span>
</span><span id="__span-16-87"><a id="__codelineno-16-87" name="__codelineno-16-87"></a><span class="c1"># ---------------------------------------------------------</span>
</span><span id="__span-16-88"><a id="__codelineno-16-88" name="__codelineno-16-88"></a><span class="k">def</span><span class="w"> </span><span class="nf">extract_features</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">data_tensor</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">embed_dim</span><span class="o">=</span><span class="mi">384</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
</span><span id="__span-16-89"><a id="__codelineno-16-89" name="__codelineno-16-89"></a>
</span><span id="__span-16-90"><a id="__codelineno-16-90" name="__codelineno-16-90"></a>    <span class="n">encoder</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="__span-16-91"><a id="__codelineno-16-91" name="__codelineno-16-91"></a>    <span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">TensorDataset</span><span class="p">(</span><span class="n">data_tensor</span><span class="p">),</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="__span-16-92"><a id="__codelineno-16-92" name="__codelineno-16-92"></a>    <span class="n">all_features</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-16-93"><a id="__codelineno-16-93" name="__codelineno-16-93"></a>
</span><span id="__span-16-94"><a id="__codelineno-16-94" name="__codelineno-16-94"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracting features from </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data_tensor</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples...&quot;</span><span class="p">)</span>
</span><span id="__span-16-95"><a id="__codelineno-16-95" name="__codelineno-16-95"></a>
</span><span id="__span-16-96"><a id="__codelineno-16-96" name="__codelineno-16-96"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="__span-16-97"><a id="__codelineno-16-97" name="__codelineno-16-97"></a>        <span class="k">for</span> <span class="p">(</span><span class="n">batch_x</span><span class="p">,)</span> <span class="ow">in</span> <span class="n">loader</span><span class="p">:</span>
</span><span id="__span-16-98"><a id="__codelineno-16-98" name="__codelineno-16-98"></a>            <span class="n">batch_x</span> <span class="o">=</span> <span class="n">batch_x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-16-99"><a id="__codelineno-16-99" name="__codelineno-16-99"></a>
</span><span id="__span-16-100"><a id="__codelineno-16-100" name="__codelineno-16-100"></a>            <span class="c1"># Use only first 15 frames if predicting 16th? </span>
</span><span id="__span-16-101"><a id="__codelineno-16-101" name="__codelineno-16-101"></a>            <span class="c1"># Or use full context. Adapting to input shape:</span>
</span><span id="__span-16-102"><a id="__codelineno-16-102" name="__codelineno-16-102"></a>            <span class="n">batch_x_partial</span> <span class="o">=</span> <span class="n">batch_x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">15</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> 
</span><span id="__span-16-103"><a id="__codelineno-16-103" name="__codelineno-16-103"></a>
</span><span id="__span-16-104"><a id="__codelineno-16-104" name="__codelineno-16-104"></a>            <span class="c1"># Pass through Frozen Encoder</span>
</span><span id="__span-16-105"><a id="__codelineno-16-105" name="__codelineno-16-105"></a>            <span class="n">embeddings</span> <span class="o">=</span> <span class="n">encoder</span><span class="p">(</span><span class="n">batch_x_partial</span><span class="p">)</span>
</span><span id="__span-16-106"><a id="__codelineno-16-106" name="__codelineno-16-106"></a>
</span><span id="__span-16-107"><a id="__codelineno-16-107" name="__codelineno-16-107"></a>            <span class="c1"># --- DIMENSION ADJUSTMENT NEEDED HERE ---</span>
</span><span id="__span-16-108"><a id="__codelineno-16-108" name="__codelineno-16-108"></a>            <span class="c1"># You must reshape the flat embeddings back to 3D to pool them</span>
</span><span id="__span-16-109"><a id="__codelineno-16-109" name="__codelineno-16-109"></a>            <span class="c1"># Example assumption: 7 spatial tokens, 16 temporal?</span>
</span><span id="__span-16-110"><a id="__codelineno-16-110" name="__codelineno-16-110"></a>            <span class="n">B</span> <span class="o">=</span> <span class="n">batch_x_partial</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-16-111"><a id="__codelineno-16-111" name="__codelineno-16-111"></a>            <span class="c1"># Verify your encoder output shape here!</span>
</span><span id="__span-16-112"><a id="__codelineno-16-112" name="__codelineno-16-112"></a>            <span class="c1"># embeddings_3d = embeddings.view(B, 7, 16, 16, embed_dim) </span>
</span><span id="__span-16-113"><a id="__codelineno-16-113" name="__codelineno-16-113"></a>
</span><span id="__span-16-114"><a id="__codelineno-16-114" name="__codelineno-16-114"></a>            <span class="c1"># Ideally, we just take the global average or max pool</span>
</span><span id="__span-16-115"><a id="__codelineno-16-115" name="__codelineno-16-115"></a>            <span class="c1"># feats = embeddings.mean(dim=1) # Global Average Pooling</span>
</span><span id="__span-16-116"><a id="__codelineno-16-116" name="__codelineno-16-116"></a>
</span><span id="__span-16-117"><a id="__codelineno-16-117" name="__codelineno-16-117"></a>            <span class="c1"># For this specific snippet logic:</span>
</span><span id="__span-16-118"><a id="__codelineno-16-118" name="__codelineno-16-118"></a>            <span class="c1"># We take the features corresponding to the &quot;last moment&quot;</span>
</span><span id="__span-16-119"><a id="__codelineno-16-119" name="__codelineno-16-119"></a>            <span class="c1"># (This logic depends heavily on your Positional Embedding order)</span>
</span><span id="__span-16-120"><a id="__codelineno-16-120" name="__codelineno-16-120"></a>            <span class="n">feats</span> <span class="o">=</span> <span class="n">embeddings</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span> <span class="c1"># [B, D] Simplified Max Pool</span>
</span><span id="__span-16-121"><a id="__codelineno-16-121" name="__codelineno-16-121"></a>
</span><span id="__span-16-122"><a id="__codelineno-16-122" name="__codelineno-16-122"></a>            <span class="n">all_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feats</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>
</span><span id="__span-16-123"><a id="__codelineno-16-123" name="__codelineno-16-123"></a>
</span><span id="__span-16-124"><a id="__codelineno-16-124" name="__codelineno-16-124"></a>    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">all_features</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-16-125"><a id="__codelineno-16-125" name="__codelineno-16-125"></a>
</span><span id="__span-16-126"><a id="__codelineno-16-126" name="__codelineno-16-126"></a><span class="c1"># ---------------------------------------------------------</span>
</span><span id="__span-16-127"><a id="__codelineno-16-127" name="__codelineno-16-127"></a><span class="c1"># 4. EVALUATION LOOP</span>
</span><span id="__span-16-128"><a id="__codelineno-16-128" name="__codelineno-16-128"></a><span class="c1"># ---------------------------------------------------------</span>
</span><span id="__span-16-129"><a id="__codelineno-16-129" name="__codelineno-16-129"></a><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_world_model</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">embed_dim</span><span class="o">=</span><span class="mi">384</span><span class="p">):</span>
</span><span id="__span-16-130"><a id="__codelineno-16-130" name="__codelineno-16-130"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; Evaluate model with proper train/test split and metrics &quot;&quot;&quot;</span>
</span><span id="__span-16-131"><a id="__codelineno-16-131" name="__codelineno-16-131"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
</span><span id="__span-16-132"><a id="__codelineno-16-132" name="__codelineno-16-132"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; EVALUATING WORLD MODEL &quot;</span><span class="p">)</span>
</span><span id="__span-16-133"><a id="__codelineno-16-133" name="__codelineno-16-133"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
</span><span id="__span-16-134"><a id="__codelineno-16-134" name="__codelineno-16-134"></a>
</span><span id="__span-16-135"><a id="__codelineno-16-135" name="__codelineno-16-135"></a>    <span class="n">encoder</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="__span-16-136"><a id="__codelineno-16-136" name="__codelineno-16-136"></a>
</span><span id="__span-16-137"><a id="__codelineno-16-137" name="__codelineno-16-137"></a>    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">create_labeled_dataset</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>
</span><span id="__span-16-138"><a id="__codelineno-16-138" name="__codelineno-16-138"></a>
</span><span id="__span-16-139"><a id="__codelineno-16-139" name="__codelineno-16-139"></a>    <span class="n">train_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.8</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
</span><span id="__span-16-140"><a id="__codelineno-16-140" name="__codelineno-16-140"></a>    <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">train_size</span><span class="p">],</span> <span class="n">y</span><span class="p">[:</span><span class="n">train_size</span><span class="p">]</span>
</span><span id="__span-16-141"><a id="__codelineno-16-141" name="__codelineno-16-141"></a>    <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">train_size</span><span class="p">:],</span> <span class="n">y</span><span class="p">[</span><span class="n">train_size</span><span class="p">:]</span>
</span><span id="__span-16-142"><a id="__codelineno-16-142" name="__codelineno-16-142"></a>
</span><span id="__span-16-143"><a id="__codelineno-16-143" name="__codelineno-16-143"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="si">}</span><span class="s2">, Test size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-16-144"><a id="__codelineno-16-144" name="__codelineno-16-144"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Position range (normalized): [</span><span class="si">{</span><span class="n">y_train</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">y_train</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
</span><span id="__span-16-145"><a id="__codelineno-16-145" name="__codelineno-16-145"></a>
</span><span id="__span-16-146"><a id="__codelineno-16-146" name="__codelineno-16-146"></a>    <span class="n">feat_train</span> <span class="o">=</span> <span class="n">extract_features</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">embed_dim</span><span class="p">)</span>
</span><span id="__span-16-147"><a id="__codelineno-16-147" name="__codelineno-16-147"></a>    <span class="n">feat_test</span> <span class="o">=</span> <span class="n">extract_features</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">embed_dim</span><span class="p">)</span>
</span><span id="__span-16-148"><a id="__codelineno-16-148" name="__codelineno-16-148"></a>
</span><span id="__span-16-149"><a id="__codelineno-16-149" name="__codelineno-16-149"></a>    <span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-16-150"><a id="__codelineno-16-150" name="__codelineno-16-150"></a>    <span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-16-151"><a id="__codelineno-16-151" name="__codelineno-16-151"></a>
</span><span id="__span-16-152"><a id="__codelineno-16-152" name="__codelineno-16-152"></a>    <span class="n">probe</span> <span class="o">=</span> <span class="n">MLPProbe</span><span class="p">(</span><span class="n">input_dim</span><span class="o">=</span><span class="n">embed_dim</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-16-153"><a id="__codelineno-16-153" name="__codelineno-16-153"></a>    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">probe</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
</span><span id="__span-16-154"><a id="__codelineno-16-154" name="__codelineno-16-154"></a>    <span class="n">loss_fn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
</span><span id="__span-16-155"><a id="__codelineno-16-155" name="__codelineno-16-155"></a>
</span><span id="__span-16-156"><a id="__codelineno-16-156" name="__codelineno-16-156"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Training probe...&quot;</span><span class="p">)</span>
</span><span id="__span-16-157"><a id="__codelineno-16-157" name="__codelineno-16-157"></a>    <span class="n">best_test_loss</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
</span><span id="__span-16-158"><a id="__codelineno-16-158" name="__codelineno-16-158"></a>
</span><span id="__span-16-159"><a id="__codelineno-16-159" name="__codelineno-16-159"></a>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
</span><span id="__span-16-160"><a id="__codelineno-16-160" name="__codelineno-16-160"></a>        <span class="n">probe</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</span><span id="__span-16-161"><a id="__codelineno-16-161" name="__codelineno-16-161"></a>        <span class="n">preds</span> <span class="o">=</span> <span class="n">probe</span><span class="p">(</span><span class="n">feat_train</span><span class="p">)</span>
</span><span id="__span-16-162"><a id="__codelineno-16-162" name="__codelineno-16-162"></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</span><span id="__span-16-163"><a id="__codelineno-16-163" name="__codelineno-16-163"></a>
</span><span id="__span-16-164"><a id="__codelineno-16-164" name="__codelineno-16-164"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="__span-16-165"><a id="__codelineno-16-165" name="__codelineno-16-165"></a>        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="__span-16-166"><a id="__codelineno-16-166" name="__codelineno-16-166"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="__span-16-167"><a id="__codelineno-16-167" name="__codelineno-16-167"></a>
</span><span id="__span-16-168"><a id="__codelineno-16-168" name="__codelineno-16-168"></a>        <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-16-169"><a id="__codelineno-16-169" name="__codelineno-16-169"></a>            <span class="n">probe</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="__span-16-170"><a id="__codelineno-16-170" name="__codelineno-16-170"></a>            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="__span-16-171"><a id="__codelineno-16-171" name="__codelineno-16-171"></a>                <span class="n">test_preds</span> <span class="o">=</span> <span class="n">probe</span><span class="p">(</span><span class="n">feat_test</span><span class="p">)</span>
</span><span id="__span-16-172"><a id="__codelineno-16-172" name="__codelineno-16-172"></a>                <span class="n">test_loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">test_preds</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</span><span id="__span-16-173"><a id="__codelineno-16-173" name="__codelineno-16-173"></a>
</span><span id="__span-16-174"><a id="__codelineno-16-174" name="__codelineno-16-174"></a>
</span><span id="__span-16-175"><a id="__codelineno-16-175" name="__codelineno-16-175"></a>                <span class="n">test_preds_px</span> <span class="o">=</span> <span class="n">test_preds</span> <span class="o">*</span> <span class="mi">64</span>
</span><span id="__span-16-176"><a id="__codelineno-16-176" name="__codelineno-16-176"></a>                <span class="n">y_test_px</span> <span class="o">=</span> <span class="n">y_test</span> <span class="o">*</span> <span class="mi">64</span>
</span><span id="__span-16-177"><a id="__codelineno-16-177" name="__codelineno-16-177"></a>                <span class="n">pixel_error</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">test_preds_px</span> <span class="o">-</span> <span class="n">y_test_px</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>
</span><span id="__span-16-178"><a id="__codelineno-16-178" name="__codelineno-16-178"></a>
</span><span id="__span-16-179"><a id="__codelineno-16-179" name="__codelineno-16-179"></a>                <span class="k">if</span> <span class="n">test_loss</span> <span class="o">&lt;</span> <span class="n">best_test_loss</span><span class="p">:</span>
</span><span id="__span-16-180"><a id="__codelineno-16-180" name="__codelineno-16-180"></a>                    <span class="n">best_test_loss</span> <span class="o">=</span> <span class="n">test_loss</span>
</span><span id="__span-16-181"><a id="__codelineno-16-181" name="__codelineno-16-181"></a>
</span><span id="__span-16-182"><a id="__codelineno-16-182" name="__codelineno-16-182"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2"> | Test Loss: </span><span class="si">{</span><span class="n">test_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> | Pixel Error: </span><span class="si">{</span><span class="n">pixel_error</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> px&quot;</span><span class="p">)</span>
</span><span id="__span-16-183"><a id="__codelineno-16-183" name="__codelineno-16-183"></a>
</span><span id="__span-16-184"><a id="__codelineno-16-184" name="__codelineno-16-184"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Final Test Loss: </span><span class="si">{</span><span class="n">best_test_loss</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-16-185"><a id="__codelineno-16-185" name="__codelineno-16-185"></a>
</span><span id="__span-16-186"><a id="__codelineno-16-186" name="__codelineno-16-186"></a>    <span class="k">return</span> <span class="n">probe</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span>
</span><span id="__span-16-187"><a id="__codelineno-16-187" name="__codelineno-16-187"></a>
</span><span id="__span-16-188"><a id="__codelineno-16-188" name="__codelineno-16-188"></a><span class="k">def</span><span class="w"> </span><span class="nf">visualize_predictions</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">embed_dim</span><span class="o">=</span><span class="mi">384</span><span class="p">,</span> <span class="n">n_examples</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
</span><span id="__span-16-189"><a id="__codelineno-16-189" name="__codelineno-16-189"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; Visualize model predictions vs ground truth &quot;&quot;&quot;</span>
</span><span id="__span-16-190"><a id="__codelineno-16-190" name="__codelineno-16-190"></a>    <span class="n">encoder</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="__span-16-191"><a id="__codelineno-16-191" name="__codelineno-16-191"></a>    <span class="n">probe</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="__span-16-192"><a id="__codelineno-16-192" name="__codelineno-16-192"></a>
</span><span id="__span-16-193"><a id="__codelineno-16-193" name="__codelineno-16-193"></a>    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_examples</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="n">n_examples</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</span><span id="__span-16-194"><a id="__codelineno-16-194" name="__codelineno-16-194"></a>    <span class="k">if</span> <span class="n">n_examples</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span>
</span><span id="__span-16-195"><a id="__codelineno-16-195" name="__codelineno-16-195"></a>
</span><span id="__span-16-196"><a id="__codelineno-16-196" name="__codelineno-16-196"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">):</span>
</span><span id="__span-16-197"><a id="__codelineno-16-197" name="__codelineno-16-197"></a>        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="p">))</span>
</span><span id="__span-16-198"><a id="__codelineno-16-198" name="__codelineno-16-198"></a>        <span class="n">video</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-16-199"><a id="__codelineno-16-199" name="__codelineno-16-199"></a>
</span><span id="__span-16-200"><a id="__codelineno-16-200" name="__codelineno-16-200"></a>        <span class="n">true_pos_norm</span> <span class="o">=</span> <span class="n">y_test</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="__span-16-201"><a id="__codelineno-16-201" name="__codelineno-16-201"></a>        <span class="n">true_pos</span> <span class="o">=</span> <span class="n">true_pos_norm</span> <span class="o">*</span> <span class="mi">64</span>
</span><span id="__span-16-202"><a id="__codelineno-16-202" name="__codelineno-16-202"></a>
</span><span id="__span-16-203"><a id="__codelineno-16-203" name="__codelineno-16-203"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="__span-16-204"><a id="__codelineno-16-204" name="__codelineno-16-204"></a>            <span class="n">feat</span> <span class="o">=</span> <span class="n">extract_features</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">embed_dim</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-16-205"><a id="__codelineno-16-205" name="__codelineno-16-205"></a>            <span class="n">pred_pos_norm</span> <span class="o">=</span> <span class="n">probe</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-16-206"><a id="__codelineno-16-206" name="__codelineno-16-206"></a>            <span class="n">pred_pos</span> <span class="o">=</span> <span class="n">pred_pos_norm</span> <span class="o">*</span> <span class="mi">64</span>
</span><span id="__span-16-207"><a id="__codelineno-16-207" name="__codelineno-16-207"></a>
</span><span id="__span-16-208"><a id="__codelineno-16-208" name="__codelineno-16-208"></a>        <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">true_pos</span> <span class="o">-</span> <span class="n">pred_pos</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
</span><span id="__span-16-209"><a id="__codelineno-16-209" name="__codelineno-16-209"></a>        <span class="n">last_frame</span> <span class="o">=</span> <span class="n">video</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="__span-16-210"><a id="__codelineno-16-210" name="__codelineno-16-210"></a>
</span><span id="__span-16-211"><a id="__codelineno-16-211" name="__codelineno-16-211"></a>        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">last_frame</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-16-212"><a id="__codelineno-16-212" name="__codelineno-16-212"></a>
</span><span id="__span-16-213"><a id="__codelineno-16-213" name="__codelineno-16-213"></a>
</span><span id="__span-16-214"><a id="__codelineno-16-214" name="__codelineno-16-214"></a>        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">true_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">true_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;lime&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> 
</span><span id="__span-16-215"><a id="__codelineno-16-215" name="__codelineno-16-215"></a>                   <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Ground Truth&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="__span-16-216"><a id="__codelineno-16-216" name="__codelineno-16-216"></a>
</span><span id="__span-16-217"><a id="__codelineno-16-217" name="__codelineno-16-217"></a>
</span><span id="__span-16-218"><a id="__codelineno-16-218" name="__codelineno-16-218"></a>        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">pred_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pred_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> 
</span><span id="__span-16-219"><a id="__codelineno-16-219" name="__codelineno-16-219"></a>                   <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prediction&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="__span-16-220"><a id="__codelineno-16-220" name="__codelineno-16-220"></a>
</span><span id="__span-16-221"><a id="__codelineno-16-221" name="__codelineno-16-221"></a>
</span><span id="__span-16-222"><a id="__codelineno-16-222" name="__codelineno-16-222"></a>        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">true_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pred_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">true_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pred_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> 
</span><span id="__span-16-223"><a id="__codelineno-16-223" name="__codelineno-16-223"></a>                <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="__span-16-224"><a id="__codelineno-16-224" name="__codelineno-16-224"></a>
</span><span id="__span-16-225"><a id="__codelineno-16-225" name="__codelineno-16-225"></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">error</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> px&quot;</span><span class="p">)</span>
</span><span id="__span-16-226"><a id="__codelineno-16-226" name="__codelineno-16-226"></a>        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="__span-16-227"><a id="__codelineno-16-227" name="__codelineno-16-227"></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="__span-16-228"><a id="__codelineno-16-228" name="__codelineno-16-228"></a>
</span><span id="__span-16-229"><a id="__codelineno-16-229" name="__codelineno-16-229"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="__span-16-230"><a id="__codelineno-16-230" name="__codelineno-16-230"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></code></pre></div></td></tr></table></div>
<h1 id="phase-4-the-action-conditioned-world-model">Phase 4: The Action-Conditioned World Model</h1>
<p>Now that our AI understands the laws of physics (Phase 1 &amp; 2), we give it a body. We transition from a <strong>passive observer</strong> to an <strong>active agent</strong>.</p>
<h3 id="1-the-motor-cortex-action-model">1. The "Motor Cortex" (Action Model)</h3>
<p>We attach a secondary neural network to the frozen Encoder. This is the <strong>Action Model</strong>.</p>
<div class="admonition abstract">
<p class="admonition-title">The Function</p>
<ul>
<li><strong>Input:</strong> The current "thought" (Latent State <span class="arithmatex">\(z_t\)</span>) + An Action (Velocity Vector <span class="arithmatex">\(a_t\)</span>).</li>
<li><strong>Output:</strong> The predicted next "thought" (<span class="arithmatex">\(z_{t+1}\)</span>).</li>
<li><strong>The Goal:</strong> It learns the transition function of the universe: 
    $<span class="arithmatex">\(f(z_t, a_t) \rightarrow z_{t+1}\)</span>$</li>
</ul>
</div>
<h3 id="the-architecture-cross-attention-for-control">The Architecture: Cross-Attention for Control</h3>
<p>How do we fuse a "Thought" (complex video tokens) with an "Action" (simple velocity vector)? </p>
<p>We use <strong>Cross-Attention</strong>. The "Thought" is the Query, and the "Action" acts as the Key/Value that modulates the thought.</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">motor_cortex.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-17-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-17-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-17-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-17-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-17-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-17-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-17-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-17-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-17-10">10</a></span>
<span class="normal"><a href="#__codelineno-17-11">11</a></span>
<span class="normal"><a href="#__codelineno-17-12">12</a></span>
<span class="normal"><a href="#__codelineno-17-13">13</a></span>
<span class="normal"><a href="#__codelineno-17-14">14</a></span>
<span class="normal"><a href="#__codelineno-17-15">15</a></span>
<span class="normal"><a href="#__codelineno-17-16">16</a></span>
<span class="normal"><a href="#__codelineno-17-17">17</a></span>
<span class="normal"><a href="#__codelineno-17-18">18</a></span>
<span class="normal"><a href="#__codelineno-17-19">19</a></span>
<span class="normal"><a href="#__codelineno-17-20">20</a></span>
<span class="normal"><a href="#__codelineno-17-21">21</a></span>
<span class="normal"><a href="#__codelineno-17-22">22</a></span>
<span class="normal"><a href="#__codelineno-17-23">23</a></span>
<span class="normal"><a href="#__codelineno-17-24">24</a></span>
<span class="normal"><a href="#__codelineno-17-25">25</a></span>
<span class="normal"><a href="#__codelineno-17-26">26</a></span>
<span class="normal"><a href="#__codelineno-17-27">27</a></span>
<span class="normal"><a href="#__codelineno-17-28">28</a></span>
<span class="normal"><a href="#__codelineno-17-29">29</a></span>
<span class="normal"><a href="#__codelineno-17-30">30</a></span>
<span class="normal"><a href="#__codelineno-17-31">31</a></span>
<span class="normal"><a href="#__codelineno-17-32">32</a></span>
<span class="normal"><a href="#__codelineno-17-33">33</a></span>
<span class="normal"><a href="#__codelineno-17-34">34</a></span>
<span class="normal"><a href="#__codelineno-17-35">35</a></span>
<span class="normal"><a href="#__codelineno-17-36">36</a></span>
<span class="normal"><a href="#__codelineno-17-37">37</a></span>
<span class="normal"><a href="#__codelineno-17-38">38</a></span>
<span class="normal"><a href="#__codelineno-17-39">39</a></span>
<span class="normal"><a href="#__codelineno-17-40">40</a></span>
<span class="normal"><a href="#__codelineno-17-41">41</a></span>
<span class="normal"><a href="#__codelineno-17-42">42</a></span>
<span class="normal"><a href="#__codelineno-17-43">43</a></span>
<span class="normal"><a href="#__codelineno-17-44">44</a></span>
<span class="normal"><a href="#__codelineno-17-45">45</a></span>
<span class="normal"><a href="#__codelineno-17-46">46</a></span>
<span class="normal"><a href="#__codelineno-17-47">47</a></span>
<span class="normal"><a href="#__codelineno-17-48">48</a></span>
<span class="normal"><a href="#__codelineno-17-49">49</a></span>
<span class="normal"><a href="#__codelineno-17-50">50</a></span>
<span class="normal"><a href="#__codelineno-17-51">51</a></span>
<span class="normal"><a href="#__codelineno-17-52">52</a></span>
<span class="normal"><a href="#__codelineno-17-53">53</a></span>
<span class="normal"><a href="#__codelineno-17-54">54</a></span>
<span class="normal"><a href="#__codelineno-17-55">55</a></span>
<span class="normal"><a href="#__codelineno-17-56">56</a></span>
<span class="normal"><a href="#__codelineno-17-57">57</a></span>
<span class="normal"><a href="#__codelineno-17-58">58</a></span>
<span class="normal"><a href="#__codelineno-17-59">59</a></span>
<span class="normal"><a href="#__codelineno-17-60">60</a></span>
<span class="normal"><a href="#__codelineno-17-61">61</a></span>
<span class="normal"><a href="#__codelineno-17-62">62</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3"></a>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">ActionEncoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; </span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6"></a><span class="sd">    Transforms raw actions (e.g., velocity [vx, vy]) </span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7"></a><span class="sd">    into a high-dimensional vector.</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">embed_dim</span><span class="o">=</span><span class="mi">384</span><span class="p">):</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">action_dim</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">embed_dim</span><span class="p">)</span>
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17"></a>        <span class="p">)</span>
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18"></a>
</span><span id="__span-17-19"><a id="__codelineno-17-19" name="__codelineno-17-19"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">actions</span><span class="p">):</span>
</span><span id="__span-17-20"><a id="__codelineno-17-20" name="__codelineno-17-20"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span>
</span><span id="__span-17-21"><a id="__codelineno-17-21" name="__codelineno-17-21"></a>
</span><span id="__span-17-22"><a id="__codelineno-17-22" name="__codelineno-17-22"></a><span class="k">class</span><span class="w"> </span><span class="nc">ActionConditionedPredictor</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-17-23"><a id="__codelineno-17-23" name="__codelineno-17-23"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-17-24"><a id="__codelineno-17-24" name="__codelineno-17-24"></a><span class="sd">    The Brain&#39;s Simulator: Takes current state tokens and an action, </span>
</span><span id="__span-17-25"><a id="__codelineno-17-25" name="__codelineno-17-25"></a><span class="sd">    then hallucinates the next state tokens.</span>
</span><span id="__span-17-26"><a id="__codelineno-17-26" name="__codelineno-17-26"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-17-27"><a id="__codelineno-17-27" name="__codelineno-17-27"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">embed_dim</span><span class="o">=</span><span class="mi">384</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
</span><span id="__span-17-28"><a id="__codelineno-17-28" name="__codelineno-17-28"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-17-29"><a id="__codelineno-17-29" name="__codelineno-17-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span> <span class="o">=</span> <span class="n">embed_dim</span>
</span><span id="__span-17-30"><a id="__codelineno-17-30" name="__codelineno-17-30"></a>
</span><span id="__span-17-31"><a id="__codelineno-17-31" name="__codelineno-17-31"></a>
</span><span id="__span-17-32"><a id="__codelineno-17-32" name="__codelineno-17-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">action_encoder</span> <span class="o">=</span> <span class="n">ActionEncoder</span><span class="p">(</span><span class="n">action_dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">embed_dim</span><span class="o">=</span><span class="n">embed_dim</span><span class="p">)</span>
</span><span id="__span-17-33"><a id="__codelineno-17-33" name="__codelineno-17-33"></a>
</span><span id="__span-17-34"><a id="__codelineno-17-34" name="__codelineno-17-34"></a>
</span><span id="__span-17-35"><a id="__codelineno-17-35" name="__codelineno-17-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cross_attn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MultiheadAttention</span><span class="p">(</span>
</span><span id="__span-17-36"><a id="__codelineno-17-36" name="__codelineno-17-36"></a>            <span class="n">embed_dim</span><span class="p">,</span> <span class="n">num_heads</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.1</span>
</span><span id="__span-17-37"><a id="__codelineno-17-37" name="__codelineno-17-37"></a>        <span class="p">)</span>
</span><span id="__span-17-38"><a id="__codelineno-17-38" name="__codelineno-17-38"></a>
</span><span id="__span-17-39"><a id="__codelineno-17-39" name="__codelineno-17-39"></a>
</span><span id="__span-17-40"><a id="__codelineno-17-40" name="__codelineno-17-40"></a>        <span class="n">layer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">TransformerEncoderLayer</span><span class="p">(</span>
</span><span id="__span-17-41"><a id="__codelineno-17-41" name="__codelineno-17-41"></a>            <span class="n">d_model</span><span class="o">=</span><span class="n">embed_dim</span><span class="p">,</span> <span class="n">nhead</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">dim_feedforward</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
</span><span id="__span-17-42"><a id="__codelineno-17-42" name="__codelineno-17-42"></a>            <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">norm_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.1</span>
</span><span id="__span-17-43"><a id="__codelineno-17-43" name="__codelineno-17-43"></a>        <span class="p">)</span>
</span><span id="__span-17-44"><a id="__codelineno-17-44" name="__codelineno-17-44"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">TransformerEncoder</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="n">num_layers</span><span class="p">)</span>
</span><span id="__span-17-45"><a id="__codelineno-17-45" name="__codelineno-17-45"></a>
</span><span id="__span-17-46"><a id="__codelineno-17-46" name="__codelineno-17-46"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">)</span>
</span><span id="__span-17-47"><a id="__codelineno-17-47" name="__codelineno-17-47"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pred_head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">,</span> <span class="n">embed_dim</span><span class="p">)</span>
</span><span id="__span-17-48"><a id="__codelineno-17-48" name="__codelineno-17-48"></a>
</span><span id="__span-17-49"><a id="__codelineno-17-49" name="__codelineno-17-49"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_tokens</span><span class="p">,</span> <span class="n">actions</span><span class="p">):</span>
</span><span id="__span-17-50"><a id="__codelineno-17-50" name="__codelineno-17-50"></a>        <span class="c1"># Embed Action: [Batch, 2] -&gt; [Batch, 1, Embed_Dim]</span>
</span><span id="__span-17-51"><a id="__codelineno-17-51" name="__codelineno-17-51"></a>        <span class="n">action_embed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_encoder</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-17-52"><a id="__codelineno-17-52" name="__codelineno-17-52"></a>
</span><span id="__span-17-53"><a id="__codelineno-17-53" name="__codelineno-17-53"></a>
</span><span id="__span-17-54"><a id="__codelineno-17-54" name="__codelineno-17-54"></a>        <span class="n">state_conditioned</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_attn</span><span class="p">(</span><span class="n">state_tokens</span><span class="p">,</span> <span class="n">action_embed</span><span class="p">,</span> <span class="n">action_embed</span><span class="p">)</span>
</span><span id="__span-17-55"><a id="__codelineno-17-55" name="__codelineno-17-55"></a>
</span><span id="__span-17-56"><a id="__codelineno-17-56" name="__codelineno-17-56"></a>        <span class="n">state_conditioned</span> <span class="o">=</span> <span class="n">state_tokens</span> <span class="o">+</span> <span class="n">state_conditioned</span>
</span><span id="__span-17-57"><a id="__codelineno-17-57" name="__codelineno-17-57"></a>
</span><span id="__span-17-58"><a id="__codelineno-17-58" name="__codelineno-17-58"></a>        <span class="c1"># Predict Next State</span>
</span><span id="__span-17-59"><a id="__codelineno-17-59" name="__codelineno-17-59"></a>        <span class="n">next_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="p">(</span><span class="n">state_conditioned</span><span class="p">)</span>
</span><span id="__span-17-60"><a id="__codelineno-17-60" name="__codelineno-17-60"></a>        <span class="n">next_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">next_state</span><span class="p">)</span>
</span><span id="__span-17-61"><a id="__codelineno-17-61" name="__codelineno-17-61"></a>
</span><span id="__span-17-62"><a id="__codelineno-17-62" name="__codelineno-17-62"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_head</span><span class="p">(</span><span class="n">next_state</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="the-interpreter-position-decoder">The "Interpreter" (Position Decoder)</h3>
<p>The Motor Cortex works entirely in "dream space" (embeddings). To plan a path, we need to translate these dreams back into coordinates <span class="arithmatex">\((X, Y)\)</span> so we can calculate the distance to our goal.</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Interpreter.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-18-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-18-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-18-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-18-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-18-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-18-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-18-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-18-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-18-10">10</a></span>
<span class="normal"><a href="#__codelineno-18-11">11</a></span>
<span class="normal"><a href="#__codelineno-18-12">12</a></span>
<span class="normal"><a href="#__codelineno-18-13">13</a></span>
<span class="normal"><a href="#__codelineno-18-14">14</a></span>
<span class="normal"><a href="#__codelineno-18-15">15</a></span>
<span class="normal"><a href="#__codelineno-18-16">16</a></span>
<span class="normal"><a href="#__codelineno-18-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">PositionDecoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="sd">    Reads the &#39;dream&#39; tokens and extracts the object&#39;s predicted position.</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="sd">    Used by the planner to check if the dream leads to the goal.</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">embed_dim</span><span class="o">=</span><span class="mi">384</span><span class="p">):</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span> 
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12"></a>        <span class="p">)</span>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13"></a>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_tokens</span><span class="p">):</span>
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15"></a>
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16"></a>        <span class="n">pooled</span> <span class="o">=</span> <span class="n">state_tokens</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span> 
</span><span id="__span-18-17"><a id="__codelineno-18-17" name="__codelineno-18-17"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">(</span><span class="n">pooled</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="the-training-loop">The Training Loop</h3>
<p>We do not need to label data by hand. We can reuse our simulator to self-supervise the agent.</p>
<ol>
<li><strong>Freeze the Eye:</strong> The Encoder is now locked. It provides stable representations of the world.</li>
<li><strong>Random Actions:</strong> We generate videos where we randomly "push" the digit around.</li>
<li><strong>Prediction:</strong> We train the <code>ActionConditionedPredictor</code> to minimize the difference between its <em>predicted</em> latent state and the <em>actual</em> latent state produced by the Encoder for the next frame.</li>
</ol>
<div class="admonition abstract">
<p class="admonition-title">Mathematical Objective</p>
<p>We minimize a composite loss function <span class="arithmatex">\(\mathcal{L}_{total}\)</span> that ensures the agent predicts both the correct abstract concept (Latent State) and the correct physical location (decoded position).</p>
<div class="arithmatex">\[
\mathcal{L}_{total} = \mathcal{L}_{dynamics} + \mathcal{L}_{position}
\]</div>
<p><strong>1. Dynamics Loss (Latent Space):</strong></p>
<div class="arithmatex">\[\mathcal{L}_{dynamics} = || z_{t+1}^{pred} - z_{t+1}^{teacher} ||^2\]</div>
<p><strong>2. Position Loss (Physical Space):</strong></p>
<p>To ground the "dreams" in reality, we force the decoded position of the predicted state to match the true coordinate <span class="arithmatex">\(p_{t+1}\)</span>.</p>
<div class="arithmatex">\[\mathcal{L}_{position} = || \text{Dec}(z_{t+1}^{teacher}) - p_{t+1} ||^2 + 0.5 \cdot || \text{Dec}(z_{t+1}^{pred}) - p_{t+1} ||^2\]</div>
</div>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">trainer.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-19-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-19-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-19-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-19-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-19-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-19-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-19-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-19-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-19-10">10</a></span>
<span class="normal"><a href="#__codelineno-19-11">11</a></span>
<span class="normal"><a href="#__codelineno-19-12">12</a></span>
<span class="normal"><a href="#__codelineno-19-13">13</a></span>
<span class="normal"><a href="#__codelineno-19-14">14</a></span>
<span class="normal"><a href="#__codelineno-19-15">15</a></span>
<span class="normal"><a href="#__codelineno-19-16">16</a></span>
<span class="normal"><a href="#__codelineno-19-17">17</a></span>
<span class="normal"><a href="#__codelineno-19-18">18</a></span>
<span class="normal"><a href="#__codelineno-19-19">19</a></span>
<span class="normal"><a href="#__codelineno-19-20">20</a></span>
<span class="normal"><a href="#__codelineno-19-21">21</a></span>
<span class="normal"><a href="#__codelineno-19-22">22</a></span>
<span class="normal"><a href="#__codelineno-19-23">23</a></span>
<span class="normal"><a href="#__codelineno-19-24">24</a></span>
<span class="normal"><a href="#__codelineno-19-25">25</a></span>
<span class="normal"><a href="#__codelineno-19-26">26</a></span>
<span class="normal"><a href="#__codelineno-19-27">27</a></span>
<span class="normal"><a href="#__codelineno-19-28">28</a></span>
<span class="normal"><a href="#__codelineno-19-29">29</a></span>
<span class="normal"><a href="#__codelineno-19-30">30</a></span>
<span class="normal"><a href="#__codelineno-19-31">31</a></span>
<span class="normal"><a href="#__codelineno-19-32">32</a></span>
<span class="normal"><a href="#__codelineno-19-33">33</a></span>
<span class="normal"><a href="#__codelineno-19-34">34</a></span>
<span class="normal"><a href="#__codelineno-19-35">35</a></span>
<span class="normal"><a href="#__codelineno-19-36">36</a></span>
<span class="normal"><a href="#__codelineno-19-37">37</a></span>
<span class="normal"><a href="#__codelineno-19-38">38</a></span>
<span class="normal"><a href="#__codelineno-19-39">39</a></span>
<span class="normal"><a href="#__codelineno-19-40">40</a></span>
<span class="normal"><a href="#__codelineno-19-41">41</a></span>
<span class="normal"><a href="#__codelineno-19-42">42</a></span>
<span class="normal"><a href="#__codelineno-19-43">43</a></span>
<span class="normal"><a href="#__codelineno-19-44">44</a></span>
<span class="normal"><a href="#__codelineno-19-45">45</a></span>
<span class="normal"><a href="#__codelineno-19-46">46</a></span>
<span class="normal"><a href="#__codelineno-19-47">47</a></span>
<span class="normal"><a href="#__codelineno-19-48">48</a></span>
<span class="normal"><a href="#__codelineno-19-49">49</a></span>
<span class="normal"><a href="#__codelineno-19-50">50</a></span>
<span class="normal"><a href="#__codelineno-19-51">51</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">train_action_predictor</span><span class="p">(</span><span class="n">frozen_encoder</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cuda&#39;</span><span class="p">):</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;STAGE 2: TRAINING ACTION PREDICTOR&quot;</span><span class="p">)</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5"></a>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6"></a>    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">device</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7"></a>    <span class="n">frozen_encoder</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8"></a>    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">frozen_encoder</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9"></a>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10"></a>    <span class="n">world</span> <span class="o">=</span> <span class="n">ControllableMicroWorld</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11"></a>    <span class="n">predictor</span> <span class="o">=</span> <span class="n">ActionConditionedPredictor</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12"></a>    <span class="n">pos_decoder</span> <span class="o">=</span> <span class="n">PositionDecoder</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13"></a>
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14"></a>    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">predictor</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">pos_decoder</span><span class="o">.</span><span class="n">parameters</span><span class="p">()),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>
</span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15"></a>    <span class="n">loss_fn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
</span><span id="__span-19-16"><a id="__codelineno-19-16" name="__codelineno-19-16"></a>
</span><span id="__span-19-17"><a id="__codelineno-19-17" name="__codelineno-19-17"></a>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
</span><span id="__span-19-18"><a id="__codelineno-19-18" name="__codelineno-19-18"></a>        <span class="n">videos</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">states</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">create_controlled_universe</span><span class="p">()</span>
</span><span id="__span-19-19"><a id="__codelineno-19-19" name="__codelineno-19-19"></a>        <span class="n">videos</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">states</span> <span class="o">=</span> <span class="n">videos</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">actions</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">states</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-19-20"><a id="__codelineno-19-20" name="__codelineno-19-20"></a>
</span><span id="__span-19-21"><a id="__codelineno-19-21" name="__codelineno-19-21"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="__span-19-22"><a id="__codelineno-19-22" name="__codelineno-19-22"></a>            <span class="n">full_embeds</span> <span class="o">=</span> <span class="n">frozen_encoder</span><span class="p">(</span><span class="n">videos</span><span class="p">)</span>
</span><span id="__span-19-23"><a id="__codelineno-19-23" name="__codelineno-19-23"></a>            <span class="n">B</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">full_embeds</span><span class="o">.</span><span class="n">shape</span>
</span><span id="__span-19-24"><a id="__codelineno-19-24" name="__codelineno-19-24"></a>            <span class="n">time_sep_embeds</span> <span class="o">=</span> <span class="n">full_embeds</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
</span><span id="__span-19-25"><a id="__codelineno-19-25" name="__codelineno-19-25"></a>
</span><span id="__span-19-26"><a id="__codelineno-19-26" name="__codelineno-19-26"></a>        <span class="n">total_loss</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-19-27"><a id="__codelineno-19-27" name="__codelineno-19-27"></a>        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">):</span>
</span><span id="__span-19-28"><a id="__codelineno-19-28" name="__codelineno-19-28"></a>            <span class="n">curr_state_z</span> <span class="o">=</span> <span class="n">time_sep_embeds</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span>
</span><span id="__span-19-29"><a id="__codelineno-19-29" name="__codelineno-19-29"></a>            <span class="n">next_state_z_gt</span> <span class="o">=</span> <span class="n">time_sep_embeds</span><span class="p">[:,</span> <span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__span-19-30"><a id="__codelineno-19-30" name="__codelineno-19-30"></a>            <span class="n">action_t</span> <span class="o">=</span> <span class="n">actions</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span>
</span><span id="__span-19-31"><a id="__codelineno-19-31" name="__codelineno-19-31"></a>
</span><span id="__span-19-32"><a id="__codelineno-19-32" name="__codelineno-19-32"></a>            <span class="n">next_state_z_pred</span> <span class="o">=</span> <span class="n">predictor</span><span class="p">(</span><span class="n">curr_state_z</span><span class="p">,</span> <span class="n">action_t</span><span class="p">)</span>
</span><span id="__span-19-33"><a id="__codelineno-19-33" name="__codelineno-19-33"></a>
</span><span id="__span-19-34"><a id="__codelineno-19-34" name="__codelineno-19-34"></a>            <span class="n">true_pos_next</span> <span class="o">=</span> <span class="n">states</span><span class="p">[:,</span> <span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
</span><span id="__span-19-35"><a id="__codelineno-19-35" name="__codelineno-19-35"></a>            <span class="n">pred_pos_from_gt</span> <span class="o">=</span> <span class="n">pos_decoder</span><span class="p">(</span><span class="n">next_state_z_gt</span><span class="p">)</span>
</span><span id="__span-19-36"><a id="__codelineno-19-36" name="__codelineno-19-36"></a>            <span class="n">pred_pos_from_pred</span> <span class="o">=</span> <span class="n">pos_decoder</span><span class="p">(</span><span class="n">next_state_z_pred</span><span class="p">)</span>
</span><span id="__span-19-37"><a id="__codelineno-19-37" name="__codelineno-19-37"></a>
</span><span id="__span-19-38"><a id="__codelineno-19-38" name="__codelineno-19-38"></a>            <span class="n">loss_dynamics</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">next_state_z_pred</span><span class="p">,</span> <span class="n">next_state_z_gt</span><span class="p">)</span>
</span><span id="__span-19-39"><a id="__codelineno-19-39" name="__codelineno-19-39"></a>            <span class="n">loss_pos</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">pred_pos_from_gt</span><span class="p">,</span> <span class="n">true_pos_next</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">pred_pos_from_pred</span><span class="p">,</span> <span class="n">true_pos_next</span><span class="p">)</span>
</span><span id="__span-19-40"><a id="__codelineno-19-40" name="__codelineno-19-40"></a>            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_dynamics</span> <span class="o">+</span> <span class="n">loss_pos</span>
</span><span id="__span-19-41"><a id="__codelineno-19-41" name="__codelineno-19-41"></a>
</span><span id="__span-19-42"><a id="__codelineno-19-42" name="__codelineno-19-42"></a>            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="__span-19-43"><a id="__codelineno-19-43" name="__codelineno-19-43"></a>            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="__span-19-44"><a id="__codelineno-19-44" name="__codelineno-19-44"></a>            <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="n">predictor</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="mf">1.0</span><span class="p">)</span>
</span><span id="__span-19-45"><a id="__codelineno-19-45" name="__codelineno-19-45"></a>            <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="__span-19-46"><a id="__codelineno-19-46" name="__codelineno-19-46"></a>            <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="__span-19-47"><a id="__codelineno-19-47" name="__codelineno-19-47"></a>
</span><span id="__span-19-48"><a id="__codelineno-19-48" name="__codelineno-19-48"></a>        <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-19-49"><a id="__codelineno-19-49" name="__codelineno-19-49"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">epochs</span><span class="si">}</span><span class="s2"> | Avg Loss: </span><span class="si">{</span><span class="n">total_loss</span><span class="o">/</span><span class="mi">15</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-19-50"><a id="__codelineno-19-50" name="__codelineno-19-50"></a>
</span><span id="__span-19-51"><a id="__codelineno-19-51" name="__codelineno-19-51"></a>    <span class="k">return</span> <span class="n">predictor</span><span class="p">,</span> <span class="n">pos_decoder</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="the-mpc-planner-the-strategist">The MPC Planner (The Strategist)</h3>
<p>Once the Motor Cortex is trained, we don't just predict one step; we plan. We use <strong>Model Predictive Control (MPC)</strong>.</p>
<div class="admonition success">
<p class="admonition-title">The Planning Loop (CEM)</p>
<p>We use the <strong>Cross-Entropy Method (CEM)</strong>, a sampling-based optimization algorithm.</p>
<ol>
<li><strong>Initialize:</strong> Create a Gaussian distribution <span class="arithmatex">\(\mathcal{N}(\mu, \sigma)\)</span> for action sequences.</li>
<li><strong>Sample:</strong> Draw <span class="arithmatex">\(N=200\)</span> random action sequences from this distribution.</li>
<li><strong>Evaluate:</strong> Run these sequences through the <code>predictor</code> to get latent states <span class="arithmatex">\(z_{1:T}\)</span>. Decode positions and calculate distance to the goal.</li>
<li><strong>Select Elites:</strong> Pick the top <span class="arithmatex">\(10\%\)</span> sequences with the lowest cost.</li>
<li><strong>Refit:</strong> Update <span class="arithmatex">\(\mu\)</span> and <span class="arithmatex">\(\sigma\)</span> to match the elites.</li>
<li><strong>Repeat:</strong> Iterate 5 times to refine the plan.</li>
</ol>
</div>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">MPC.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-20-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-20-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-20-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-20-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-20-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-20-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-20-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-20-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-20-10">10</a></span>
<span class="normal"><a href="#__codelineno-20-11">11</a></span>
<span class="normal"><a href="#__codelineno-20-12">12</a></span>
<span class="normal"><a href="#__codelineno-20-13">13</a></span>
<span class="normal"><a href="#__codelineno-20-14">14</a></span>
<span class="normal"><a href="#__codelineno-20-15">15</a></span>
<span class="normal"><a href="#__codelineno-20-16">16</a></span>
<span class="normal"><a href="#__codelineno-20-17">17</a></span>
<span class="normal"><a href="#__codelineno-20-18">18</a></span>
<span class="normal"><a href="#__codelineno-20-19">19</a></span>
<span class="normal"><a href="#__codelineno-20-20">20</a></span>
<span class="normal"><a href="#__codelineno-20-21">21</a></span>
<span class="normal"><a href="#__codelineno-20-22">22</a></span>
<span class="normal"><a href="#__codelineno-20-23">23</a></span>
<span class="normal"><a href="#__codelineno-20-24">24</a></span>
<span class="normal"><a href="#__codelineno-20-25">25</a></span>
<span class="normal"><a href="#__codelineno-20-26">26</a></span>
<span class="normal"><a href="#__codelineno-20-27">27</a></span>
<span class="normal"><a href="#__codelineno-20-28">28</a></span>
<span class="normal"><a href="#__codelineno-20-29">29</a></span>
<span class="normal"><a href="#__codelineno-20-30">30</a></span>
<span class="normal"><a href="#__codelineno-20-31">31</a></span>
<span class="normal"><a href="#__codelineno-20-32">32</a></span>
<span class="normal"><a href="#__codelineno-20-33">33</a></span>
<span class="normal"><a href="#__codelineno-20-34">34</a></span>
<span class="normal"><a href="#__codelineno-20-35">35</a></span>
<span class="normal"><a href="#__codelineno-20-36">36</a></span>
<span class="normal"><a href="#__codelineno-20-37">37</a></span>
<span class="normal"><a href="#__codelineno-20-38">38</a></span>
<span class="normal"><a href="#__codelineno-20-39">39</a></span>
<span class="normal"><a href="#__codelineno-20-40">40</a></span>
<span class="normal"><a href="#__codelineno-20-41">41</a></span>
<span class="normal"><a href="#__codelineno-20-42">42</a></span>
<span class="normal"><a href="#__codelineno-20-43">43</a></span>
<span class="normal"><a href="#__codelineno-20-44">44</a></span>
<span class="normal"><a href="#__codelineno-20-45">45</a></span>
<span class="normal"><a href="#__codelineno-20-46">46</a></span>
<span class="normal"><a href="#__codelineno-20-47">47</a></span>
<span class="normal"><a href="#__codelineno-20-48">48</a></span>
<span class="normal"><a href="#__codelineno-20-49">49</a></span>
<span class="normal"><a href="#__codelineno-20-50">50</a></span>
<span class="normal"><a href="#__codelineno-20-51">51</a></span>
<span class="normal"><a href="#__codelineno-20-52">52</a></span>
<span class="normal"><a href="#__codelineno-20-53">53</a></span>
<span class="normal"><a href="#__codelineno-20-54">54</a></span>
<span class="normal"><a href="#__codelineno-20-55">55</a></span>
<span class="normal"><a href="#__codelineno-20-56">56</a></span>
<span class="normal"><a href="#__codelineno-20-57">57</a></span>
<span class="normal"><a href="#__codelineno-20-58">58</a></span>
<span class="normal"><a href="#__codelineno-20-59">59</a></span>
<span class="normal"><a href="#__codelineno-20-60">60</a></span>
<span class="normal"><a href="#__codelineno-20-61">61</a></span>
<span class="normal"><a href="#__codelineno-20-62">62</a></span>
<span class="normal"><a href="#__codelineno-20-63">63</a></span>
<span class="normal"><a href="#__codelineno-20-64">64</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">AdvancedMPCPlanner</span><span class="p">:</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="n">predictor</span><span class="p">,</span> <span class="n">pos_decoder</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cuda&#39;</span><span class="p">):</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">encoder</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">=</span> <span class="n">predictor</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pos_decoder</span> <span class="o">=</span> <span class="n">pos_decoder</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7"></a>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">encode_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11"></a>
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plan_cem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_frame</span><span class="p">,</span> <span class="n">goal_frame</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
</span><span id="__span-20-13"><a id="__codelineno-20-13" name="__codelineno-20-13"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Planning horizon </span><span class="si">{</span><span class="n">horizon</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
</span><span id="__span-20-14"><a id="__codelineno-20-14" name="__codelineno-20-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="__span-20-15"><a id="__codelineno-20-15" name="__codelineno-20-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="__span-20-16"><a id="__codelineno-20-16" name="__codelineno-20-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pos_decoder</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="__span-20-17"><a id="__codelineno-20-17" name="__codelineno-20-17"></a>
</span><span id="__span-20-18"><a id="__codelineno-20-18" name="__codelineno-20-18"></a>        <span class="n">start_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode_frame</span><span class="p">(</span><span class="n">start_frame</span><span class="p">)</span>
</span><span id="__span-20-19"><a id="__codelineno-20-19" name="__codelineno-20-19"></a>        <span class="n">goal_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode_frame</span><span class="p">(</span><span class="n">goal_frame</span><span class="p">)</span>
</span><span id="__span-20-20"><a id="__codelineno-20-20" name="__codelineno-20-20"></a>
</span><span id="__span-20-21"><a id="__codelineno-20-21" name="__codelineno-20-21"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="__span-20-22"><a id="__codelineno-20-22" name="__codelineno-20-22"></a>            <span class="n">goal_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_decoder</span><span class="p">(</span><span class="n">goal_z</span><span class="p">)</span>
</span><span id="__span-20-23"><a id="__codelineno-20-23" name="__codelineno-20-23"></a>
</span><span id="__span-20-24"><a id="__codelineno-20-24" name="__codelineno-20-24"></a>        <span class="n">mean</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">horizon</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-20-25"><a id="__codelineno-20-25" name="__codelineno-20-25"></a>        <span class="n">std</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">horizon</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
</span><span id="__span-20-26"><a id="__codelineno-20-26" name="__codelineno-20-26"></a>
</span><span id="__span-20-27"><a id="__codelineno-20-27" name="__codelineno-20-27"></a>        <span class="n">best_action_seq</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-20-28"><a id="__codelineno-20-28" name="__codelineno-20-28"></a>        <span class="n">best_cost</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
</span><span id="__span-20-29"><a id="__codelineno-20-29" name="__codelineno-20-29"></a>
</span><span id="__span-20-30"><a id="__codelineno-20-30" name="__codelineno-20-30"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
</span><span id="__span-20-31"><a id="__codelineno-20-31" name="__codelineno-20-31"></a>            <span class="n">noise</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">num_samples</span><span class="p">,</span> <span class="n">horizon</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-20-32"><a id="__codelineno-20-32" name="__codelineno-20-32"></a>            <span class="n">actions_batch</span> <span class="o">=</span> <span class="n">mean</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">noise</span> <span class="o">*</span> <span class="n">std</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-20-33"><a id="__codelineno-20-33" name="__codelineno-20-33"></a>
</span><span id="__span-20-34"><a id="__codelineno-20-34" name="__codelineno-20-34"></a>            <span class="n">curr_z</span> <span class="o">=</span> <span class="n">start_z</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">num_samples</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-20-35"><a id="__codelineno-20-35" name="__codelineno-20-35"></a>            <span class="n">cumulative_cost</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_samples</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-20-36"><a id="__codelineno-20-36" name="__codelineno-20-36"></a>
</span><span id="__span-20-37"><a id="__codelineno-20-37" name="__codelineno-20-37"></a>            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="__span-20-38"><a id="__codelineno-20-38" name="__codelineno-20-38"></a>                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">horizon</span><span class="p">):</span>
</span><span id="__span-20-39"><a id="__codelineno-20-39" name="__codelineno-20-39"></a>                    <span class="n">act</span> <span class="o">=</span> <span class="n">actions_batch</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span>
</span><span id="__span-20-40"><a id="__codelineno-20-40" name="__codelineno-20-40"></a>                    <span class="n">next_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="p">(</span><span class="n">curr_z</span><span class="p">,</span> <span class="n">act</span><span class="p">)</span>
</span><span id="__span-20-41"><a id="__codelineno-20-41" name="__codelineno-20-41"></a>                    <span class="n">pred_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_decoder</span><span class="p">(</span><span class="n">next_z</span><span class="p">)</span>
</span><span id="__span-20-42"><a id="__codelineno-20-42" name="__codelineno-20-42"></a>                    <span class="n">dist</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">pred_pos</span> <span class="o">-</span> <span class="n">goal_pos</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-20-43"><a id="__codelineno-20-43" name="__codelineno-20-43"></a>
</span><span id="__span-20-44"><a id="__codelineno-20-44" name="__codelineno-20-44"></a>                    <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">horizon</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="__span-20-45"><a id="__codelineno-20-45" name="__codelineno-20-45"></a>                        <span class="n">cumulative_cost</span> <span class="o">+=</span> <span class="n">dist</span> <span class="o">*</span> <span class="mf">10.0</span>
</span><span id="__span-20-46"><a id="__codelineno-20-46" name="__codelineno-20-46"></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-20-47"><a id="__codelineno-20-47" name="__codelineno-20-47"></a>                        <span class="n">cumulative_cost</span> <span class="o">+=</span> <span class="n">dist</span>
</span><span id="__span-20-48"><a id="__codelineno-20-48" name="__codelineno-20-48"></a>                    <span class="n">curr_z</span> <span class="o">=</span> <span class="n">next_z</span>
</span><span id="__span-20-49"><a id="__codelineno-20-49" name="__codelineno-20-49"></a>
</span><span id="__span-20-50"><a id="__codelineno-20-50" name="__codelineno-20-50"></a>            <span class="n">elite_k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_samples</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
</span><span id="__span-20-51"><a id="__codelineno-20-51" name="__codelineno-20-51"></a>            <span class="n">elite_idxs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">cumulative_cost</span><span class="p">)[:</span><span class="n">elite_k</span><span class="p">]</span>
</span><span id="__span-20-52"><a id="__codelineno-20-52" name="__codelineno-20-52"></a>            <span class="n">elites</span> <span class="o">=</span> <span class="n">actions_batch</span><span class="p">[</span><span class="n">elite_idxs</span><span class="p">]</span>
</span><span id="__span-20-53"><a id="__codelineno-20-53" name="__codelineno-20-53"></a>
</span><span id="__span-20-54"><a id="__codelineno-20-54" name="__codelineno-20-54"></a>            <span class="n">mean</span> <span class="o">=</span> <span class="n">elites</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-20-55"><a id="__codelineno-20-55" name="__codelineno-20-55"></a>            <span class="n">std</span> <span class="o">=</span> <span class="n">elites</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.1</span>
</span><span id="__span-20-56"><a id="__codelineno-20-56" name="__codelineno-20-56"></a>
</span><span id="__span-20-57"><a id="__codelineno-20-57" name="__codelineno-20-57"></a>            <span class="n">current_best_cost</span> <span class="o">=</span> <span class="n">cumulative_cost</span><span class="p">[</span><span class="n">elite_idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="__span-20-58"><a id="__codelineno-20-58" name="__codelineno-20-58"></a>            <span class="k">if</span> <span class="n">current_best_cost</span> <span class="o">&lt;</span> <span class="n">best_cost</span><span class="p">:</span>
</span><span id="__span-20-59"><a id="__codelineno-20-59" name="__codelineno-20-59"></a>                <span class="n">best_cost</span> <span class="o">=</span> <span class="n">current_best_cost</span>
</span><span id="__span-20-60"><a id="__codelineno-20-60" name="__codelineno-20-60"></a>                <span class="n">best_action_seq</span> <span class="o">=</span> <span class="n">elites</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-20-61"><a id="__codelineno-20-61" name="__codelineno-20-61"></a>
</span><span id="__span-20-62"><a id="__codelineno-20-62" name="__codelineno-20-62"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  CEM Iter </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: Best Cost </span><span class="si">{</span><span class="n">current_best_cost</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-20-63"><a id="__codelineno-20-63" name="__codelineno-20-63"></a>
</span><span id="__span-20-64"><a id="__codelineno-20-64" name="__codelineno-20-64"></a>        <span class="k">return</span> <span class="n">best_action_seq</span><span class="p">,</span> <span class="n">best_cost</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="execution-the-demo-suite">Execution (The Demo Suite)</h3>
<p>To verify the system, we implement a simulation harness (simulate_rollout) that manually executes physics using the exact logic from the MicroWorld, and a demo runner that performs open-loop and closed-loop control.</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">demo.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1">  1</a></span>
<span class="normal"><a href="#__codelineno-21-2">  2</a></span>
<span class="normal"><a href="#__codelineno-21-3">  3</a></span>
<span class="normal"><a href="#__codelineno-21-4">  4</a></span>
<span class="normal"><a href="#__codelineno-21-5">  5</a></span>
<span class="normal"><a href="#__codelineno-21-6">  6</a></span>
<span class="normal"><a href="#__codelineno-21-7">  7</a></span>
<span class="normal"><a href="#__codelineno-21-8">  8</a></span>
<span class="normal"><a href="#__codelineno-21-9">  9</a></span>
<span class="normal"><a href="#__codelineno-21-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-21-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-21-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-21-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-21-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-21-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-21-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-21-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-21-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-21-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-21-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-21-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-21-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-21-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-21-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-21-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-21-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-21-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-21-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-21-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-21-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-21-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-21-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-21-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-21-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-21-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-21-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-21-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-21-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-21-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-21-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-21-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-21-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-21-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-21-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-21-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-21-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-21-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-21-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-21-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-21-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-21-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-21-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-21-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-21-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-21-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-21-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-21-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-21-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-21-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-21-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-21-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-21-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-21-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-21-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-21-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-21-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-21-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-21-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-21-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-21-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-21-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-21-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-21-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-21-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-21-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-21-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-21-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-21-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-21-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-21-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-21-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-21-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-21-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-21-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-21-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-21-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-21-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-21-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-21-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-21-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-21-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-21-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-21-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-21-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-21-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-21-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-21-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-21-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-21-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-21-100">100</a></span>
<span class="normal"><a href="#__codelineno-21-101">101</a></span>
<span class="normal"><a href="#__codelineno-21-102">102</a></span>
<span class="normal"><a href="#__codelineno-21-103">103</a></span>
<span class="normal"><a href="#__codelineno-21-104">104</a></span>
<span class="normal"><a href="#__codelineno-21-105">105</a></span>
<span class="normal"><a href="#__codelineno-21-106">106</a></span>
<span class="normal"><a href="#__codelineno-21-107">107</a></span>
<span class="normal"><a href="#__codelineno-21-108">108</a></span>
<span class="normal"><a href="#__codelineno-21-109">109</a></span>
<span class="normal"><a href="#__codelineno-21-110">110</a></span>
<span class="normal"><a href="#__codelineno-21-111">111</a></span>
<span class="normal"><a href="#__codelineno-21-112">112</a></span>
<span class="normal"><a href="#__codelineno-21-113">113</a></span>
<span class="normal"><a href="#__codelineno-21-114">114</a></span>
<span class="normal"><a href="#__codelineno-21-115">115</a></span>
<span class="normal"><a href="#__codelineno-21-116">116</a></span>
<span class="normal"><a href="#__codelineno-21-117">117</a></span>
<span class="normal"><a href="#__codelineno-21-118">118</a></span>
<span class="normal"><a href="#__codelineno-21-119">119</a></span>
<span class="normal"><a href="#__codelineno-21-120">120</a></span>
<span class="normal"><a href="#__codelineno-21-121">121</a></span>
<span class="normal"><a href="#__codelineno-21-122">122</a></span>
<span class="normal"><a href="#__codelineno-21-123">123</a></span>
<span class="normal"><a href="#__codelineno-21-124">124</a></span>
<span class="normal"><a href="#__codelineno-21-125">125</a></span>
<span class="normal"><a href="#__codelineno-21-126">126</a></span>
<span class="normal"><a href="#__codelineno-21-127">127</a></span>
<span class="normal"><a href="#__codelineno-21-128">128</a></span>
<span class="normal"><a href="#__codelineno-21-129">129</a></span>
<span class="normal"><a href="#__codelineno-21-130">130</a></span>
<span class="normal"><a href="#__codelineno-21-131">131</a></span>
<span class="normal"><a href="#__codelineno-21-132">132</a></span>
<span class="normal"><a href="#__codelineno-21-133">133</a></span>
<span class="normal"><a href="#__codelineno-21-134">134</a></span>
<span class="normal"><a href="#__codelineno-21-135">135</a></span>
<span class="normal"><a href="#__codelineno-21-136">136</a></span>
<span class="normal"><a href="#__codelineno-21-137">137</a></span>
<span class="normal"><a href="#__codelineno-21-138">138</a></span>
<span class="normal"><a href="#__codelineno-21-139">139</a></span>
<span class="normal"><a href="#__codelineno-21-140">140</a></span>
<span class="normal"><a href="#__codelineno-21-141">141</a></span>
<span class="normal"><a href="#__codelineno-21-142">142</a></span>
<span class="normal"><a href="#__codelineno-21-143">143</a></span>
<span class="normal"><a href="#__codelineno-21-144">144</a></span>
<span class="normal"><a href="#__codelineno-21-145">145</a></span>
<span class="normal"><a href="#__codelineno-21-146">146</a></span>
<span class="normal"><a href="#__codelineno-21-147">147</a></span>
<span class="normal"><a href="#__codelineno-21-148">148</a></span>
<span class="normal"><a href="#__codelineno-21-149">149</a></span>
<span class="normal"><a href="#__codelineno-21-150">150</a></span>
<span class="normal"><a href="#__codelineno-21-151">151</a></span>
<span class="normal"><a href="#__codelineno-21-152">152</a></span>
<span class="normal"><a href="#__codelineno-21-153">153</a></span>
<span class="normal"><a href="#__codelineno-21-154">154</a></span>
<span class="normal"><a href="#__codelineno-21-155">155</a></span>
<span class="normal"><a href="#__codelineno-21-156">156</a></span>
<span class="normal"><a href="#__codelineno-21-157">157</a></span>
<span class="normal"><a href="#__codelineno-21-158">158</a></span>
<span class="normal"><a href="#__codelineno-21-159">159</a></span>
<span class="normal"><a href="#__codelineno-21-160">160</a></span>
<span class="normal"><a href="#__codelineno-21-161">161</a></span>
<span class="normal"><a href="#__codelineno-21-162">162</a></span>
<span class="normal"><a href="#__codelineno-21-163">163</a></span>
<span class="normal"><a href="#__codelineno-21-164">164</a></span>
<span class="normal"><a href="#__codelineno-21-165">165</a></span>
<span class="normal"><a href="#__codelineno-21-166">166</a></span>
<span class="normal"><a href="#__codelineno-21-167">167</a></span>
<span class="normal"><a href="#__codelineno-21-168">168</a></span>
<span class="normal"><a href="#__codelineno-21-169">169</a></span>
<span class="normal"><a href="#__codelineno-21-170">170</a></span>
<span class="normal"><a href="#__codelineno-21-171">171</a></span>
<span class="normal"><a href="#__codelineno-21-172">172</a></span>
<span class="normal"><a href="#__codelineno-21-173">173</a></span>
<span class="normal"><a href="#__codelineno-21-174">174</a></span>
<span class="normal"><a href="#__codelineno-21-175">175</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">simulate_rollout</span><span class="p">(</span><span class="n">world_factory</span><span class="p">,</span> <span class="n">start_state_tuple</span><span class="p">,</span> <span class="n">action_sequence</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="sd">    Manually simulates physics using the exact logic from MicroWorldFactory.</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4"></a><span class="sd">    Returns: [Batch, Channel, Time, Height, Width] -&gt; [1, 1, T, 64, 64]</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6"></a>    <span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">start_state_tuple</span><span class="p">)</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7"></a>    <span class="n">actions</span> <span class="o">=</span> <span class="n">action_sequence</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8"></a>    <span class="n">horizon</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9"></a>
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10"></a>    <span class="n">frames</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11"></a>
</span><span id="__span-21-12"><a id="__codelineno-21-12" name="__codelineno-21-12"></a>    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">horizon</span><span class="p">):</span>
</span><span id="__span-21-13"><a id="__codelineno-21-13" name="__codelineno-21-13"></a>        <span class="c1"># Render</span>
</span><span id="__span-21-14"><a id="__codelineno-21-14" name="__codelineno-21-14"></a>        <span class="n">frame</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
</span><span id="__span-21-15"><a id="__codelineno-21-15" name="__codelineno-21-15"></a>
</span><span id="__span-21-16"><a id="__codelineno-21-16" name="__codelineno-21-16"></a>        <span class="n">r1</span><span class="p">,</span> <span class="n">c1</span> <span class="o">=</span> <span class="n">p1</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">int</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="__span-21-17"><a id="__codelineno-21-17" name="__codelineno-21-17"></a>        <span class="n">r1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="mi">64</span> <span class="o">-</span> <span class="mi">28</span><span class="p">))</span>
</span><span id="__span-21-18"><a id="__codelineno-21-18" name="__codelineno-21-18"></a>        <span class="n">c1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="mi">64</span> <span class="o">-</span> <span class="mi">28</span><span class="p">))</span>
</span><span id="__span-21-19"><a id="__codelineno-21-19" name="__codelineno-21-19"></a>        <span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">r1</span><span class="p">:</span><span class="n">r1</span><span class="o">+</span><span class="mi">28</span><span class="p">,</span> <span class="n">c1</span><span class="p">:</span><span class="n">c1</span><span class="o">+</span><span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">r1</span><span class="p">:</span><span class="n">r1</span><span class="o">+</span><span class="mi">28</span><span class="p">,</span> <span class="n">c1</span><span class="p">:</span><span class="n">c1</span><span class="o">+</span><span class="mi">28</span><span class="p">],</span> <span class="n">d1</span><span class="p">)</span>
</span><span id="__span-21-20"><a id="__codelineno-21-20" name="__codelineno-21-20"></a>
</span><span id="__span-21-21"><a id="__codelineno-21-21" name="__codelineno-21-21"></a>        <span class="n">r2</span><span class="p">,</span> <span class="n">c2</span> <span class="o">=</span> <span class="n">p2</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">int</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="__span-21-22"><a id="__codelineno-21-22" name="__codelineno-21-22"></a>        <span class="n">r2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="mi">64</span> <span class="o">-</span> <span class="mi">28</span><span class="p">))</span>
</span><span id="__span-21-23"><a id="__codelineno-21-23" name="__codelineno-21-23"></a>        <span class="n">c2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="mi">64</span> <span class="o">-</span> <span class="mi">28</span><span class="p">))</span>
</span><span id="__span-21-24"><a id="__codelineno-21-24" name="__codelineno-21-24"></a>        <span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">r2</span><span class="p">:</span><span class="n">r2</span><span class="o">+</span><span class="mi">28</span><span class="p">,</span> <span class="n">c2</span><span class="p">:</span><span class="n">c2</span><span class="o">+</span><span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">r2</span><span class="p">:</span><span class="n">r2</span><span class="o">+</span><span class="mi">28</span><span class="p">,</span> <span class="n">c2</span><span class="p">:</span><span class="n">c2</span><span class="o">+</span><span class="mi">28</span><span class="p">],</span> <span class="n">d2</span><span class="p">)</span>
</span><span id="__span-21-25"><a id="__codelineno-21-25" name="__codelineno-21-25"></a>
</span><span id="__span-21-26"><a id="__codelineno-21-26" name="__codelineno-21-26"></a>        <span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">frame</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">)</span>
</span><span id="__span-21-27"><a id="__codelineno-21-27" name="__codelineno-21-27"></a>
</span><span id="__span-21-28"><a id="__codelineno-21-28" name="__codelineno-21-28"></a>        <span class="c1"># Update Physics</span>
</span><span id="__span-21-29"><a id="__codelineno-21-29" name="__codelineno-21-29"></a>        <span class="n">act</span> <span class="o">=</span> <span class="n">actions</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
</span><span id="__span-21-30"><a id="__codelineno-21-30" name="__codelineno-21-30"></a>        <span class="n">v1</span> <span class="o">+=</span> <span class="n">act</span>
</span><span id="__span-21-31"><a id="__codelineno-21-31" name="__codelineno-21-31"></a>        <span class="n">v1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span>
</span><span id="__span-21-32"><a id="__codelineno-21-32" name="__codelineno-21-32"></a>
</span><span id="__span-21-33"><a id="__codelineno-21-33" name="__codelineno-21-33"></a>        <span class="n">p1</span> <span class="o">+=</span> <span class="n">v1</span>
</span><span id="__span-21-34"><a id="__codelineno-21-34" name="__codelineno-21-34"></a>        <span class="n">p2</span> <span class="o">+=</span> <span class="n">v2</span>
</span><span id="__span-21-35"><a id="__codelineno-21-35" name="__codelineno-21-35"></a>
</span><span id="__span-21-36"><a id="__codelineno-21-36" name="__codelineno-21-36"></a>        <span class="c1"># Bounce logic</span>
</span><span id="__span-21-37"><a id="__codelineno-21-37" name="__codelineno-21-37"></a>        <span class="k">if</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">64</span> <span class="o">-</span> <span class="mi">28</span><span class="p">):</span> <span class="n">v1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">-</span> <span class="mi">28</span><span class="p">)</span>
</span><span id="__span-21-38"><a id="__codelineno-21-38" name="__codelineno-21-38"></a>        <span class="k">if</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">64</span> <span class="o">-</span> <span class="mi">28</span><span class="p">):</span> <span class="n">v1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">-</span> <span class="mi">28</span><span class="p">)</span>
</span><span id="__span-21-39"><a id="__codelineno-21-39" name="__codelineno-21-39"></a>
</span><span id="__span-21-40"><a id="__codelineno-21-40" name="__codelineno-21-40"></a>        <span class="k">if</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">64</span> <span class="o">-</span> <span class="mi">28</span><span class="p">):</span> <span class="n">v2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">-</span> <span class="mi">28</span><span class="p">)</span>
</span><span id="__span-21-41"><a id="__codelineno-21-41" name="__codelineno-21-41"></a>        <span class="k">if</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">64</span> <span class="o">-</span> <span class="mi">28</span><span class="p">):</span> <span class="n">v2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">-</span> <span class="mi">28</span><span class="p">)</span>
</span><span id="__span-21-42"><a id="__codelineno-21-42" name="__codelineno-21-42"></a>
</span><span id="__span-21-43"><a id="__codelineno-21-43" name="__codelineno-21-43"></a>    <span class="c1"># FIXED: Return [1, 1, T, 64, 64]</span>
</span><span id="__span-21-44"><a id="__codelineno-21-44" name="__codelineno-21-44"></a>    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-21-45"><a id="__codelineno-21-45" name="__codelineno-21-45"></a>
</span><span id="__span-21-46"><a id="__codelineno-21-46" name="__codelineno-21-46"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_rollout_video</span><span class="p">(</span><span class="n">start_frame</span><span class="p">,</span> <span class="n">goal_frame</span><span class="p">,</span> <span class="n">planned_frames</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;rollout.mp4&quot;</span><span class="p">):</span>
</span><span id="__span-21-47"><a id="__codelineno-21-47" name="__codelineno-21-47"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-21-48"><a id="__codelineno-21-48" name="__codelineno-21-48"></a><span class="sd">    Generates a side-by-side video: Goal | Planned Execution</span>
</span><span id="__span-21-49"><a id="__codelineno-21-49" name="__codelineno-21-49"></a><span class="sd">    planned_frames shape: [1, 1, T, 64, 64]</span>
</span><span id="__span-21-50"><a id="__codelineno-21-50" name="__codelineno-21-50"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-21-51"><a id="__codelineno-21-51" name="__codelineno-21-51"></a>    <span class="n">frames</span> <span class="o">=</span> <span class="n">planned_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="c1"># [T, 64, 64]</span>
</span><span id="__span-21-52"><a id="__codelineno-21-52" name="__codelineno-21-52"></a>    <span class="n">goal_img</span> <span class="o">=</span> <span class="n">goal_frame</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="__span-21-53"><a id="__codelineno-21-53" name="__codelineno-21-53"></a>
</span><span id="__span-21-54"><a id="__codelineno-21-54" name="__codelineno-21-54"></a>    <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="__span-21-55"><a id="__codelineno-21-55" name="__codelineno-21-55"></a>
</span><span id="__span-21-56"><a id="__codelineno-21-56" name="__codelineno-21-56"></a>    <span class="n">im1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-21-57"><a id="__codelineno-21-57" name="__codelineno-21-57"></a>    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Planned Execution&quot;</span><span class="p">)</span>
</span><span id="__span-21-58"><a id="__codelineno-21-58" name="__codelineno-21-58"></a>    <span class="n">ax1</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="__span-21-59"><a id="__codelineno-21-59" name="__codelineno-21-59"></a>
</span><span id="__span-21-60"><a id="__codelineno-21-60" name="__codelineno-21-60"></a>    <span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">goal_img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-21-61"><a id="__codelineno-21-61" name="__codelineno-21-61"></a>    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Target Goal&quot;</span><span class="p">)</span>
</span><span id="__span-21-62"><a id="__codelineno-21-62" name="__codelineno-21-62"></a>    <span class="n">ax2</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="__span-21-63"><a id="__codelineno-21-63" name="__codelineno-21-63"></a>
</span><span id="__span-21-64"><a id="__codelineno-21-64" name="__codelineno-21-64"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="n">frame_idx</span><span class="p">):</span>
</span><span id="__span-21-65"><a id="__codelineno-21-65" name="__codelineno-21-65"></a>        <span class="n">im1</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="n">frames</span><span class="p">[</span><span class="n">frame_idx</span><span class="p">])</span>
</span><span id="__span-21-66"><a id="__codelineno-21-66" name="__codelineno-21-66"></a>        <span class="k">return</span> <span class="p">[</span><span class="n">im1</span><span class="p">]</span>
</span><span id="__span-21-67"><a id="__codelineno-21-67" name="__codelineno-21-67"></a>
</span><span id="__span-21-68"><a id="__codelineno-21-68" name="__codelineno-21-68"></a>    <span class="n">ani</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">),</span> <span class="n">blit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-21-69"><a id="__codelineno-21-69" name="__codelineno-21-69"></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-21-70"><a id="__codelineno-21-70" name="__codelineno-21-70"></a>        <span class="n">ani</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="s1">&#39;ffmpeg&#39;</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span id="__span-21-71"><a id="__codelineno-21-71" name="__codelineno-21-71"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Video saved to </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-21-72"><a id="__codelineno-21-72" name="__codelineno-21-72"></a>    <span class="k">except</span><span class="p">:</span>
</span><span id="__span-21-73"><a id="__codelineno-21-73" name="__codelineno-21-73"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FFmpeg not found. Skipping video save.&quot;</span><span class="p">)</span>
</span><span id="__span-21-74"><a id="__codelineno-21-74" name="__codelineno-21-74"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="__span-21-75"><a id="__codelineno-21-75" name="__codelineno-21-75"></a>
</span><span id="__span-21-76"><a id="__codelineno-21-76" name="__codelineno-21-76"></a><span class="k">def</span><span class="w"> </span><span class="nf">run_advanced_demo</span><span class="p">():</span>
</span><span id="__span-21-77"><a id="__codelineno-21-77" name="__codelineno-21-77"></a>    <span class="n">device</span> <span class="o">=</span> <span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span>
</span><span id="__span-21-78"><a id="__codelineno-21-78" name="__codelineno-21-78"></a>
</span><span id="__span-21-79"><a id="__codelineno-21-79" name="__codelineno-21-79"></a>    <span class="c1"># 1. Train Models</span>
</span><span id="__span-21-80"><a id="__codelineno-21-80" name="__codelineno-21-80"></a>    <span class="n">enc_student</span><span class="p">,</span> <span class="n">enc_teacher</span> <span class="o">=</span> <span class="n">train_world_model</span><span class="p">(</span><span class="n">epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-21-81"><a id="__codelineno-21-81" name="__codelineno-21-81"></a>    <span class="n">predictor</span><span class="p">,</span> <span class="n">pos_decoder</span> <span class="o">=</span> <span class="n">train_action_predictor</span><span class="p">(</span><span class="n">enc_teacher</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-21-82"><a id="__codelineno-21-82" name="__codelineno-21-82"></a>
</span><span id="__span-21-83"><a id="__codelineno-21-83" name="__codelineno-21-83"></a>    <span class="n">planner</span> <span class="o">=</span> <span class="n">AdvancedMPCPlanner</span><span class="p">(</span><span class="n">enc_teacher</span><span class="p">,</span> <span class="n">predictor</span><span class="p">,</span> <span class="n">pos_decoder</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
</span><span id="__span-21-84"><a id="__codelineno-21-84" name="__codelineno-21-84"></a>
</span><span id="__span-21-85"><a id="__codelineno-21-85" name="__codelineno-21-85"></a>    <span class="c1"># ---------------------------------------------------------</span>
</span><span id="__span-21-86"><a id="__codelineno-21-86" name="__codelineno-21-86"></a>    <span class="c1"># DEMO 1: Visualize Rollout</span>
</span><span id="__span-21-87"><a id="__codelineno-21-87" name="__codelineno-21-87"></a>    <span class="c1"># ---------------------------------------------------------</span>
</span><span id="__span-21-88"><a id="__codelineno-21-88" name="__codelineno-21-88"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
</span><span id="__span-21-89"><a id="__codelineno-21-89" name="__codelineno-21-89"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEMO 1: VISUALIZING ROLLOUT&quot;</span><span class="p">)</span>
</span><span id="__span-21-90"><a id="__codelineno-21-90" name="__codelineno-21-90"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
</span><span id="__span-21-91"><a id="__codelineno-21-91" name="__codelineno-21-91"></a>
</span><span id="__span-21-92"><a id="__codelineno-21-92" name="__codelineno-21-92"></a>    <span class="n">world</span> <span class="o">=</span> <span class="n">ControllableMicroWorld</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">seq_len</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="__span-21-93"><a id="__codelineno-21-93" name="__codelineno-21-93"></a>    <span class="n">idx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">world</span><span class="o">.</span><span class="n">num_atoms</span><span class="p">)</span>
</span><span id="__span-21-94"><a id="__codelineno-21-94" name="__codelineno-21-94"></a>    <span class="n">idx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">world</span><span class="o">.</span><span class="n">num_atoms</span><span class="p">)</span>
</span><span id="__span-21-95"><a id="__codelineno-21-95" name="__codelineno-21-95"></a>    <span class="n">digit1</span><span class="p">,</span> <span class="n">digit2</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">idx1</span><span class="p">],</span> <span class="n">world</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">idx2</span><span class="p">]</span>
</span><span id="__span-21-96"><a id="__codelineno-21-96" name="__codelineno-21-96"></a>    <span class="n">pos1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">64</span> <span class="o">-</span> <span class="mi">28</span><span class="p">)</span>
</span><span id="__span-21-97"><a id="__codelineno-21-97" name="__codelineno-21-97"></a>    <span class="n">pos2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">64</span> <span class="o">-</span> <span class="mi">28</span><span class="p">)</span>
</span><span id="__span-21-98"><a id="__codelineno-21-98" name="__codelineno-21-98"></a>    <span class="n">vel1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.0</span>
</span><span id="__span-21-99"><a id="__codelineno-21-99" name="__codelineno-21-99"></a>    <span class="n">vel2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.0</span>
</span><span id="__span-21-100"><a id="__codelineno-21-100" name="__codelineno-21-100"></a>
</span><span id="__span-21-101"><a id="__codelineno-21-101" name="__codelineno-21-101"></a>    <span class="n">start_tuple</span> <span class="o">=</span> <span class="p">(</span><span class="n">digit1</span><span class="p">,</span> <span class="n">pos1</span><span class="o">.</span><span class="n">clone</span><span class="p">(),</span> <span class="n">vel1</span><span class="o">.</span><span class="n">clone</span><span class="p">(),</span> <span class="n">digit2</span><span class="p">,</span> <span class="n">pos2</span><span class="o">.</span><span class="n">clone</span><span class="p">(),</span> <span class="n">vel2</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
</span><span id="__span-21-102"><a id="__codelineno-21-102" name="__codelineno-21-102"></a>
</span><span id="__span-21-103"><a id="__codelineno-21-103" name="__codelineno-21-103"></a>    <span class="c1"># FIXED: Create start frame manually. Shape [1, 1, 1, 64, 64]</span>
</span><span id="__span-21-104"><a id="__codelineno-21-104" name="__codelineno-21-104"></a>    <span class="n">start_frame_sim</span> <span class="o">=</span> <span class="n">simulate_rollout</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">start_tuple</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-21-105"><a id="__codelineno-21-105" name="__codelineno-21-105"></a>
</span><span id="__span-21-106"><a id="__codelineno-21-106" name="__codelineno-21-106"></a>    <span class="c1"># Generate a dummy goal</span>
</span><span id="__span-21-107"><a id="__codelineno-21-107" name="__codelineno-21-107"></a>    <span class="n">rand_actions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="__span-21-108"><a id="__codelineno-21-108" name="__codelineno-21-108"></a>    <span class="n">goal_seq</span> <span class="o">=</span> <span class="n">simulate_rollout</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">start_tuple</span><span class="p">,</span> <span class="n">rand_actions</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
</span><span id="__span-21-109"><a id="__codelineno-21-109" name="__codelineno-21-109"></a>
</span><span id="__span-21-110"><a id="__codelineno-21-110" name="__codelineno-21-110"></a>    <span class="c1"># FIXED: Slice to get last frame while keeping dims [1, 1, 1, 64, 64]</span>
</span><span id="__span-21-111"><a id="__codelineno-21-111" name="__codelineno-21-111"></a>    <span class="n">goal_frame</span> <span class="o">=</span> <span class="n">goal_seq</span><span class="p">[:,</span> <span class="p">:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-21-112"><a id="__codelineno-21-112" name="__codelineno-21-112"></a>
</span><span id="__span-21-113"><a id="__codelineno-21-113" name="__codelineno-21-113"></a>    <span class="c1"># Plan</span>
</span><span id="__span-21-114"><a id="__codelineno-21-114" name="__codelineno-21-114"></a>    <span class="n">best_actions</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">planner</span><span class="o">.</span><span class="n">plan_cem</span><span class="p">(</span><span class="n">start_frame_sim</span><span class="p">,</span> <span class="n">goal_frame</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="__span-21-115"><a id="__codelineno-21-115" name="__codelineno-21-115"></a>
</span><span id="__span-21-116"><a id="__codelineno-21-116" name="__codelineno-21-116"></a>    <span class="c1"># Execute Plan</span>
</span><span id="__span-21-117"><a id="__codelineno-21-117" name="__codelineno-21-117"></a>    <span class="n">predicted_rollout</span> <span class="o">=</span> <span class="n">simulate_rollout</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">start_tuple</span><span class="p">,</span> <span class="n">best_actions</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
</span><span id="__span-21-118"><a id="__codelineno-21-118" name="__codelineno-21-118"></a>
</span><span id="__span-21-119"><a id="__codelineno-21-119" name="__codelineno-21-119"></a>    <span class="c1"># Create Video</span>
</span><span id="__span-21-120"><a id="__codelineno-21-120" name="__codelineno-21-120"></a>    <span class="n">create_rollout_video</span><span class="p">(</span><span class="n">start_frame_sim</span><span class="p">,</span> <span class="n">goal_frame</span><span class="p">,</span> <span class="n">predicted_rollout</span><span class="p">,</span> <span class="s2">&quot;demo1_rollout.mp4&quot;</span><span class="p">)</span>
</span><span id="__span-21-121"><a id="__codelineno-21-121" name="__codelineno-21-121"></a>
</span><span id="__span-21-122"><a id="__codelineno-21-122" name="__codelineno-21-122"></a>    <span class="c1"># ---------------------------------------------------------</span>
</span><span id="__span-21-123"><a id="__codelineno-21-123" name="__codelineno-21-123"></a>    <span class="c1"># DEMO 2: Harder Goals (30 steps)</span>
</span><span id="__span-21-124"><a id="__codelineno-21-124" name="__codelineno-21-124"></a>    <span class="c1"># ---------------------------------------------------------</span>
</span><span id="__span-21-125"><a id="__codelineno-21-125" name="__codelineno-21-125"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
</span><span id="__span-21-126"><a id="__codelineno-21-126" name="__codelineno-21-126"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEMO 2: LONG HORIZON PLANNING (30 STEPS)&quot;</span><span class="p">)</span>
</span><span id="__span-21-127"><a id="__codelineno-21-127" name="__codelineno-21-127"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
</span><span id="__span-21-128"><a id="__codelineno-21-128" name="__codelineno-21-128"></a>
</span><span id="__span-21-129"><a id="__codelineno-21-129" name="__codelineno-21-129"></a>    <span class="n">long_actions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="__span-21-130"><a id="__codelineno-21-130" name="__codelineno-21-130"></a>    <span class="n">long_goal_seq</span> <span class="o">=</span> <span class="n">simulate_rollout</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">start_tuple</span><span class="p">,</span> <span class="n">long_actions</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
</span><span id="__span-21-131"><a id="__codelineno-21-131" name="__codelineno-21-131"></a>    <span class="n">long_goal_frame</span> <span class="o">=</span> <span class="n">long_goal_seq</span><span class="p">[:,</span> <span class="p">:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-21-132"><a id="__codelineno-21-132" name="__codelineno-21-132"></a>
</span><span id="__span-21-133"><a id="__codelineno-21-133" name="__codelineno-21-133"></a>    <span class="n">best_actions_long</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">planner</span><span class="o">.</span><span class="n">plan_cem</span><span class="p">(</span><span class="n">start_frame_sim</span><span class="p">,</span> <span class="n">long_goal_frame</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="__span-21-134"><a id="__codelineno-21-134" name="__codelineno-21-134"></a>
</span><span id="__span-21-135"><a id="__codelineno-21-135" name="__codelineno-21-135"></a>    <span class="n">long_rollout</span> <span class="o">=</span> <span class="n">simulate_rollout</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">start_tuple</span><span class="p">,</span> <span class="n">best_actions_long</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
</span><span id="__span-21-136"><a id="__codelineno-21-136" name="__codelineno-21-136"></a>    <span class="n">create_rollout_video</span><span class="p">(</span><span class="n">start_frame_sim</span><span class="p">,</span> <span class="n">long_goal_frame</span><span class="p">,</span> <span class="n">long_rollout</span><span class="p">,</span> <span class="s2">&quot;demo2_long_horizon.mp4&quot;</span><span class="p">)</span>
</span><span id="__span-21-137"><a id="__codelineno-21-137" name="__codelineno-21-137"></a>
</span><span id="__span-21-138"><a id="__codelineno-21-138" name="__codelineno-21-138"></a>    <span class="c1"># ---------------------------------------------------------</span>
</span><span id="__span-21-139"><a id="__codelineno-21-139" name="__codelineno-21-139"></a>    <span class="c1"># DEMO 3: Closed-Loop Control</span>
</span><span id="__span-21-140"><a id="__codelineno-21-140" name="__codelineno-21-140"></a>    <span class="c1"># ---------------------------------------------------------</span>
</span><span id="__span-21-141"><a id="__codelineno-21-141" name="__codelineno-21-141"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
</span><span id="__span-21-142"><a id="__codelineno-21-142" name="__codelineno-21-142"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEMO 3: CLOSED-LOOP CONTROL (Receding Horizon)&quot;</span><span class="p">)</span>
</span><span id="__span-21-143"><a id="__codelineno-21-143" name="__codelineno-21-143"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
</span><span id="__span-21-144"><a id="__codelineno-21-144" name="__codelineno-21-144"></a>
</span><span id="__span-21-145"><a id="__codelineno-21-145" name="__codelineno-21-145"></a>    <span class="n">current_tuple</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">start_tuple</span><span class="p">)</span>
</span><span id="__span-21-146"><a id="__codelineno-21-146" name="__codelineno-21-146"></a>    <span class="n">current_frame</span> <span class="o">=</span> <span class="n">start_frame_sim</span>
</span><span id="__span-21-147"><a id="__codelineno-21-147" name="__codelineno-21-147"></a>
</span><span id="__span-21-148"><a id="__codelineno-21-148" name="__codelineno-21-148"></a>    <span class="n">executed_frames</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-21-149"><a id="__codelineno-21-149" name="__codelineno-21-149"></a>
</span><span id="__span-21-150"><a id="__codelineno-21-150" name="__codelineno-21-150"></a>    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
</span><span id="__span-21-151"><a id="__codelineno-21-151" name="__codelineno-21-151"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Closed Loop Step </span><span class="si">{</span><span class="n">step</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/10&quot;</span><span class="p">)</span>
</span><span id="__span-21-152"><a id="__codelineno-21-152" name="__codelineno-21-152"></a>
</span><span id="__span-21-153"><a id="__codelineno-21-153" name="__codelineno-21-153"></a>        <span class="c1"># Plan for horizon 10</span>
</span><span id="__span-21-154"><a id="__codelineno-21-154" name="__codelineno-21-154"></a>        <span class="n">actions_plan</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">planner</span><span class="o">.</span><span class="n">plan_cem</span><span class="p">(</span><span class="n">current_frame</span><span class="p">,</span> <span class="n">goal_frame</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</span><span id="__span-21-155"><a id="__codelineno-21-155" name="__codelineno-21-155"></a>
</span><span id="__span-21-156"><a id="__codelineno-21-156" name="__codelineno-21-156"></a>        <span class="n">first_action</span> <span class="o">=</span> <span class="n">actions_plan</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__span-21-157"><a id="__codelineno-21-157" name="__codelineno-21-157"></a>
</span><span id="__span-21-158"><a id="__codelineno-21-158" name="__codelineno-21-158"></a>        <span class="c1"># Physics Step</span>
</span><span id="__span-21-159"><a id="__codelineno-21-159" name="__codelineno-21-159"></a>        <span class="n">next_seq</span> <span class="o">=</span> <span class="n">simulate_rollout</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">current_tuple</span><span class="p">,</span> <span class="n">first_action</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
</span><span id="__span-21-160"><a id="__codelineno-21-160" name="__codelineno-21-160"></a>        <span class="n">next_frame</span> <span class="o">=</span> <span class="n">next_seq</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="c1"># Shape [1, 1, 1, 64, 64]</span>
</span><span id="__span-21-161"><a id="__codelineno-21-161" name="__codelineno-21-161"></a>        <span class="n">executed_frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_frame</span><span class="p">)</span>
</span><span id="__span-21-162"><a id="__codelineno-21-162" name="__codelineno-21-162"></a>
</span><span id="__span-21-163"><a id="__codelineno-21-163" name="__codelineno-21-163"></a>        <span class="c1"># Update State Tuple</span>
</span><span id="__span-21-164"><a id="__codelineno-21-164" name="__codelineno-21-164"></a>        <span class="n">d1</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">current_tuple</span>
</span><span id="__span-21-165"><a id="__codelineno-21-165" name="__codelineno-21-165"></a>        <span class="n">v1</span> <span class="o">+=</span> <span class="n">first_action</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="__span-21-166"><a id="__codelineno-21-166" name="__codelineno-21-166"></a>        <span class="n">v1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span>
</span><span id="__span-21-167"><a id="__codelineno-21-167" name="__codelineno-21-167"></a>        <span class="n">p1</span> <span class="o">+=</span> <span class="n">v1</span>
</span><span id="__span-21-168"><a id="__codelineno-21-168" name="__codelineno-21-168"></a>        <span class="n">p2</span> <span class="o">+=</span> <span class="n">v2</span>
</span><span id="__span-21-169"><a id="__codelineno-21-169" name="__codelineno-21-169"></a>        <span class="n">current_tuple</span> <span class="o">=</span> <span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span>
</span><span id="__span-21-170"><a id="__codelineno-21-170" name="__codelineno-21-170"></a>        <span class="n">current_frame</span> <span class="o">=</span> <span class="n">next_frame</span>
</span><span id="__span-21-171"><a id="__codelineno-21-171" name="__codelineno-21-171"></a>
</span><span id="__span-21-172"><a id="__codelineno-21-172" name="__codelineno-21-172"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Closed-loop execution complete.&quot;</span><span class="p">)</span>
</span><span id="__span-21-173"><a id="__codelineno-21-173" name="__codelineno-21-173"></a>
</span><span id="__span-21-174"><a id="__codelineno-21-174" name="__codelineno-21-174"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</span><span id="__span-21-175"><a id="__codelineno-21-175" name="__codelineno-21-175"></a>    <span class="n">run_advanced_demo</span><span class="p">()</span>
</span></code></pre></div></td></tr></table></div>
<hr />
<h2 id="references">References</h2>
<ul>
<li>
<p><a id="ABB23"></a> <strong>[ABB+23]</strong> Mahmoud Assran, Johann Ball√©, Charles Blondel, J√∂rg Bornschein, Mathilde Caron, Rianne M√ºller, Mahmoud Assran, Sylvain Gelly, and Gabriel Synnaeve. <em>Self-supervised learning from images with a joint-embedding predictive architecture.</em> CVPR, 2023. <a href="https://openaccess.thecvf.com/content/CVPR2023/papers/Assran_Self-Supervised_Learning_From_Images_With_a_Joint-Embedding_Predictive_Architecture_CVPR_2023_paper.pdf">PDF Link</a> (Accessed: Jan 5, 2026).</p>
</li>
<li>
<p><a id="App25"></a> <strong>[App25]</strong> Apple Machine Learning Research. <em>Rethinking JEPA: Compute-efficient video SSL with frozen teachers.</em> 2025. <a href="https://machinelearning.apple.com/research/rethinking-jepa">Article Link</a> (Accessed: Jan 5, 2026).</p>
</li>
<li>
<p><a id="Ki25"></a> <strong>[Kƒ±25]</strong> ƒ∞lyurek Kƒ±lƒ±√ß. <em>Beyond next-token prediction: Yann LeCun‚Äôs JEPA and the quest for AI common sense ‚Äî where everything is an abstraction.</em> Medium, 2025. <a href="https://medium.com/@ilyurek/beyond-next-token-prediction-yann-lecuns-jepa-and-the-quest-for-ai-common-sense-where-92150bed9dfd">Article Link</a> (Accessed: Jan 5, 2026).</p>
</li>
<li>
<p><a id="LeC"></a> <strong>[LeC]</strong> Yann LeCun. <em>Energy-based learning.</em> <a href="https://lear.inrialpes.fr/SicilyWorkshop/fri%20am/EBM_lecun.pdf">PDF Link</a> (Accessed: Jan 5, 2026).</p>
</li>
<li>
<p><a id="LeC22"></a> <strong>[LeC22]</strong> Yann LeCun. <em>A path towards autonomous machine intelligence version 0.9.2.</em> OpenReview, 62(1):1‚Äì62, 2022.</p>
</li>
<li>
<p><a id="Let24"></a> <strong>[Let24]</strong> Malcolm Lett. <em>Critical review of LeCun‚Äôs introductory JEPA paper.</em> Medium, 2024. <a href="https://malcolmlett.medium.com/critical-review-of-lecuns-introductory-jepa-paper-fabe5783134e">Article Link</a> (Accessed: Jan 5, 2026).</p>
</li>
<li>
<p><a id="Mina"></a> <strong>[Mina]</strong> Emergent Mind. <em>Joint-embedding predictive architectures.</em> <a href="https://www.emergentmind.com/topics/joint-embedding-predictive-architectures-jepas-f59bf588-2819-44b5-9fa1-00dd8de73f20">Topic Link</a> (Accessed: Jan 5, 2026).</p>
</li>
<li>
<p><a id="Minb"></a> <strong>[Minb]</strong> Emergent Mind. <em>VICReg-based JEPA overview.</em> <a href="https://www.emergentmind.com/topics/vicreg-based-jepa">Topic Link</a> (Accessed: Jan 5, 2026).</p>
</li>
<li>
<p><a id="Red25a"></a> <strong>[Red25a]</strong> Reddit r/MachineLearning. <em>Why does BYOL/JEPA like models work? How does EMA prevent model collapse?</em> 2025. <a href="https://www.reddit.com/r/MachineLearning/comments/1mx4a6c/d_why_does_byoljepa_like_models_work_how_does_ema/">Thread Link</a> (Accessed: Jan 5, 2026).</p>
</li>
<li>
<p><a id="Red25b"></a> <strong>[Red25b]</strong> Reddit r/singularity. <em>Could someone explain what each of these architectures are that LeCun claims could lead to AGI?</em> 2025. <a href="https://www.reddit.com/r/singularity/comments/1ikpqyk/could_someone_explain_what_each_of_these/">Thread Link</a> (Accessed: Jan 5, 2026).</p>
</li>
<li>
<p><a id="Sha22"></a> <strong>[Sha22]</strong> Shaped. <em>Yann LeCun: A path towards autonomous machine intelligence.</em> 2022. <a href="https://www.shaped.ai/blog/yann-lecun-a-path-towards-autonomous-machine-intelligence">Blog Link</a> (Accessed: Jan 5, 2026).</p>
</li>
<li>
<p><a id="Und25"></a> <strong>[Und25]</strong> Cogni Down Under. <em>A new kind of AI is emerging and it‚Äôs better than LLMs?</em> Medium, Dec 2025. <a href="https://medium.com/@cognidownunder/a-new-kind-of-ai-is-emerging-and-its-better-than-llms-95d3d80b7427">Article Link</a> (Accessed: Jan 5, 2026).</p>
</li>
</ul>
<h1 id="appendix-mathematical-formalism-of-v-jepa-components">Appendix: Mathematical Formalism of V-JEPA Components</h1>
<p>This appendix details the mathematical operations underpinning the Video Joint Embedding Predictive
Architecture (V-JEPA). We decompose the model into four primary components: The Eye (Encoder), The
GPS (Positional Embedding), The Game (Masking Strategy), and The Brain (Predictor).</p>
<h2 id="the-eye-mathematics-of-3d-convolution">The Eye: Mathematics of 3D Convolution</h2>
<p>The "Eye" functions mathematically as a linear projection from the high-dimensional pixel space to a lower-dimensional feature space. We employ a 3D Convolutional Neural Network (CNN) operation to achieve this transformation.</p>
<h3 id="the-input-tensor-v">The Input Tensor (<span class="arithmatex">\(V\)</span>)</h3>
<p>The input video is represented as a 4D tensor (omitting the batch dimension for clarity):</p>
<div class="arithmatex">\[
V \in \mathbb{R}^{T \times H \times W}
\]</div>
<p>Where:</p>
<ul>
<li><span class="arithmatex">\(T=16\)</span> (Time frames)</li>
<li><span class="arithmatex">\(H=64, W=64\)</span> (Height and Width in pixels)</li>
<li>The value range is normalized: <span class="arithmatex">\(V_{t,y,x} \in [-1, 1]\)</span></li>
</ul>
<h3 id="the-transformation-the-kernel-k">The Transformation (The Kernel <span class="arithmatex">\(K\)</span>)</h3>
<p>The <code>Conv3d</code> layer learns a set of filters (weights). Assuming an embedding dimension of <span class="arithmatex">\(D=256\)</span>, we have 256 such filters. Each filter <span class="arithmatex">\(k\)</span> is a spatiotemporal cube of weights:</p>
<div class="arithmatex">\[
W_k \in \mathbb{R}^{2 \times 8 \times 8}
\]</div>
<p>This corresponds to a kernel size covering 2 frames in time and an <span class="arithmatex">\(8 \times 8\)</span> pixel patch in space.</p>
<h3 id="the-convolution-operation">The Convolution Operation</h3>
<p>To derive the scalar embedding value for a specific tubelet at grid position <span class="arithmatex">\((t, i, j)\)</span> and filter <span class="arithmatex">\(k\)</span>, we compute the dot product between the video pixels and the kernel weights, adding a bias term <span class="arithmatex">\(b_k\)</span>. This operation is formally a weighted sum:</p>
<div class="arithmatex">\[
E_{t,i,j}^{(k)} = \left( \sum_{\tau=0}^{1} \sum_{y=0}^{7} \sum_{x=0}^{7} V_{t+\tau, i+y, j+x} \cdot W_k(\tau, y, x) \right) + b_k
\]</div>
<h3 id="the-output-flattening">The Output (Flattening)</h3>
<p>Applying this operation across the entire video volume yields a grid of embedding vectors. We flatten this 3D grid into a sequence of vectors, referred to as "tokens":</p>
<div class="arithmatex">\[
Z = \{ z_1, z_2, \dots, z_{512} \}
\]</div>
<p>Where each token <span class="arithmatex">\(z_n \in \mathbb{R}^{256}\)</span>.</p>
<p><strong>Summary:</strong> The Eye transforms a spatiotemporal block of 128 pixels (<span class="arithmatex">\(2 \times 8 \times 8\)</span>) into a single vector of 256 scalars, effectively compressing local visual information (e.g., "contains a curved line moving right") into a latent representation.</p>
<h2 id="the-gps-mathematics-of-factorized-embeddings">The GPS: Mathematics of Factorized Embeddings</h2>
<p>Transformers process inputs as sets, not sequences; a set <span class="arithmatex">\(\{A, B, C\}\)</span> is mathematically identical to <span class="arithmatex">\(\{C, A, B\}\)</span>. Without explicit positional information (GPS), the model lacks the inductive bias to understand that Frame 1 temporally precedes Frame 2.</p>
<h3 id="the-problem">The Problem</h3>
<p>Standard 1D positional embeddings assign a unique vector <span class="arithmatex">\(P_n\)</span> to the <span class="arithmatex">\(n\)</span>-th token in a flattened sequence:</p>
<div class="arithmatex">\[
z_n' = z_n + P_n
\]</div>
<p>However, in a video volume, token <span class="arithmatex">\(n=10\)</span> might be spatially adjacent to token <span class="arithmatex">\(n=18\)</span> (in the row below) or temporally adjacent to token <span class="arithmatex">\(n=74\)</span> (in the next frame). A single scalar index <span class="arithmatex">\(n\)</span> destroys these 3D relational structures.</p>
<h3 id="the-solution-factorized-addition">The Solution (Factorized Addition)</h3>
<p>To preserve 3D structure, we define three distinct vector spaces for positional embeddings:</p>
<ul>
<li><strong>Time Space:</strong> <span class="arithmatex">\(E_T \in \mathbb{R}^{8 \times D}\)</span></li>
<li><strong>Height Space:</strong> <span class="arithmatex">\(E_H \in \mathbb{R}^{8 \times D}\)</span></li>
<li><strong>Width Space:</strong> <span class="arithmatex">\(E_W \in \mathbb{R}^{8 \times D}\)</span></li>
</ul>
<p>For a token located at grid coordinates <span class="arithmatex">\((t, h, w)\)</span>, the positional embedding vector <span class="arithmatex">\(P_{(t,h,w)}\)</span> is calculated as the element-wise sum of the three component vectors:</p>
<div class="arithmatex">\[
P_{(t,h,w)} = E_T[t] + E_H[h] + E_W[w]
\]</div>
<h3 id="why-summation">Why Summation?</h3>
<p>One might ask: <em>Why not concatenation?</em>
Concatenation would triple the dimension of the embedding vector (<span class="arithmatex">\(3 \times D\)</span>). By using summation, we maintain the vector dimension <span class="arithmatex">\(D\)</span>. In high-dimensional geometry, the sum of different random vectors results in a new vector that is nearly orthogonal (unique) to the original components. The neural network learns to "disentangle" this sum to recover the underlying spatiotemporal coordinates.</p>
<h2 id="the-game-mathematics-of-set-partitioning">The Game: Mathematics of Set Partitioning</h2>
<p>The masking strategy employed in JEPAs is fundamentally a set theory operation designed to create a self-supervised learning signal.</p>
<h3 id="the-universe-of-indices-u">The Universe of Indices (<span class="arithmatex">\(U\)</span>)</h3>
<p>We define <span class="arithmatex">\(U\)</span> as the set of indices for all tokens in the video:</p>
<div class="arithmatex">\[
U = \{ 1, 2, \dots, 512 \}
\]</div>
<h3 id="the-partition">The Partition</h3>
<p>We randomly partition <span class="arithmatex">\(U\)</span> into two disjoint subsets:</p>
<ol>
<li><strong>Context Set (<span class="arithmatex">\(I_{context}\)</span>):</strong> The indices of visible tokens.</li>
<li><strong>Target Set (<span class="arithmatex">\(I_{target}\)</span>):</strong> The indices of hidden tokens.</li>
</ol>
<p>This partition satisfies two conditions:</p>
<div class="arithmatex">\[
I_{context} \cap I_{target} = \emptyset
\]</div>
<div class="arithmatex">\[
I_{context} \cup I_{target} = U
\]</div>
<h3 id="the-masking-ratio-rho">The Masking Ratio (<span class="arithmatex">\(\rho\)</span>)</h3>
<p>The scalar <span class="arithmatex">\(\rho\)</span> defines the difficulty of the task:</p>
<div class="arithmatex">\[
|I_{target}| = \rho \cdot |U|
\]</div>
<p>For example, if <span class="arithmatex">\(\rho = 0.6\)</span>, we obscure 60% of the tokens.</p>
<h3 id="the-input-construction">The Input Construction</h3>
<p>We construct two distinct inputs for the neural networks based on this partition:</p>
<ul>
<li><strong>Encoder Input (<span class="arithmatex">\(X_{enc}\)</span>):</strong> Contains only the subset of vectors <span class="arithmatex">\(Z\)</span> belonging to the context.</li>
</ul>
<div class="arithmatex">\[
X_{enc} = \{ z_i + P_i \mid i \in I_{context} \}
\]</div>
<ul>
<li><strong>Predictor Input (<span class="arithmatex">\(X_{pred}\)</span>):</strong> A hybrid sequence containing real data from the context and learned placeholders for the targets.</li>
</ul>
<div class="arithmatex">\[
X_{pred} = X_{enc} \cup \{ M + P_j \mid j \in I_{target} \}
\]</div>
<p>Where <span class="arithmatex">\(M\)</span> is a learnable "Mask Token" vector.</p>
<p><strong>Crucial Math:</strong> The predictor receives the GPS coordinates (<span class="arithmatex">\(P_j\)</span>) of the missing parts but not their content (<span class="arithmatex">\(z_j\)</span>). This creates the query: "Given the surrounding context, what content belongs at coordinate <span class="arithmatex">\(P_j\)</span>?"</p>
<h2 id="the-brain-mathematics-of-self-attention">The Brain: Mathematics of Self-Attention</h2>
<p>The Predictor is a Transformer architecture. Its core mathematical operation is Scaled Dot-Product Attention, which allows the model to route information between tokens.</p>
<h3 id="the-input-matrix-x">The Input Matrix (<span class="arithmatex">\(X\)</span>)</h3>
<p>The input to a transformer block is a matrix of size <span class="arithmatex">\(N \times D\)</span>, where <span class="arithmatex">\(N\)</span> is the number of tokens and <span class="arithmatex">\(D\)</span> is the embedding dimension.</p>
<h3 id="projections">Projections</h3>
<p>We project the input <span class="arithmatex">\(X\)</span> into three distinct views using learnable weight matrices <span class="arithmatex">\(W_Q, W_K, W_V\)</span>:</p>
<ul>
<li><strong>Queries (<span class="arithmatex">\(Q = X W_Q\)</span>):</strong> Represents what the token is looking for.</li>
<li><strong>Keys (<span class="arithmatex">\(K = X W_K\)</span>):</strong> Represents what the token contains.</li>
<li><strong>Values (<span class="arithmatex">\(V = X W_V\)</span>):</strong> Represents the information the token will pass on.</li>
</ul>
<h3 id="the-attention-equation">The Attention Equation</h3>
<p>The attention mechanism computes a weighted sum of values based on the similarity between queries and keys:</p>
<div class="arithmatex">\[
\text{Attention}(Q, K, V) = \text{softmax}\left( \frac{QK^T}{\sqrt{D}} \right) V
\]</div>
<p><strong>Interpretation:</strong></p>
<ul>
<li><strong><span class="arithmatex">\(QK^T\)</span>:</strong> Calculates a similarity score (dot product) between every pair of tokens. For example, a "Mask Token at (Time 2, Pos A)" might generate a high dot product with a "Context Token at (Time 1, Pos A)" due to temporal proximity.</li>
<li><strong>Softmax:</strong> Normalizes these scores into probabilities that sum to 1. This forms the "attention map."</li>
<li><strong><span class="arithmatex">\(\times V\)</span>:</strong> Computes the weighted average of the Values. If a Mask Token attends 90% to a specific Context Token, it aggregates 90% of that context's information vector.</li>
</ul>
<h3 id="the-optimization-goal-the-loss-function">The Optimization Goal (The Loss Function)</h3>
<p>The objective is to minimize the distance between the Predictor's output for the masked regions (<span class="arithmatex">\(\hat{z}\)</span>) and the Teacher's output (<span class="arithmatex">\(y\)</span>). We typically utilize the L2 distance (Mean Squared Error):</p>
<div class="arithmatex">\[
\mathcal{L} = \sum_{j \in I_{target}} || \hat{z}_j - y_j ||^2
\]</div>
<p>Where:</p>
<ul>
<li><span class="arithmatex">\(\hat{z}_j\)</span>: The latent vector predicted by the student network (the brain).</li>
<li><span class="arithmatex">\(y_j\)</span>: The latent vector extracted by the teacher network (the eye) from the full, unmasked video.</li>
</ul>
<p><strong>Gradient Descent:</strong> We calculate the gradient of the Loss <span class="arithmatex">\(\mathcal{L}\)</span> with respect to the weights (<span class="arithmatex">\(\nabla W\)</span>) and update the weights to minimize this error.</p>
<h2 id="summary-of-the-flow">Summary of the Flow</h2>
<ol>
<li><strong>Eye:</strong> <span class="arithmatex">\(Pixels \xrightarrow{\text{Sum \&amp; Dot Product}} Embeddings\)</span></li>
<li><strong>GPS:</strong> <span class="arithmatex">\(Embeddings \xrightarrow{\text{Vector Addition}} Located\_Embeddings\)</span></li>
<li><strong>Game:</strong> <span class="arithmatex">\(Located\_Embeddings \xrightarrow{\text{Set Split}} Context \cup Targets\)</span></li>
<li><strong>Brain:</strong> <span class="arithmatex">\(Context \xrightarrow{\text{Matrix Multiplication (Attention)}} Predictions\)</span></li>
</ol>
            </div>
            
            <div class="flex justify-between mt-12 font-mono text-sm font-bold tracking-widest">
                
                
            </div>
        </article>

    </main>

    <footer class="border-t border-white/10 mt-12 py-12 bg-black/80 backdrop-blur">
        <div class="container mx-auto px-6 text-center">
            <p class="font-mono text-gray-600 text-xs tracking-widest">
                ¬© 2026 WORLD_MODELS-JOINT-EMBEDDING PREDICTIVE ARCHITECTURES (JEPA) // Muhammad Haris Khan
            </p>
        </div>
    </footer>

    
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    
    <script src="assets/js/three-bg.js"></script>
    
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    
    <script src="assets/js/mathjax-config.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <script src="https://unpkg.com/mermaid@10/dist/mermaid.min.js"></script>
    
    <script src="assets/js/mermaid-init.js"></script>
    
    <script src="search/main.js"></script>
    
</body>
</html>